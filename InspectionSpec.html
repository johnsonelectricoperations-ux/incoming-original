<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ê²€ì‚¬ê·œê²© ë“±ë¡/ìˆ˜ì • - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .company-name {
      color: #ff6b35;
      font-family: Arial, sans-serif;
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 8px;
      letter-spacing: 0.5px;
    }

    .header-title h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }

    .header-title p {
      font-size: 14px;
      opacity: 0.9;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }

    .btn-outline:hover {
      background: white;
      color: #667eea;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }

    .nav-menu {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }

    .nav-btn {
      padding: 12px 24px;
      background: #f0f4ff;
      color: #667eea;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .nav-btn:hover {
      background: #667eea;
      color: white;
    }

    .nav-btn.active {
      background: #667eea;
      color: white;
    }

    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    .btn-primary {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    thead {
      background-color: #f8f9fa;
    }

    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      font-size: 14px;
    }

    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }

    tr:hover {
      background-color: #f9f9f9;
    }

    .btn-sm {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 6px;
      border: none;
      cursor: pointer;
      margin-right: 5px;
      transition: all 0.2s;
    }

    .btn-edit {
      background: #ffc107;
      color: white;
    }

    .btn-edit:hover {
      background: #ffb300;
    }

    .btn-delete {
      background: #f44336;
      color: white;
    }

    .btn-delete:hover {
      background: #d32f2f;
    }

    /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0,0,0,0.5);
    }

    .modal-content {
      background-color: white;
      margin: 50px auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }

    .modal-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 25px;
      border-radius: 12px 12px 0 0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-title {
      font-size: 20px;
      font-weight: 600;
    }

    .close {
      color: white;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
      transition: all 0.2s;
    }

    .close:hover {
      transform: scale(1.1);
    }

    .modal-body {
      padding: 25px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
    }

    .inspection-items-table {
      margin-top: 15px;
      width: 100%;
    }

    .inspection-items-table th,
    .inspection-items-table td {
      padding: 8px;
      font-size: 13px;
    }

    .inspection-items-table input {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
    }

    .btn-add-row {
      background: #4caf50;
      color: white;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 10px;
    }

    .btn-add-row:hover {
      background: #45a049;
    }

    .btn-remove-row {
      background: #f44336;
      color: white;
      padding: 4px 8px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }

    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid #e0e0e0;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    .btn-cancel {
      background: #6c757d;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-cancel:hover {
      background: #5a6268;
    }

    .btn-save {
      background: #667eea;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }

    .btn-save:hover {
      background: #5568d3;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .empty-icon {
      font-size: 64px;
      margin-bottom: 20px;
    }

    /* TM-NO ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
    .autocomplete-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-top: 4px;
      display: none;
    }

    .autocomplete-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .autocomplete-item:hover {
      background-color: #f0f4ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-tmno {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 4px;
    }

    .autocomplete-product {
      font-size: 13px;
      color: #666;
    }

    .autocomplete-company {
      font-size: 12px;
      color: #999;
      margin-top: 2px;
    }

    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        margin: 20px auto;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <div class="company-name">Johnson Electric Operations</div>
        <h1>í˜‘ë ¥ì‚¬ ìˆ˜ì…ê²€ì‚¬ ê´€ë¦¬</h1>
        <p id="userInfo">ë¡œë”© ì¤‘...</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>

  <div class="container">
    <?!= include('Navigation') ?>

    <div class="section">
      <div class="section-header">
        <h2 class="section-title">ê²€ì‚¬ ê·œê²© ê´€ë¦¬</h2>
        <button class="btn btn-primary" onclick="showAddModal()">â• ìƒˆ ê·œê²© ì¶”ê°€</button>
      </div>

      <!-- ê²€ìƒ‰ í•„í„° -->
      <div class="search-bar" style="display: flex; gap: 10px; margin-bottom: 20px; align-items: flex-end;">
        <div style="flex: 1;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì—…ì²´ëª…</label>
          <select id="searchSpecCompany" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            <option value="">ì „ì²´</option>
          </select>
        </div>
        <div style="flex: 1;">
          <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">TM-NO</label>
          <input type="text" id="searchSpecTmNo" placeholder="TM-NO ê²€ìƒ‰" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>
        <button class="btn btn-primary" onclick="searchSpecs()" style="padding: 10px 20px;">ğŸ” ê²€ìƒ‰</button>
        <button class="btn" onclick="clearSpecSearch()" style="padding: 10px 20px; background: #6c757d; color: white;">â†» ì´ˆê¸°í™”</button>
      </div>

      <div id="specsContainer">
        <div class="empty-state">
          <div class="empty-icon">ğŸ“­</div>
          <p>ë“±ë¡ëœ ê²€ì‚¬ ê·œê²©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
        </div>
      </div>
    </div>
  </div>

  <!-- ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="specModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="modalTitle">ê²€ì‚¬ ê·œê²© ì¶”ê°€</h3>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>

      <div class="modal-body">
        <div class="form-group" style="position: relative;">
          <label class="form-label">TM-NO</label>
          <input type="text" class="form-control" id="specTmNo" placeholder="TM-NOë¥¼ ì…ë ¥í•˜ì„¸ìš”" autocomplete="off">
          <div id="specTmNoAutocomplete" class="autocomplete-results"></div>
        </div>

        <div class="form-group">
          <label class="form-label">ì œí’ˆëª…</label>
          <input type="text" class="form-control" id="specProductName" placeholder="ì œí’ˆëª…ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤" readonly style="background-color: #f5f5f5;">
        </div>

        <div class="form-group">
          <label class="form-label">ì—…ì²´ëª…</label>
          <input type="text" class="form-control" id="specCompanyName" placeholder="ì—…ì²´ëª…ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤" readonly style="background-color: #f5f5f5;">
        </div>

        <div class="form-group">
          <label class="form-label">ê²€ì‚¬ê¸°ì¤€ì„œ ì—…ë¡œë“œ</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="specFileInput" accept=".pdf,.xlsx,.xls,.doc,.docx,.jpg,.jpeg,.png" style="flex: 1;">
            <span id="specFileName" style="color: #666; font-size: 13px;"></span>
          </div>
          <p style="font-size: 12px; color: #999; margin-top: 5px;">PDF, Excel, Word, ì´ë¯¸ì§€ íŒŒì¼ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 20MB)</p>
        </div>

        <div class="form-group">
          <label class="form-label">ê²€ì‚¬ í•­ëª©</label>
          <button class="btn-add-row" onclick="addInspectionRow()">â• ê²€ì‚¬í•­ëª© ì¶”ê°€</button>
          <table class="inspection-items-table">
            <thead>
              <tr>
                <th style="width: 20%;">ê²€ì‚¬í•­ëª©</th>
                <th style="width: 15%;">ì¸¡ì •ë°©ë²•</th>
                <th style="width: 15%;">ê·œê²©í•˜í•œ</th>
                <th style="width: 15%;">ê·œê²©ìƒí•œ</th>
                <th style="width: 15%;">ì‹œë£Œìˆ˜</th>
                <th style="width: 10%;">ì‚­ì œ</th>
              </tr>
            </thead>
            <tbody id="inspectionItemsBody">
              <!-- ê²€ì‚¬í•­ëª© í–‰ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </tbody>
          </table>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
        <button class="btn-save" onclick="saveSpecs()">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ===== í† í° ê´€ë¦¬ =====
    let sessionToken = null;
    let currentUser = null;
    let editingTmNo = null;

    function initToken() {
      const serverToken = '<?!= token ?>';
      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        sessionToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
      } else {
        sessionToken = sessionStorage.getItem('sessionToken');
      }

      if (!sessionToken) {
        redirectToLogin();
      }
      return sessionToken;
    }

    // ì•ˆì „í•œ í˜ì´ì§€ ì´ë™ (iframe ìƒŒë“œë°•ìŠ¤ í˜¸í™˜)
    // ì—¬ëŸ¬ ë°©ë²•ì„ í´ë°±ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ìƒŒë“œë°•ìŠ¤ ì œì•½ ìš°íšŒ
    function safeNavigate(url, params) {
      // Query string ìƒì„±
      let fullUrl = url;
      if (params) {
        const queryString = Object.keys(params)
          .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
          .join('&');
        fullUrl = url + '?' + queryString;
      }

      // ë°©ë²• 1: window.top.location.href ì‹œë„
      try {
        window.top.location.href = fullUrl;
        return;
      } catch (e) {
        console.warn('window.top.location.href ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 2: window.location.replace ì‹œë„
      try {
        window.location.replace(fullUrl);
        return;
      } catch (e) {
        console.warn('window.location.replace ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 3: meta refresh íƒœê·¸
      try {
        const meta = document.createElement('meta');
        meta.httpEquiv = 'refresh';
        meta.content = '0; url=' + fullUrl;
        document.head.appendChild(meta);
        console.log('meta refresh íƒœê·¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
      } catch (e) {
        console.error('ëª¨ë“  ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ë²• ì‹¤íŒ¨:', e.message);
        alert('í˜ì´ì§€ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      }
    }

    function redirectToLogin() {
      sessionStorage.removeItem('sessionToken');
      safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
    }

    window.onload = function() {
      initToken();
      loadUserInfo();
      loadCompanyList();
      showInitialMessage();
    };

    // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function initNavigation(currentPage, userRole) {
      const navButtons = {
        'dashboard': 'navDashboard',
        'entry': 'navEntry',
        'history': 'navHistory',
        'certificate': 'navCertificate',
        'inspection': 'navInspection'
      };

      if (navButtons[currentPage]) {
        const btn = document.getElementById(navButtons[currentPage]);
        if (btn) {
          btn.classList.add('active');
        }
      }

      if (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') {
        const inspectionBtn = document.getElementById('navInspection');
        if (inspectionBtn) {
          inspectionBtn.style.display = 'inline-block';
        }
      }

      // Item ë“±ë¡ ë²„íŠ¼ì€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í‘œì‹œ
      const itemBtn = document.getElementById('navItem');
      if (itemBtn) {
        itemBtn.style.display = (currentPage === 'dashboard') ? 'inline-block' : 'none';
      }

      // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionResultBtn = document.getElementById('navInspectionResult');
      if (inspectionResultBtn) {
        inspectionResultBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // ê²€ì‚¬ê²°ê³¼ì´ë ¥ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionHistoryBtn = document.getElementById('navInspectionHistory');
      if (inspectionHistoryBtn) {
        inspectionHistoryBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // JEOëŠ” ì„±ì ì„œì…ë ¥, ì´ë ¥ê´€ë¦¬, í™•ì¸ì¦ì¶œë ¥ ë²„íŠ¼ ìˆ¨ê¹€
      const entryBtn = document.getElementById('navEntry');
      if (entryBtn) {
        entryBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const historyBtn = document.getElementById('navHistory');
      if (historyBtn) {
        historyBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const certificateBtn = document.getElementById('navCertificate');
      if (certificateBtn) {
        certificateBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      // ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
      const usersBtn = document.getElementById('navUsers');
      if (usersBtn) {
        usersBtn.style.display = (userRole === 'ê´€ë¦¬ì') ? 'inline-block' : 'none';
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í‘œì‹œ (ë¶€ë“œëŸ¬ìš´ fade-in íš¨ê³¼)
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.style.opacity = '1';
      }
    }

    // Item í´ë¦­ í•¸ë“¤ëŸ¬
    function handleItemClick() {
      goToPage('dashboard');
    }

    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            currentUser = response.user;
            document.getElementById('userInfo').textContent =
              `${currentUser.companyName} | ${currentUser.name} (${currentUser.role})`;

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initNavigation('inspection', currentUser.role);
          } else {
            redirectToLogin();
          }
        })
        .getCurrentUserByToken(sessionToken);
    }

    // ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ
    function loadCompanyList() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('searchSpecCompany');
            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì²« ë²ˆì§¸ "ì „ì²´" ì˜µì…˜ ì œì™¸)
            while (select.options.length > 1) {
              select.remove(1);
            }
            // ì—…ì²´ëª… ì˜µì…˜ ì¶”ê°€
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getCompanyList(sessionToken);
    }

    // ê²€ì‚¬ ê·œê²© ëª©ë¡ ë¡œë“œ
    function loadSpecs(filters) {
      const options = filters || {};
      google.script.run
        .withSuccessHandler(displaySpecs)
        .withFailureHandler(function(error) {
          console.error('ê·œê²© ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getInspectionSpecs(sessionToken, options);
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    function searchSpecs() {
      const companyName = document.getElementById('searchSpecCompany').value.trim();
      const tmNo = document.getElementById('searchSpecTmNo').value.trim();

      const filters = {};
      if (companyName) filters.companyName = companyName;
      if (tmNo) filters.tmNo = tmNo;

      loadSpecs(filters);
    }

    // ê²€ìƒ‰ ì´ˆê¸°í™”
    function clearSpecSearch() {
      document.getElementById('searchSpecCompany').value = '';
      document.getElementById('searchSpecTmNo').value = '';
      loadSpecs();
    }

    // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    function showInitialMessage() {
      const container = document.getElementById('specsContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-icon">ğŸ”</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
          <p style="font-size: 14px;">ì—…ì²´ëª…, TM-NOë¡œ ê²€ìƒ‰í•˜ê±°ë‚˜, ì¡°ê±´ ì—†ì´ ê²€ìƒ‰í•˜ë©´ ì „ì²´ ê·œê²©ì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
        </div>
      `;
    }

    // ê·œê²© ëª©ë¡ í‘œì‹œ
    function displaySpecs(response) {
      const container = document.getElementById('specsContainer');

      if (!response.success || response.data.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ê²€ì‚¬ ê·œê²©ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      // TM-NOë³„ë¡œ ê·¸ë£¹í™”
      const grouped = {};
      response.data.forEach(function(spec) {
        const key = `${spec.tmNo}_${spec.productName}_${spec.companyName}`;
        if (!grouped[key]) {
          grouped[key] = {
            tmNo: spec.tmNo,
            productName: spec.productName,
            companyName: spec.companyName,
            items: []
          };
        }
        grouped[key].items.push(spec);
      });

      let html = '<table><thead><tr><th>TM-NO</th><th>ì œí’ˆëª…</th><th>ì—…ì²´ëª…</th><th>ê²€ì‚¬í•­ëª© ìˆ˜</th><th>ê²€ì‚¬ê¸°ì¤€ì„œ</th><th>ì‘ì—…</th></tr></thead><tbody>';

      Object.keys(grouped).forEach(function(key) {
        const group = grouped[key];
        const hasStandard = group.items[0].inspectionStandardUrl && group.items[0].inspectionStandardUrl.trim() !== '';

        html += `
          <tr>
            <td>${group.tmNo}</td>
            <td>${group.productName}</td>
            <td>${group.companyName}</td>
            <td>${group.items.length}ê°œ</td>
            <td>`;

        if (hasStandard) {
          html += `<a href="${group.items[0].inspectionStandardUrl}" target="_blank" class="btn-sm btn-edit" style="background: #2196f3;">ğŸ“„ ë³´ê¸°</a>`;
        } else {
          html += '-';
        }

        html += `</td>
            <td>
              <button class="btn-sm btn-edit" onclick='editSpecs("${group.tmNo}", "${group.productName}", "${group.companyName}")'>âœï¸ ìˆ˜ì •</button>
              <button class="btn-sm btn-delete" onclick='deleteSpecs("${group.tmNo}", "${group.productName}", "${group.companyName}")'>ğŸ—‘ï¸ ì‚­ì œ</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddModal() {
      editingTmNo = null;
      document.getElementById('modalTitle').textContent = 'ê²€ì‚¬ ê·œê²© ì¶”ê°€';
      document.getElementById('specTmNo').value = '';
      document.getElementById('specTmNo').readOnly = false;
      document.getElementById('specProductName').value = '';
      document.getElementById('specProductName').readOnly = true;
      document.getElementById('specCompanyName').value = '';
      document.getElementById('specCompanyName').readOnly = true;

      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('specFileInput').value = '';
      document.getElementById('specFileName').textContent = '';

      // ê²€ì‚¬í•­ëª© í…Œì´ë¸” ì´ˆê¸°í™”
      document.getElementById('inspectionItemsBody').innerHTML = '';
      addInspectionRow();

      // TM-NO ìë™ì™„ì„± ì„¤ì •
      setupTmNoAutocomplete();

      document.getElementById('specModal').style.display = 'block';
    }

    // TM-NO ìë™ì™„ì„± ì„¤ì •
    function setupTmNoAutocomplete() {
      const tmNoInput = document.getElementById('specTmNo');
      const autocompleteDiv = document.getElementById('specTmNoAutocomplete');
      const productNameInput = document.getElementById('specProductName');
      const companyNameInput = document.getElementById('specCompanyName');
      let searchTimeout;

      // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°ë¥¼ ìœ„í•´ ìƒˆë¡œìš´ ìš”ì†Œë¡œ êµì²´
      const newTmNoInput = tmNoInput.cloneNode(true);
      tmNoInput.parentNode.replaceChild(newTmNoInput, tmNoInput);

      // TM-NO ì…ë ¥ ì‹œ ìë™ì™„ì„±
      newTmNoInput.addEventListener('input', function(e) {
        const searchText = e.target.value.trim();

        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìë™ì™„ì„± ìˆ¨ê¹€
        if (searchText.length === 0) {
          autocompleteDiv.style.display = 'none';
          productNameInput.value = '';
          companyNameInput.value = '';
          return;
        }

        // ë””ë°”ìš´ì‹± (300ms ëŒ€ê¸°)
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          // ItemList ì‹œíŠ¸ì—ì„œ TM-NO ê²€ìƒ‰
          google.script.run
            .withSuccessHandler(function(response) {
              if (response.success && response.items && response.items.length > 0) {
                displayAutocompleteResults(response.items);
              } else {
                autocompleteDiv.style.display = 'none';
              }
            })
            .withFailureHandler(function(error) {
              console.error('TM-NO ê²€ìƒ‰ ì‹¤íŒ¨:', error);
              autocompleteDiv.style.display = 'none';
            })
            .searchTmNo(sessionToken, searchText);
        }, 300);
      });

      // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¹€
      document.addEventListener('click', function(e) {
        if (e.target !== newTmNoInput && !autocompleteDiv.contains(e.target)) {
          autocompleteDiv.style.display = 'none';
        }
      });
    }

    // ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
    function displayAutocompleteResults(items) {
      const autocompleteDiv = document.getElementById('specTmNoAutocomplete');
      const tmNoInput = document.getElementById('specTmNo');
      const productNameInput = document.getElementById('specProductName');
      const companyNameInput = document.getElementById('specCompanyName');

      autocompleteDiv.innerHTML = '';

      items.forEach(function(item) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'autocomplete-item';
        itemDiv.innerHTML = `
          <div class="autocomplete-tmno">${item.tmNo}</div>
          <div class="autocomplete-product">${item.productName} <span style="color: #666; font-size: 0.9em;">(${item.companyName})</span></div>
        `;

        itemDiv.addEventListener('click', function() {
          // TM-NO, ì œí’ˆëª…, ì—…ì²´ëª… ìë™ ì…ë ¥
          tmNoInput.value = item.tmNo;
          productNameInput.value = item.productName;
          companyNameInput.value = item.companyName;
          autocompleteDiv.style.display = 'none';
        });

        autocompleteDiv.appendChild(itemDiv);
      });

      autocompleteDiv.style.display = 'block';
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì¶”ê°€
    function addInspectionRow() {
      const tbody = document.getElementById('inspectionItemsBody');
      const row = document.createElement('tr');
      row.innerHTML = `
        <td><input type="text" class="inspection-item" placeholder="ê²€ì‚¬í•­ëª©"></td>
        <td><input type="text" class="measurement-method" placeholder="ì¸¡ì •ë°©ë²•"></td>
        <td><input type="text" class="lower-limit" placeholder="í•˜í•œê°’"></td>
        <td><input type="text" class="upper-limit" placeholder="ìƒí•œê°’"></td>
        <td><input type="text" class="sample-size" placeholder="ì‹œë£Œìˆ˜"></td>
        <td><button class="btn-remove-row" onclick="removeInspectionRow(this)">âŒ</button></td>
      `;
      tbody.appendChild(row);
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì‚­ì œ
    function removeInspectionRow(btn) {
      const tbody = document.getElementById('inspectionItemsBody');
      if (tbody.rows.length > 1) {
        btn.closest('tr').remove();
      } else {
        alert('ìµœì†Œ 1ê°œì˜ ê²€ì‚¬í•­ëª©ì´ í•„ìš”í•©ë‹ˆë‹¤.');
      }
    }

    // ê·œê²© ì €ì¥
    function saveSpecs() {
      const tmNo = document.getElementById('specTmNo').value.trim();
      const productName = document.getElementById('specProductName').value.trim();
      const companyName = document.getElementById('specCompanyName').value.trim();

      if (!tmNo || !productName || !companyName) {
        alert('TM-NO, ì œí’ˆëª…, ì—…ì²´ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      const rows = document.querySelectorAll('#inspectionItemsBody tr');
      const specs = [];

      try {
        rows.forEach(function(row) {
        const inspectionItem = row.querySelector('.inspection-item').value.trim();
        const measurementMethod = row.querySelector('.measurement-method').value.trim();
        const lowerLimit = row.querySelector('.lower-limit').value.trim();
        const upperLimit = row.querySelector('.upper-limit').value.trim();
        const sampleSize = row.querySelector('.sample-size').value.trim();

        if (inspectionItem) {
          // ì¸¡ì •ë°©ë²•ê³¼ ì‹œë£Œìˆ˜ëŠ” í•„ìˆ˜ ì…ë ¥ ì‚¬í•­
          if (!measurementMethod) {
            alert('ê²€ì‚¬í•­ëª© "' + inspectionItem + '"ì˜ ì¸¡ì •ë°©ë²•ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            throw new Error('ì¸¡ì •ë°©ë²• ë¯¸ì…ë ¥');
          }
          if (!sampleSize) {
            alert('ê²€ì‚¬í•­ëª© "' + inspectionItem + '"ì˜ ì‹œë£Œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            throw new Error('ì‹œë£Œìˆ˜ ë¯¸ì…ë ¥');
          }

          specs.push({
            tmNo: tmNo,
            productName: productName,
            companyName: companyName,
            inspectionItem: inspectionItem,
            measurementMethod: measurementMethod,
            lowerLimit: lowerLimit,
            upperLimit: upperLimit,
            sampleSize: sampleSize
          });
        }
      });
      } catch (error) {
        // validation ì—ëŸ¬ ë°œìƒ ì‹œ ì¢…ë£Œ (ì´ë¯¸ alert ë©”ì‹œì§€ í‘œì‹œë¨)
        return;
      }

      if (specs.length === 0) {
        alert('ìµœì†Œ 1ê°œì˜ ê²€ì‚¬í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }

      // ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
      const fileInput = document.getElementById('specFileInput');
      const file = fileInput.files[0];

      if (file) {
        // íŒŒì¼ì´ ì„ íƒëœ ê²½ìš°, ë¨¼ì € ì—…ë¡œë“œ
        uploadInspectionStandardFile(file, companyName, tmNo, function(fileUrl) {
          // ì—…ë¡œë“œ ì„±ê³µ í›„ ê° specì— URL ì¶”ê°€
          specs.forEach(function(spec) {
            spec.inspectionStandardUrl = fileUrl;
          });
          saveSpecsToServer(specs, tmNo, companyName);
        });
      } else {
        // íŒŒì¼ì´ ì—†ëŠ” ê²½ìš° ë°”ë¡œ ì €ì¥ (ê¸°ì¡´ URL ìœ ì§€ ë˜ëŠ” ë¹ˆ ê°’)
        saveSpecsToServer(specs, tmNo, companyName);
      }
    }

    // ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì—…ë¡œë“œ
    function uploadInspectionStandardFile(file, companyName, tmNo, callback) {
      // íŒŒì¼ í¬ê¸° ì²´í¬ (20MB)
      const maxSize = 20 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 20MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const bytes = e.target.result.split(',')[1]; // Base64 ë°ì´í„° ì¶”ì¶œ

        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              callback(response.fileUrl);
            } else {
              alert(response.message || 'íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .uploadInspectionStandardFile(sessionToken, {
            fileName: file.name,
            mimeType: file.type,
            bytes: bytes,
            companyName: companyName,
            tmNo: tmNo
          });
      };
      reader.readAsDataURL(file);
    }

    // ì„œë²„ì— ê²€ì‚¬ ê·œê²© ì €ì¥
    function saveSpecsToServer(specs, tmNo, companyName) {
      // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš°, ê¸°ì¡´ ë°ì´í„° ë¨¼ì € ì‚­ì œ í›„ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      if (editingTmNo !== null) {
        google.script.run
          .withSuccessHandler(function(deleteResponse) {
            if (deleteResponse.success) {
              // ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì„±ê³µ í›„ ìƒˆ ë°ì´í„° ì¶”ê°€
              google.script.run
                .withSuccessHandler(function(response) {
                  if (response.success) {
                    alert(response.message || 'ê²€ì‚¬ ê·œê²©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeModal();
                    loadSpecs();
                  } else {
                    alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                  alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .addInspectionSpecsBatch(sessionToken, specs);
            } else {
              alert(deleteResponse.message || 'ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .deleteInspectionSpecsByTmNoAndCompany(sessionToken, tmNo, companyName);
      } else {
        // ì¶”ê°€ ëª¨ë“œì¸ ê²½ìš°, ë°”ë¡œ ì¶”ê°€
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert(response.message || 'ê²€ì‚¬ ê·œê²©ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeModal();
              loadSpecs();
            } else {
              alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .addInspectionSpecsBatch(sessionToken, specs);
      }
    }

    // ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
    function editSpecs(tmNo, productName, companyName) {
      editingTmNo = tmNo;
      document.getElementById('modalTitle').textContent = 'ê²€ì‚¬ ê·œê²© ìˆ˜ì •';
      document.getElementById('specTmNo').value = tmNo;
      document.getElementById('specTmNo').readOnly = true;
      document.getElementById('specProductName').value = productName;
      document.getElementById('specProductName').readOnly = true;
      document.getElementById('specCompanyName').value = companyName;
      document.getElementById('specCompanyName').readOnly = true;

      // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('specFileInput').value = '';

      // ê¸°ì¡´ ë°ì´í„° ë¡œë“œ
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const tbody = document.getElementById('inspectionItemsBody');
            tbody.innerHTML = '';

            response.data.forEach(function(spec) {
              const row = document.createElement('tr');
              row.setAttribute('data-row-index', spec.rowIndex);
              row.innerHTML = `
                <td><input type="text" class="inspection-item" value="${spec.inspectionItem}"></td>
                <td><input type="text" class="measurement-method" value="${spec.measurementMethod}"></td>
                <td><input type="text" class="lower-limit" value="${spec.lowerLimit}"></td>
                <td><input type="text" class="upper-limit" value="${spec.upperLimit}"></td>
                <td><input type="text" class="sample-size" value="${spec.sampleSize}"></td>
                <td><button class="btn-remove-row" onclick="removeInspectionRow(this)">âŒ</button></td>
              `;
              tbody.appendChild(row);
            });

            // ê¸°ì¡´ ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ í‘œì‹œ
            if (response.data.length > 0 && response.data[0].inspectionStandardUrl) {
              const url = response.data[0].inspectionStandardUrl;
              const fileName = url.substring(url.lastIndexOf('/') + 1);
              document.getElementById('specFileName').innerHTML = `í˜„ì¬ íŒŒì¼: <a href="${url}" target="_blank" style="color: #667eea;">${tmNo}_ê²€ì‚¬ê¸°ì¤€ì„œ</a>`;
            } else {
              document.getElementById('specFileName').textContent = 'ë“±ë¡ëœ íŒŒì¼ ì—†ìŒ';
            }
          }
        })
        .getInspectionSpecs(sessionToken, {tmNo: tmNo, companyName: companyName});

      document.getElementById('specModal').style.display = 'block';
    }

    // ê·œê²© ì‚­ì œ
    function deleteSpecs(tmNo, productName, companyName) {
      if (!confirm(`${tmNo} (${productName})ì˜ ëª¨ë“  ê²€ì‚¬ ê·œê²©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            response.data.forEach(function(spec) {
              google.script.run
                .withSuccessHandler(function() {
                  loadSpecs();
                })
                .deleteInspectionSpec(sessionToken, spec.rowIndex);
            });
            alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
          }
        })
        .getInspectionSpecs(sessionToken, {tmNo: tmNo});
    }

    // ëª¨ë‹¬ ë‹«ê¸°
    function closeModal() {
      document.getElementById('specModal').style.display = 'none';
      document.getElementById('specTmNo').readOnly = false;
      document.getElementById('specProductName').readOnly = false;
      editingTmNo = null;  // ëª¨ë‹¬ ë‹«ì„ ë•Œ í¸ì§‘ ëª¨ë“œ ë¦¬ì…‹
    }

    // í˜ì´ì§€ ì´ë™
    function goToPage(page) {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': page,
        'token': token,
        't': Date.now()
      });
    }

    // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ (Dashboardë¡œ ì´ë™í•˜ë©´ì„œ ìë™ ì—´ê¸°)
    function showInspectionResultModal() {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': 'dashboard',
        'token': token,
        'openInspectionModal': 'true',
        't': Date.now()
      });
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const token = sessionStorage.getItem('sessionToken');
        google.script.run
          .withSuccessHandler(function() {
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
          })
          .withFailureHandler(function(error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
          })
          .logoutWithToken(token);
      }
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      const modal = document.getElementById('specModal');
      if (event.target === modal) {
        closeModal();
      }
    };
  </script>
</body>
</html>
