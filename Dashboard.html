<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ëŒ€ì‹œë³´ë“œ - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }

    /* í—¤ë” */
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ í¼ ìŠ¤íƒ€ì¼ */
    .form-group-horizontal {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 20px;
      margin-bottom: 20px;
      align-items: start;
    }

    .form-input-section {
      display: flex;
      flex-direction: column;
    }

    .form-label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #333;
      font-size: 14px;
    }

    .required {
      color: #e74c3c;
      margin-left: 2px;
    }

    .form-control {
      width: 100%;
      padding: 10px 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .help-text {
      padding: 8px 12px;
      background-color: #f8f9fa;
      border-left: 3px solid #667eea;
      border-radius: 4px;
      font-size: 13px;
      color: #666;
      line-height: 1.5;
      min-width: 180px;
      align-self: center;
      margin-top: 28px;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }

    .alert-error {
      background-color: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }

    .alert-success {
      background-color: #efe;
      border: 1px solid #cfc;
      color: #3c3;
    }

    .btn-primary {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-primary:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .btn-secondary {
      padding: 12px 24px;
      background: #6c757d;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    /* ë°˜ì‘í˜•: ëª¨ë°”ì¼ì—ì„œëŠ” ì„¸ë¡œ ë ˆì´ì•„ì›ƒ */
    @media (max-width: 768px) {
      .form-group-horizontal {
        grid-template-columns: 1fr;
        gap: 10px;
      }

      .help-text {
        margin-top: 0;
        min-width: auto;
      }
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-title h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header-title p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .header-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-white {
      background: white;
      color: #667eea;
    }
    
    .btn-white:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(255,255,255,0.3);
    }
    
    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    .btn-outline:hover {
      background: white;
      color: #667eea;
    }
    
    /* ë©”ì¸ ì»¨í…ì¸  */
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    /* ë‚´ë¹„ê²Œì´ì…˜ */
    .nav-menu {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 24px;
      background: #f0f4ff;
      color: #667eea;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .nav-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #667eea;
      color: white;
      border-color: #667eea;
    }

    /* ì„¹ì…˜ ìŠ¤íƒ€ì¼ */
    .section {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    .section-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .section-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
    }

    /* ë³´ë“œ ê·¸ë¦¬ë“œ */
    .board-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .board-card {
      background: white;
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      transition: transform 0.3s, box-shadow 0.3s;
    }

    .board-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.1);
    }

    .board-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .board-title {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 18px;
      font-weight: bold;
      color: #333;
    }

    .board-icon {
      font-size: 24px;
    }

    .board-content {
      min-height: 200px;
      max-height: 400px;
      overflow-y: auto;
    }

    .board-item {
      padding: 15px;
      border-bottom: 1px solid #f0f0f0;
      cursor: pointer;
      transition: background-color 0.2s;
    }

    .board-item:last-child {
      border-bottom: none;
    }

    .board-item:hover {
      background-color: #f8f9fa;
    }

    .board-item-title {
      font-weight: 600;
      color: #333;
      margin-bottom: 5px;
      font-size: 14px;
    }

    .board-item-meta {
      display: flex;
      gap: 10px;
      font-size: 12px;
      color: #999;
    }

    .board-empty {
      text-align: center;
      padding: 60px 20px;
      color: #999;
    }

    .board-empty-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .table-responsive {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
    }
    
    thead {
      background-color: #f8f9fa;
    }
    
    th {
      padding: 12px;
      text-align: left;
      font-weight: 600;
      color: #555;
      border-bottom: 2px solid #e0e0e0;
      font-size: 14px;
    }
    
    td {
      padding: 12px;
      border-bottom: 1px solid #f0f0f0;
      font-size: 14px;
    }
    
    tbody tr:hover {
      background-color: #f8f9fa;
    }
    
    .empty-state {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
    }
    
    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    /* ë°˜ì‘í˜• */
    @media (max-width: 768px) {
      .header-content {
        flex-direction: column;
        align-items: flex-start;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .board-grid {
        grid-template-columns: 1fr;
      }

      .nav-menu {
        flex-direction: column;
      }

      .nav-btn {
        width: 100%;
      }

      table {
        font-size: 12px;
      }

      th, td {
        padding: 8px;
      }
    }
  </style>
</head>
<body>
  <!-- í—¤ë” -->
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>í˜‘ë ¥ì‚¬ ìˆ˜ì…ê²€ì‚¬ ê´€ë¦¬</h1>
        <p id="userInfo">ë¡œë”© ì¤‘...</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" id="btnChangePassword" onclick="showChangePasswordModal()" style="display: none;">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>
  
  <!-- ë©”ì¸ ì»¨í…ì¸  -->
  <div class="container">
    <!-- ë‚´ë¹„ê²Œì´ì…˜ ë©”ë‰´ -->
    <?!= include('Navigation') ?>

    <!-- ê³µì§€ì‚¬í•­ ë° ì—…ë¬´ì—°ë½ ë³´ë“œ -->
    <div class="board-grid">
      <!-- ê³µì§€ì‚¬í•­ ë³´ë“œ -->
      <div class="board-card">
        <div class="board-header">
          <div class="board-title">
            <span class="board-icon">ğŸ“¢</span>
            <span>ê³µì§€ì‚¬í•­</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <button id="btnNoticeManage" onclick="showNoticeManageModal()" style="display: none; padding: 6px 12px; background: #ff5722; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">âš™ï¸ ê´€ë¦¬</button>
            <span style="font-size: 12px; color: #999;" id="noticeCount">0</span>
          </div>
        </div>
        <div class="board-content" id="noticeBoard">
          <div class="board-empty">
            <div class="board-empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- ì—…ë¬´ì—°ë½ ë³´ë“œ -->
      <div class="board-card">
        <div class="board-header">
          <div class="board-title">
            <span class="board-icon">ğŸ“</span>
            <span>ì—…ë¬´ì—°ë½</span>
          </div>
          <div style="display: flex; align-items: center; gap: 10px;">
            <button id="btnWorkNoticeManage" onclick="showWorkNoticeManageModal()" style="display: none; padding: 6px 12px; background: #673ab7; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: 600;">âš™ï¸ ê´€ë¦¬</button>
            <span style="font-size: 12px; color: #999;" id="workNoticeCount">0</span>
          </div>
        </div>
        <div class="board-content" id="workNoticeBoard">
          <div class="board-empty">
            <div class="board-empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ì—…ë¬´ì—°ë½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ -->
  <div id="inspectionResultModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1400px; max-height: 85vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <!-- ì œëª© (ê³ ì •) -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“Š ê²€ì‚¬ê²°ê³¼ë“±ë¡</h3>
        <span onclick="closeInspectionResultModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <!-- ê²€ìƒ‰ í•„í„° ì˜ì—­ (ê³ ì •) -->
      <div style="padding: 20px 25px; border-bottom: 1px solid #e0e0e0; flex-shrink: 0; background-color: #f8f9fa;">
        <div style="display: grid; grid-template-columns: repeat(4, 1fr) auto auto auto; gap: 10px; align-items: end;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì—…ì²´ëª…</label>
            <select id="inspectionSearchCompany" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì…ê³ ì¼ì</label>
            <input type="date" id="inspectionSearchDate" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì‹œê°„</label>
            <select id="inspectionSearchTime" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">ì „ì²´</option>
              <option value="ì˜¤ì „">ì˜¤ì „</option>
              <option value="ì˜¤í›„">ì˜¤í›„</option>
            </select>
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">TM-NO</label>
            <input type="text" id="inspectionSearchTmNo" placeholder="TM-NO ê²€ìƒ‰" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <button onclick="searchInspectionData()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ” ê²€ìƒ‰</button>
          <button onclick="clearInspectionSearch()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">â†» ì´ˆê¸°í™”</button>
          <button onclick="refreshInspectionResults()" style="padding: 10px 20px; background: #28a745; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ğŸ”„ ìƒˆë¡œê³ ì¹¨</button>
        </div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ í…Œì´ë¸” (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
      <div style="flex: 1; overflow-y: auto; padding: 20px 25px; min-height: 200px;">
        <div id="inspectionSearchResultContainer">
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
            <p style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
            <p style="font-size: 14px;">ì¡°ê±´ ì—†ì´ ê²€ìƒ‰í•˜ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
          </div>
        </div>
      </div>

      <!-- ë‹«ê¸° ë²„íŠ¼ (ê³ ì •) -->
      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; text-align: right; flex-shrink: 0;">
        <button onclick="closeInspectionResultModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê²€ì‚¬ê²°ê³¼ì…ë ¥ ëª¨ë‹¬ (ë³„ë„ ì°½) -->
  <div id="inspectionInputModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 30px auto; padding: 0; border-radius: 12px; width: 95%; max-width: 1600px; max-height: 90vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <!-- ì œëª© (ê³ ì •) -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“‹ ê²€ì‚¬ê²°ê³¼ ì…ë ¥</h3>
        <span onclick="closeInspectionInputModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <!-- ë°ì´í„° ì •ë³´ í‘œì‹œ (ê³ ì •) -->
      <div id="inspectionDataInfo" style="padding: 20px 25px; background-color: #f8f9fa; border-bottom: 1px solid #e0e0e0; flex-shrink: 0;">
        <!-- ë°ì´í„° ì •ë³´ í‘œì‹œ -->
      </div>

      <!-- ê²€ì‚¬í•­ëª© ì…ë ¥ í¼ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
      <div style="flex: 1; overflow-y: auto; padding: 20px 25px; min-height: 300px;">
        <div id="inspectionItemsContainer">
          <!-- ê²€ì‚¬í•­ëª©ë³„ ì…ë ¥ í¼ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <!-- ì €ì¥/ì·¨ì†Œ ë²„íŠ¼ (ê³ ì •) -->
      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: center; gap: 10px; flex-shrink: 0;">
        <button onclick="saveInspectionResultData()" style="padding: 12px 30px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">ğŸ’¾ ì €ì¥</button>
        <button onclick="closeInspectionInputModal()" style="padding: 12px 30px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; font-size: 16px;">ì·¨ì†Œ</button>
      </div>
    </div>
  </div>

  <!-- ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ -->
  <div id="changePasswordModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 100px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 500px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <!-- ì œëª© -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ”’ ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
        <span onclick="closeChangePasswordModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 1;">&times;</span>
      </div>

      <!-- ë‚´ìš© -->
      <div style="padding: 25px;">
        <div id="passwordAlertBox" class="alert" style="display: none;"></div>

        <form id="changePasswordForm" onsubmit="handleChangePassword(event)">
          <div class="form-group-horizontal">
            <div class="form-input-section">
              <label class="form-label">í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
              <input type="password" class="form-control" id="currentPassword" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            <div class="help-text">
              ë³¸ì¸ í™•ì¸ì„ ìœ„í•´<br>í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥
            </div>
          </div>

          <div class="form-group-horizontal">
            <div class="form-input-section">
              <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ <span class="required">*</span></label>
              <input type="password" class="form-control" id="newPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required minlength="6">
            </div>
            <div class="help-text">
              ìµœì†Œ 6ì ì´ìƒ<br>ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>
          </div>

          <div class="form-group-horizontal">
            <div class="form-input-section">
              <label class="form-label">ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸ <span class="required">*</span></label>
              <input type="password" class="form-control" id="confirmPassword" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required minlength="6">
            </div>
            <div class="help-text">
              ìƒˆ ë¹„ë°€ë²ˆí˜¸ë¥¼<br>ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”
            </div>
          </div>

          <div style="display: flex; gap: 10px; margin-top: 25px;">
            <button type="submit" class="btn-primary" style="flex: 1;" id="btnSubmitPassword">ë³€ê²½í•˜ê¸°</button>
            <button type="button" class="btn-secondary" style="flex: 1;" onclick="closeChangePasswordModal()">ì·¨ì†Œ</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Item ê´€ë¦¬ ëª¨ë‹¬ -->
  <div id="itemModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1200px; max-height: 80vh; display: flex; flex-direction: column; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <!-- ì œëª© (ê³ ì •) -->
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center; flex-shrink: 0;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“¦ Item ê´€ë¦¬</h3>
        <span onclick="closeItemModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <!-- ê²€ìƒ‰ í•„í„° (ê³ ì •) -->
      <div style="padding: 25px 25px 15px 25px; flex-shrink: 0; border-bottom: 1px solid #e0e0e0;">
        <div style="display: flex; gap: 10px; align-items: flex-end;">
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">ì—…ì²´ëª…</label>
            <select id="searchItemCompany" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
              <option value="">ì „ì²´</option>
            </select>
          </div>
          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 5px; font-size: 14px;">TM-NO</label>
            <input type="text" id="searchItemTmNo" placeholder="TM-NO ê²€ìƒ‰" style="width: 100%; padding: 10px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <button onclick="searchItems()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ğŸ” ê²€ìƒ‰</button>
          <button onclick="clearItemSearch()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">â†» ì´ˆê¸°í™”</button>
          <button onclick="showItemAddModal()" style="padding: 10px 20px; background: #4caf50; color: white; border: none; border-radius: 8px; cursor: pointer;">â• ì¶”ê°€</button>
        </div>
      </div>

      <!-- Item ëª©ë¡ (ìŠ¤í¬ë¡¤ ê°€ëŠ¥) -->
      <div style="flex: 1; overflow-y: auto; padding: 20px 25px; min-height: 200px;">
        <div id="itemListContainer">
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ Itemì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        </div>
      </div>

      <!-- ë‹«ê¸° ë²„íŠ¼ (ê³ ì •) -->
      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; text-align: right; flex-shrink: 0;">
        <button onclick="closeItemModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="itemEditModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5);">
    <div class="modal-content" style="background-color: white; margin: 100px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 600px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="itemModalTitle" style="font-size: 20px; font-weight: 600; margin: 0;">Item ì¶”ê°€</h3>
        <span onclick="closeItemEditModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px;">
        <input type="hidden" id="itemRowIndex">
        <input type="hidden" id="itemSheetName">

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">TM-NO</label>
          <input type="text" id="itemTmNo" placeholder="TM-NOë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œí’ˆëª…</label>
          <input type="text" id="itemProductName" placeholder="ì œí’ˆëª…ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì—…ì²´ëª…</label>
          <select id="itemCompanyName" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            <option value="">ì—…ì²´ëª…ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </div>

        <div id="itemInspectionTypeField" style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²€ì‚¬í˜•íƒœ</label>
          <select id="itemInspectionType" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
            <option value="">ê²€ì‚¬í˜•íƒœë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
            <option value="ê²€ì‚¬">ê²€ì‚¬</option>
            <option value="ë¬´ê²€ì‚¬">ë¬´ê²€ì‚¬</option>
          </select>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²€ì‚¬ê¸°ì¤€ì„œ ì—…ë¡œë“œ</label>
          <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="itemFileInput" accept=".pdf" style="flex: 1;">
            <span id="itemFileName" style="color: #666; font-size: 13px;"></span>
          </div>
          <p style="font-size: 12px; color: #999; margin-top: 5px;">PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥ (ìµœëŒ€ 20MB)</p>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeItemEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveItem()" style="padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ì—…ë¬´ì—°ë½ ê´€ë¦¬ ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
  <div id="workNoticeManageModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1200px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“ ì—…ë¬´ì—°ë½ ê´€ë¦¬</h3>
        <span onclick="closeWorkNoticeManageModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px; overflow-y: auto; flex: 1;">
        <div style="margin-bottom: 20px; text-align: right;">
          <button onclick="showWorkNoticeEditModal()" style="padding: 10px 20px; background: #673ab7; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ì—…ë¬´ì—°ë½ ì¶”ê°€</button>
        </div>

        <div id="workNoticeListContainer">
          <!-- ì—…ë¬´ì—°ë½ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; text-align: right;">
        <button onclick="closeWorkNoticeManageModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ì—…ë¬´ì—°ë½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="workNoticeEditModal" class="modal" style="display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 80px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="background: linear-gradient(135deg, #673ab7 0%, #512da8 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="workNoticeEditTitle" style="font-size: 20px; font-weight: 600; margin: 0;">ì—…ë¬´ì—°ë½ ì¶”ê°€</h3>
        <span onclick="closeWorkNoticeEditModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px;">
        <input type="hidden" id="workNoticeRowIndex" value="">

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œëª© <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="workNoticeTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ë‚´ìš© <span style="color: #e74c3c;">*</span></label>
          <textarea id="workNoticeContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="6" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ëŒ€ìƒì—…ì²´ <span style="color: #e74c3c;">*</span></label>
          <div style="border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; max-height: 200px; overflow-y: auto; background-color: #fafafa;">
            <div style="margin-bottom: 10px;">
              <label style="display: flex; align-items: center; cursor: pointer; padding: 5px;">
                <input type="checkbox" id="workNoticeTargetAll" value="ì „ì²´" onchange="toggleAllCompanies(this)" style="margin-right: 8px; width: 18px; height: 18px;">
                <span style="font-weight: 600; color: #673ab7; font-size: 14px;">ì „ì²´</span>
              </label>
            </div>
            <div id="workNoticeCompanyList" style="padding-left: 10px;">
              <!-- ì—…ì²´ ì²´í¬ë°•ìŠ¤ ëª©ë¡ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>
          </div>
          <p style="font-size: 12px; color: #999; margin-top: 5px;">ë³µìˆ˜ ì„ íƒ ê°€ëŠ¥í•©ë‹ˆë‹¤. 'ì „ì²´' ì„ íƒ ì‹œ ëª¨ë“  ì—…ì²´ê°€ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²Œì‹œ ì‹œì‘ì¼</label>
            <input type="date" id="workNoticeStartDate" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²Œì‹œ ì¢…ë£Œì¼</label>
            <input type="date" id="workNoticeEndDate" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="workNoticeImportant" style="margin-right: 8px; width: 18px; height: 18px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">ì¤‘ìš” í‘œì‹œ (ìƒë‹¨ ê³ ì •)</span>
          </label>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="workNoticeActive" checked style="margin-right: 8px; width: 18px; height: 18px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">í™œì„±í™”</span>
          </label>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeWorkNoticeEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveWorkNotice()" style="padding: 10px 20px; background: #673ab7; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê³µì§€ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬ (ê´€ë¦¬ììš©) -->
  <div id="noticeManageModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 1200px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 style="font-size: 20px; font-weight: 600; margin: 0;">ğŸ“¢ ê³µì§€ì‚¬í•­ ê´€ë¦¬</h3>
        <span onclick="closeNoticeManageModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px; overflow-y: auto; flex: 1;">
        <div style="margin-bottom: 20px; text-align: right;">
          <button onclick="showNoticeEditModal()" style="padding: 10px 20px; background: #ff5722; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">â• ê³µì§€ì‚¬í•­ ì¶”ê°€</button>
        </div>

        <div id="noticeListContainer">
          <!-- ê³µì§€ì‚¬í•­ ëª©ë¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; text-align: right;">
        <button onclick="closeNoticeManageModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ë‹«ê¸°</button>
      </div>
    </div>
  </div>

  <!-- ê³µì§€ì‚¬í•­ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="noticeEditModal" class="modal" style="display: none; position: fixed; z-index: 1002; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 80px auto; padding: 0; border-radius: 12px; width: 90%; max-width: 800px; box-shadow: 0 4px 20px rgba(0,0,0,0.3);">
      <div style="background: linear-gradient(135deg, #ff5722 0%, #e64a19 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="noticeEditTitle" style="font-size: 20px; font-weight: 600; margin: 0;">ê³µì§€ì‚¬í•­ ì¶”ê°€</h3>
        <span onclick="closeNoticeEditModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px;">
        <input type="hidden" id="noticeRowIndex" value="">

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œëª© <span style="color: #e74c3c;">*</span></label>
          <input type="text" id="noticeTitle" placeholder="ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ë‚´ìš© <span style="color: #e74c3c;">*</span></label>
          <textarea id="noticeContent" placeholder="ë‚´ìš©ì„ ì…ë ¥í•˜ì„¸ìš”" rows="6" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; resize: vertical;"></textarea>
        </div>

        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²Œì‹œ ì‹œì‘ì¼</label>
            <input type="date" id="noticeStartDate" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
          <div>
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ê²Œì‹œ ì¢…ë£Œì¼</label>
            <input type="date" id="noticeEndDate" style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px;">
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="noticeImportant" style="margin-right: 8px; width: 18px; height: 18px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">ì¤‘ìš” í‘œì‹œ (ìƒë‹¨ ê³ ì •)</span>
          </label>
        </div>

        <div style="margin-bottom: 20px;">
          <label style="display: flex; align-items: center; cursor: pointer;">
            <input type="checkbox" id="noticeActive" checked style="margin-right: 8px; width: 18px; height: 18px;">
            <span style="font-weight: 600; color: #333; font-size: 14px;">í™œì„±í™”</span>
          </label>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeNoticeEditModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveNotice()" style="padding: 10px 20px; background: #ff5722; color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <!-- ê²€ì‚¬ê·œê²© ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="specModal" class="modal" style="display: none; position: fixed; z-index: 1001; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.5); overflow: auto;">
    <div class="modal-content" style="background-color: white; margin: 50px auto; padding: 0; border-radius: 12px; width: 95%; max-width: 1000px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); max-height: 90vh; overflow: hidden; display: flex; flex-direction: column;">
      <div style="background: linear-gradient(135deg, #e69138 0%, #cc7722 100%); color: white; padding: 20px 25px; border-radius: 12px 12px 0 0; display: flex; justify-content: space-between; align-items: center;">
        <h3 id="specModalTitle" style="font-size: 20px; font-weight: 600; margin: 0;">ê²€ì‚¬ ê·œê²© ì¶”ê°€</h3>
        <span onclick="closeSpecModal()" style="color: white; font-size: 28px; font-weight: bold; cursor: pointer;">&times;</span>
      </div>

      <div style="padding: 25px; overflow-y: auto; flex: 1;">
        <!-- ì—…ì²´ëª…, TM-NO, ì œí’ˆëª… (í•œ ì¤„) -->
        <div style="display: flex; gap: 15px; margin-bottom: 20px;">
          <div style="flex: 2;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì—…ì²´ëª…</label>
            <input type="text" id="specCompanyName" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
          </div>

          <div style="flex: 1;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">TM-NO</label>
            <input type="text" id="specTmNo" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
          </div>

          <div style="flex: 3;">
            <label style="display: block; font-weight: 600; margin-bottom: 8px; color: #333; font-size: 14px;">ì œí’ˆëª…</label>
            <input type="text" id="specProductName" readonly style="width: 100%; padding: 10px 12px; border: 2px solid #e0e0e0; border-radius: 8px; font-size: 14px; background-color: #f5f5f5;">
          </div>
        </div>

        <div style="margin-bottom: 20px;">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
            <label style="font-weight: 600; color: #333; font-size: 14px;">ê²€ì‚¬ í•­ëª©</label>
            <button onclick="addSpecRow()" style="padding: 8px 16px; background: #e69138; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 13px;">â• ê²€ì‚¬í•­ëª© ì¶”ê°€</button>
          </div>
          <div style="max-height: 400px; overflow-y: auto; overflow-x: auto; border: 1px solid #ddd; border-radius: 8px;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead style="position: sticky; top: 0; z-index: 10;">
                <tr style="background-color: #f8f9fa;">
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: left; font-size: 13px; background-color: #f8f9fa;">ê²€ì‚¬í•­ëª©</th>
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: left; font-size: 13px; background-color: #f8f9fa;">ì¸¡ì •ë°©ë²•</th>
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: left; font-size: 13px; background-color: #f8f9fa;">ê·œê²©í•˜í•œ</th>
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: left; font-size: 13px; background-color: #f8f9fa;">ê·œê²©ìƒí•œ</th>
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: left; font-size: 13px; background-color: #f8f9fa;">ì‹œë£Œìˆ˜</th>
                  <th style="padding: 10px; border: 1px solid #ddd; border-top: none; text-align: center; width: 80px; font-size: 13px; background-color: #f8f9fa;">ì‚­ì œ</th>
                </tr>
              </thead>
              <tbody id="specItemsBody">
                <!-- ê²€ì‚¬í•­ëª© í–‰ë“¤ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
              </tbody>
            </table>
          </div>
        </div>
      </div>

      <div style="padding: 20px 25px; border-top: 1px solid #e0e0e0; display: flex; justify-content: flex-end; gap: 10px;">
        <button onclick="closeSpecModal()" style="padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 8px; cursor: pointer;">ì·¨ì†Œ</button>
        <button onclick="saveItemSpecs()" style="padding: 10px 20px; background: #e69138; color: white; border: none; border-radius: 8px; cursor: pointer;">ì €ì¥</button>
      </div>
    </div>
  </div>

  <script>
    // ===== í† í° ê´€ë¦¬ =====
    let sessionToken = null;
    let currentUser = null; // í˜„ì¬ ë¡œê·¸ì¸ ì‚¬ìš©ì ì •ë³´ ì €ì¥

    // ===== API í˜¸ì¶œ ì¤‘ë³µ ë°©ì§€ ë° ìºì‹± =====
    let isLoadingItems = false;
    let isLoadingItemCompanyList = false;
    let isLoadingItemSpecCounts = false;
    let isItemSearchStarted = false; // ê²€ìƒ‰ ì‹œì‘ ì—¬ë¶€ í”Œë˜ê·¸
    let itemsCache = null;
    let itemCompanyListCache = null;
    let itemSpecCountsCache = null;
    let cacheTimestamp = null;
    const CACHE_DURATION = 30000; // 30ì´ˆ ìºì‹œ ìœ ì§€

    // í† í° ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° ë˜ëŠ” sessionStorageì—ì„œ)
    function initToken() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° (í…œí”Œë¦¿ ë³€ìˆ˜)
      const serverToken = '<?!= token ?>';

      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        sessionToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (ì„œë²„ì—ì„œ ì „ë‹¬)');
      } else {
        // sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        sessionToken = sessionStorage.getItem('sessionToken');
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (sessionStorage)');
      }

      if (!sessionToken) {
        console.error('í† í° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        redirectToLogin();
      }

      return sessionToken;
    }

    // ì•ˆì „í•œ í˜ì´ì§€ ì´ë™ (iframe ìƒŒë“œë°•ìŠ¤ í˜¸í™˜)
    // ì—¬ëŸ¬ ë°©ë²•ì„ í´ë°±ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ìƒŒë“œë°•ìŠ¤ ì œì•½ ìš°íšŒ
    function safeNavigate(url, params) {
      // Query string ìƒì„±
      let fullUrl = url;
      if (params) {
        const queryString = Object.keys(params)
          .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
          .join('&');
        fullUrl = url + '?' + queryString;
      }

      // ë°©ë²• 1: window.top.location.href ì‹œë„ (ê°€ì¥ ì„ í˜¸)
      try {
        window.top.location.href = fullUrl;
        return;
      } catch (e) {
        console.warn('window.top.location.href ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 2: window.location.replace ì‹œë„
      try {
        window.location.replace(fullUrl);
        return;
      } catch (e) {
        console.warn('window.location.replace ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 3: meta refresh íƒœê·¸ ì‚¬ìš© (ìµœí›„ì˜ ìˆ˜ë‹¨)
      try {
        const meta = document.createElement('meta');
        meta.httpEquiv = 'refresh';
        meta.content = '0; url=' + fullUrl;
        document.head.appendChild(meta);
        console.log('meta refresh íƒœê·¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
      } catch (e) {
        console.error('ëª¨ë“  ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ë²• ì‹¤íŒ¨:', e.message);
        alert('í˜ì´ì§€ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      }
    }

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToLogin() {
      sessionStorage.removeItem('sessionToken');
      safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      // í† í° ì´ˆê¸°í™”
      initToken();

      // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ (ì„¸ì…˜ í™•ì¸)
      loadUserInfo();
    };

    // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function initNavigation(currentPage, userRole) {
      console.log('=== initNavigation í˜¸ì¶œ ===');
      console.log('currentPage:', currentPage);
      console.log('userRole:', userRole);

      // í˜„ì¬ í˜ì´ì§€ì— active í´ë˜ìŠ¤ ì¶”ê°€
      const navButtons = {
        'dashboard': 'navDashboard',
        'entry': 'navEntry',
        'history': 'navHistory',
        'certificate': 'navCertificate'
      };

      if (navButtons[currentPage]) {
        const btn = document.getElementById(navButtons[currentPage]);
        if (btn) {
          btn.classList.add('active');
        }
      }

      // Item ë“±ë¡ ë²„íŠ¼ì€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í‘œì‹œ
      const itemBtn = document.getElementById('navItem');
      if (itemBtn) {
        itemBtn.style.display = 'inline-block';
      }

      // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionResultBtn = document.getElementById('navInspectionResult');
      console.log('inspectionResultBtn ìš”ì†Œ:', inspectionResultBtn);
      if (inspectionResultBtn) {
        inspectionResultBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
        console.log('ê²€ì‚¬ê²°ê³¼ë“±ë¡ ë²„íŠ¼ display:', inspectionResultBtn.style.display);
      }

      // ê²€ì‚¬ê²°ê³¼ì´ë ¥ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionHistoryBtn = document.getElementById('navInspectionHistory');
      console.log('inspectionHistoryBtn ìš”ì†Œ:', inspectionHistoryBtn);
      if (inspectionHistoryBtn) {
        inspectionHistoryBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
        console.log('ê²€ì‚¬ê²°ê³¼ì´ë ¥ ë²„íŠ¼ display:', inspectionHistoryBtn.style.display);
      }

      // JEOëŠ” ì„±ì ì„œì…ë ¥, ì´ë ¥ê´€ë¦¬, í™•ì¸ì¦ì¶œë ¥ ë²„íŠ¼ ìˆ¨ê¹€
      const entryBtn = document.getElementById('navEntry');
      if (entryBtn) {
        entryBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const historyBtn = document.getElementById('navHistory');
      if (historyBtn) {
        historyBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const certificateBtn = document.getElementById('navCertificate');
      if (certificateBtn) {
        certificateBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      // ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
      const usersBtn = document.getElementById('navUsers');
      if (usersBtn) {
        usersBtn.style.display = (userRole === 'ê´€ë¦¬ì') ? 'inline-block' : 'none';
      }

      // ì—…ë¬´ì—°ë½ ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const workNoticeManageBtn = document.getElementById('btnWorkNoticeManage');
      if (workNoticeManageBtn) {
        workNoticeManageBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // ê³µì§€ì‚¬í•­ ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const noticeManageBtn = document.getElementById('btnNoticeManage');
      if (noticeManageBtn) {
        noticeManageBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // ì—…ë¬´ì—°ë½ ë° ê³µì§€ì‚¬í•­ ë¡œë“œ
      loadActiveWorkNotices();
      loadActiveNotices();

      // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í‘œì‹œ (ë¶€ë“œëŸ¬ìš´ fade-in íš¨ê³¼)
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.style.opacity = '1';
      }
    }

    // Item í´ë¦­ í•¸ë“¤ëŸ¬
    function handleItemClick() {
      // Dashboard í˜ì´ì§€ì—ì„œëŠ” ëª¨ë‹¬ ì—´ê¸°
      if (typeof showItemManagementModal === 'function') {
        showItemManagementModal();
      } else {
        // ë‹¤ë¥¸ í˜ì´ì§€ì—ì„œëŠ” Dashboardë¡œ ì´ë™
        goToPage('dashboard');
      }
    }

    // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(response) {
          console.log('ì‚¬ìš©ì ì •ë³´ ì‘ë‹µ:', response);

          if (response && response.success) {
            const user = response.user;
            currentUser = user; // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
            document.getElementById('userInfo').textContent =
              `${user.companyName} | ${user.name} (${user.role})`;

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” (ì¦‰ì‹œ ì‹¤í–‰)
            initNavigation('dashboard', user.role);

            // DOM ì•ˆì •í™” í›„ í•œë²ˆ ë” ì‹¤í–‰ (íƒ€ì´ë° ì´ìŠˆ ë°©ì§€)
            setTimeout(function() {
              console.log('ë„¤ë¹„ê²Œì´ì…˜ ì¬ì´ˆê¸°í™” (íƒ€ì´ë° ë³´ì •)');
              initNavigation('dashboard', user.role);

              // URL íŒŒë¼ë¯¸í„° í™•ì¸í•˜ì—¬ ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ ìë™ ì—´ê¸°
              const urlParams = new URLSearchParams(window.location.search);
              if (urlParams.get('openInspectionModal') === 'true') {
                console.log('ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ ìë™ ì—´ê¸°');
                if (user.role === 'ê´€ë¦¬ì' || user.role === 'JEO') {
                  showInspectionResultModal();
                }
              }
            }, 100);

            // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ë²„íŠ¼ì€ ì¼ë°˜ ì‚¬ìš©ìë§Œ í‘œì‹œ
            const btnChangePassword = document.getElementById('btnChangePassword');
            if (btnChangePassword && (user.role !== 'ê´€ë¦¬ì' && user.role !== 'JEO')) {
              btnChangePassword.style.display = 'inline-block';
            }
          } else {
            // ì„¸ì…˜ ì—†ìœ¼ë©´ ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ
            console.error('ì„¸ì…˜ ì—†ìŒ - ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ì´ë™');
            redirectToLogin();
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getCurrentUserByToken(sessionToken);
    }

    // í˜ì´ì§€ ì´ë™
    function goToPage(page) {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': page,
        'token': token,
        't': Date.now()
      });
    }

    // ===== ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ =====

    // ì „ì—­ ë³€ìˆ˜
    let currentInspectionDataId = null;
    let currentInspectionCompanyName = null;
    let currentInspectionTmNo = null;
    let currentInspectionSpecs = null;
    let savedInspectionResultKeys = []; // ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤ ëª©ë¡

    // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°
    function showInspectionResultModal() {
      document.getElementById('inspectionResultModal').style.display = 'block';

      // ì…ê³ ì¼ì ì´ˆê¸°ê°’ì„ ì˜¤ëŠ˜ ë‚ ì§œë¡œ ì„¤ì •
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inspectionSearchDate').value = today;

      // ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ
      loadInspectionCompanyList();

      // ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤ ì¡°íšŒ
      loadSavedInspectionResultKeys();
    }

    // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°
    function closeInspectionResultModal() {
      document.getElementById('inspectionResultModal').style.display = 'none';

      // ì´ˆê¸°í™”
      clearInspectionSearch();
    }

    // ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤ ì¡°íšŒ
    function loadSavedInspectionResultKeys() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.keys) {
            savedInspectionResultKeys = response.keys;
            console.log('ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤:', savedInspectionResultKeys.length + 'ê±´');
          } else {
            savedInspectionResultKeys = [];
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê²°ê³¼ í‚¤ ì¡°íšŒ ì‹¤íŒ¨:', error);
          savedInspectionResultKeys = [];
        })
        .getAllInspectionResultKeys(sessionToken);
    }

    // ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ
    function loadInspectionCompanyList() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('inspectionSearchCompany');

            // ê¸°ì¡´ ì˜µì…˜ ì œê±° (ì „ì²´ ì œì™¸)
            while (select.options.length > 1) {
              select.remove(1);
            }

            // ì—…ì²´ëª… ì¶”ê°€
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getCompanyList(sessionToken);
    }

    // ê²€ìƒ‰ ì‹¤í–‰
    function searchInspectionData() {
      const companyName = document.getElementById('inspectionSearchCompany').value.trim();
      const date = document.getElementById('inspectionSearchDate').value.trim();
      const time = document.getElementById('inspectionSearchTime').value.trim();
      const tmNo = document.getElementById('inspectionSearchTmNo').value.trim();

      const filters = {
        companyName: companyName,
        date: date,
        time: time,
        tmNo: tmNo
      };

      console.log('ê²€ìƒ‰ ì¡°ê±´:', filters);

      // ë¡œë”© í‘œì‹œ
      const container = document.getElementById('inspectionSearchResultContainer');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #667eea;">
          <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="font-size: 16px; font-weight: 600;">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      `;

      google.script.run
        .withSuccessHandler(function(response) {
          displayInspectionSearchResult(response);
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
          container.innerHTML = `
            <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
              <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
              <p>ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
            </div>
          `;
        })
        .searchDataForInspectionResult(sessionToken, filters);
    }

    // ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ
    function displayInspectionSearchResult(response) {
      const container = document.getElementById('inspectionSearchResultContainer');

      if (!response.success) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #dc3545;">
            <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
            <p>${response.message || 'ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'}</p>
          </div>
        `;
        return;
      }

      if (!response.data || response.data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“­</div>
            <p>ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      // í…Œì´ë¸” ìƒì„±
      let html = `
        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden;">
          <thead style="background-color: #f8f9fa;">
            <tr>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">ì—…ì²´ëª…</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">ì…ê³ ì¼ì</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">ì‹œê°„</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">TM-NO</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">í’ˆëª…</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 100px;">ìˆ˜ëŸ‰</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 180px;">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
      `;

      response.data.forEach(function(item) {
        // ê²€ì‚¬ê²°ê³¼ í‚¤ ìƒì„± (date|companyName|tmNo)
        // ë°±ì—”ë“œì—ì„œ ë¬´ê²€ì‚¬ í•­ëª©ì€ ì´ë¯¸ í•„í„°ë§ë˜ì–´ ìˆìŒ
        const resultKey = item.date + '|' + item.companyName + '|' + item.tmNo;
        const isSaved = savedInspectionResultKeys.includes(resultKey);

        // ìˆ˜ëŸ‰ í¬ë§· (ì²œë‹¨ìœ„ ì½¤ë§ˆ)
        const formattedQuantity = (item.quantity || 0).toLocaleString('ko-KR');

        // ë²„íŠ¼ ìŠ¤íƒ€ì¼ ë° í…ìŠ¤íŠ¸
        let buttonHtml = '';
        if (isSaved) {
          buttonHtml = `
            <button onclick='showInspectionInputForm("${item.id}", "${item.companyName}", "${item.tmNo}", "${item.productName}", "${item.date}", "${item.time}")' style="padding: 8px 16px; background: #28a745; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">âœ… ë“±ë¡ì™„ë£Œ</button>
          `;
        } else {
          buttonHtml = `
            <button onclick='showInspectionInputForm("${item.id}", "${item.companyName}", "${item.tmNo}", "${item.productName}", "${item.date}", "${item.time}")' style="padding: 8px 16px; background: #667eea; color: white; border: none; border-radius: 6px; cursor: pointer; font-weight: 600; font-size: 13px;">ğŸ“Š ê²€ì‚¬ê²°ê³¼ ë“±ë¡</button>
          `;
        }

        html += `
          <tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${item.companyName}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${item.date}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${item.time}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${item.tmNo}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${item.productName}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center; font-weight: 600;">${formattedQuantity}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              ${buttonHtml}
            </td>
          </tr>
        `;
      });

      html += `
          </tbody>
        </table>
        <div style="margin-top: 15px; text-align: right; color: #666; font-size: 14px;">
          ì´ <strong>${response.data.length}</strong>ê±´
        </div>
      `;

      container.innerHTML = html;
    }

    // ê²€ìƒ‰ ì¡°ê±´ ì´ˆê¸°í™”
    function clearInspectionSearch() {
      document.getElementById('inspectionSearchCompany').value = '';
      document.getElementById('inspectionSearchDate').value = '';
      document.getElementById('inspectionSearchTime').value = '';
      document.getElementById('inspectionSearchTmNo').value = '';

      const container = document.getElementById('inspectionSearchResultContainer');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #999;">
          <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”</p>
          <p style="font-size: 14px;">ì¡°ê±´ ì—†ì´ ê²€ìƒ‰í•˜ë©´ ì „ì²´ ë°ì´í„°ë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤</p>
        </div>
      `;
    }

    // ê²€ì‚¬ê²°ê³¼ ìƒˆë¡œê³ ì¹¨
    function refreshInspectionResults() {
      console.log('ê²€ì‚¬ê²°ê³¼ ìƒˆë¡œê³ ì¹¨ ì‹¤í–‰');

      // ë¡œë”© í‘œì‹œ
      const container = document.getElementById('inspectionSearchResultContainer');
      const hasSearchResults = container.querySelector('table');

      if (hasSearchResults) {
        // ê²€ìƒ‰ ê²°ê³¼ê°€ ìˆëŠ” ê²½ìš°ì—ë§Œ ìƒˆë¡œê³ ì¹¨
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #666;">
            <div style="font-size: 48px; margin-bottom: 15px;">ğŸ”„</div>
            <p>ìƒˆë¡œê³ ì¹¨ ì¤‘...</p>
          </div>
        `;

        // ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤ ë‹¤ì‹œ ë¡œë“œ
        loadSavedInspectionResultKeys();

        // 0.5ì´ˆ ëŒ€ê¸° í›„ ê²€ìƒ‰ ì¬ì‹¤í–‰ (í‚¤ ë¡œë”© ì‹œê°„ í™•ë³´)
        setTimeout(function() {
          searchInspectionData();
        }, 500);
      } else {
        // ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ë©”ì‹œì§€ë§Œ í‘œì‹œ
        alert('ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. ë¨¼ì € ê²€ìƒ‰ì„ ì‹¤í–‰í•´ì£¼ì„¸ìš”.');
      }
    }

    // ê²€ì‚¬ê²°ê³¼ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
    function showInspectionInputForm(dataId, companyName, tmNo, productName, date, time) {
      // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
      currentInspectionDataId = dataId;
      currentInspectionCompanyName = companyName;
      currentInspectionTmNo = tmNo;

      console.log('ê²€ì‚¬ê²°ê³¼ ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°:', dataId, companyName, tmNo);

      // ë°ì´í„° ì •ë³´ í‘œì‹œ
      const infoContainer = document.getElementById('inspectionDataInfo');
      infoContainer.innerHTML = `
        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;">
          <div><strong>ì—…ì²´ëª…:</strong> ${companyName}</div>
          <div><strong>ì…ê³ ì¼ì:</strong> ${date}</div>
          <div><strong>ì‹œê°„:</strong> ${time}</div>
          <div><strong>TM-NO:</strong> ${tmNo}</div>
          <div><strong>í’ˆëª…:</strong> ${productName}</div>
        </div>
      `;

      // ë¡œë”© í‘œì‹œ
      const itemsContainer = document.getElementById('inspectionItemsContainer');
      itemsContainer.innerHTML = `
        <div style="text-align: center; padding: 40px 20px; color: #666;">
          <div style="font-size: 48px; margin-bottom: 15px;">â³</div>
          <p>ê²€ì‚¬ê·œê²© ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
        </div>
      `;

      // ê²€ì‚¬ê²°ê³¼ì…ë ¥ ëª¨ë‹¬ ì—´ê¸°
      document.getElementById('inspectionInputModal').style.display = 'block';

      // ê²€ì‚¬ê·œê²© ì¡°íšŒ
      google.script.run
        .withSuccessHandler(function(response) {
          // response null ì²´í¬
          if (!response) {
            console.error('ê²€ì‚¬ê·œê²© ì¡°íšŒ ì‘ë‹µì´ nullì…ë‹ˆë‹¤.');
            itemsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                <p>ê²€ì‚¬ê·œê²© ì¡°íšŒ ì‘ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
                <button onclick="closeInspectionInputModal()" style="margin-top: 15px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
              </div>
            `;
            return;
          }

          if (response.success && response.specs) {
            currentInspectionSpecs = response.specs;

            // ê¸°ì¡´ ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ
            google.script.run
              .withSuccessHandler(function(resultResponse) {
                console.log('=== ê¸°ì¡´ ê²€ì‚¬ê²°ê³¼ ì‘ë‹µ ===');
                console.log('resultResponse:', resultResponse);
                console.log('resultResponse.success:', resultResponse ? resultResponse.success : 'null');
                console.log('resultResponse.data:', resultResponse ? resultResponse.data : 'null');

                let existingResults = [];
                // resultResponse null ì²´í¬
                if (resultResponse && resultResponse.success && resultResponse.data && resultResponse.data.length > 0) {
                  existingResults = resultResponse.data;
                  console.log('ê¸°ì¡´ ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ:', existingResults.length + 'ê±´');
                } else {
                  console.log('ì¡°ê±´ ë¶ˆì¶©ì¡±:', {
                    hasResponse: !!resultResponse,
                    success: resultResponse ? resultResponse.success : null,
                    hasData: resultResponse ? !!resultResponse.data : null,
                    dataLength: resultResponse && resultResponse.data ? resultResponse.data.length : null
                  });
                }
                renderInspectionInputForm(response.specs, existingResults);
              })
              .withFailureHandler(function(error) {
                console.error('ê¸°ì¡´ ê²€ì‚¬ê²°ê³¼ ì¡°íšŒ ì‹¤íŒ¨:', error);
                // ì‹¤íŒ¨í•´ë„ ë¹ˆ ë°°ì—´ë¡œ ë Œë”ë§
                renderInspectionInputForm(response.specs, []);
              })
              .getInspectionResultsByDataId(sessionToken, dataId);
          } else {
            itemsContainer.innerHTML = `
              <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
                <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
                <p>${response.message || 'ê²€ì‚¬ê·œê²©ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>
                <button onclick="closeInspectionInputModal()" style="margin-top: 15px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
              </div>
            `;
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê·œê²© ì¡°íšŒ ì‹¤íŒ¨:', error);
          itemsContainer.innerHTML = `
            <div style="text-align: center; padding: 40px 20px; color: #dc3545;">
              <div style="font-size: 48px; margin-bottom: 15px;">âš ï¸</div>
              <p>ê²€ì‚¬ê·œê²© ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</p>
              <button onclick="closeInspectionInputModal()" style="margin-top: 15px; padding: 10px 20px; background: #6c757d; color: white; border: none; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
          `;
        })
        .getInspectionSpecsForResult(sessionToken, companyName, tmNo);
    }

    // ê²€ì‚¬ê²°ê³¼ì…ë ¥ ëª¨ë‹¬ ë‹«ê¸°
    function closeInspectionInputModal() {
      document.getElementById('inspectionInputModal').style.display = 'none';
      document.getElementById('inspectionDataInfo').innerHTML = '';
      document.getElementById('inspectionItemsContainer').innerHTML = '';

      // ì „ì—­ ë³€ìˆ˜ ì´ˆê¸°í™”
      currentInspectionDataId = null;
      currentInspectionCompanyName = null;
      currentInspectionTmNo = null;
      currentInspectionSpecs = null;
    }

    // ê²€ì‚¬ê²°ê³¼ ì…ë ¥ í¼ ë Œë”ë§ (í‘œ í˜•ì‹)
    function renderInspectionInputForm(specs, existingResults) {
      const container = document.getElementById('inspectionItemsContainer');
      existingResults = existingResults || [];

      console.log('=== renderInspectionInputForm ì‹œì‘ ===');
      console.log('specs:', specs);
      console.log('existingResults:', existingResults);

      // ìµœëŒ€ ì‹œë£Œ ê°œìˆ˜ êµ¬í•˜ê¸°
      let maxSampleSize = 1;
      specs.forEach(function(spec) {
        const sampleSize = parseInt(spec.sampleSize) || 1;
        if (sampleSize > maxSampleSize) {
          maxSampleSize = sampleSize;
        }
      });

      // í‘œ ìƒì„±
      let html = `
        <div style="overflow-x: auto; border: 1px solid #e0e0e0; border-radius: 8px;">
          <table style="width: 100%; border-collapse: collapse; background: white; min-width: 1400px;">
            <thead style="background-color: #f8f9fa; position: sticky; top: 0; z-index: 10;">
              <tr>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">ì—…ì²´ëª…</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">TM-NO</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">í’ˆëª…</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">ê²€ì‚¬í•­ëª©</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">ì¸¡ì •ë°©ë²•</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">ê·œê²©</th>
      `;

      // ì‹œë£Œ ì»¬ëŸ¼ í—¤ë”
      for (let i = 0; i < maxSampleSize; i++) {
        html += `<th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">ì‹œë£Œ${i + 1}</th>`;
      }

      html += `
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap; width: 80px;">íŒì •</th>
                <th style="padding: 12px; border: 1px solid #e0e0e0; text-align: center; font-weight: 600; font-size: 13px; white-space: nowrap;">í•©ë¶€íŒì •</th>
              </tr>
            </thead>
            <tbody>
      `;

      // ë°ì´í„° í–‰
      const infoContainer = document.getElementById('inspectionDataInfo');
      const infoHtml = infoContainer.innerHTML;

      specs.forEach(function(spec, index) {
        const sampleSize = parseInt(spec.sampleSize) || 1;
        const specRange = (spec.lowerLimit || '-') + ' ~ ' + (spec.upperLimit || '-');

        // ê¸°ì¡´ ê²€ì‚¬ê²°ê³¼ ì°¾ê¸° (ê²€ì‚¬í•­ëª©ìœ¼ë¡œ ë§¤ì¹­)
        const existingResult = existingResults.find(function(r) {
          return r.inspectionItem === spec.inspectionItem;
        });

        console.log(`ê²€ì‚¬í•­ëª©[${index}]: ${spec.inspectionItem}, ê¸°ì¡´ê²°ê³¼:`, existingResult);

        html += `<tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">`;

        // ì—…ì²´ëª…, TM-NO, í’ˆëª… (ì „ì—­ ë³€ìˆ˜ì—ì„œ ê°€ì ¸ì˜¤ê¸°)
        html += `
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center; font-size: 13px; white-space: nowrap;">${currentInspectionCompanyName || ''}</td>
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center; font-size: 13px; white-space: nowrap;">${currentInspectionTmNo || ''}</td>
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: left; font-size: 13px;" id="productName_${index}"></td>
        `;

        // ê²€ì‚¬í•­ëª©, ì¸¡ì •ë°©ë²•, ê·œê²©
        html += `
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: left; font-size: 13px; font-weight: 600;">${spec.inspectionItem}</td>
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center; font-size: 13px;">${spec.measurementMethod}</td>
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center; font-size: 13px;">${specRange}</td>
        `;

        // ì‹œë£Œ ì…ë ¥ í•„ë“œ
        for (let i = 0; i < maxSampleSize; i++) {
          if (i < sampleSize) {
            // ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ì±„ìš°ê¸°
            let sampleValue = '';
            if (existingResult && existingResult.samples && existingResult.samples[i] !== undefined && existingResult.samples[i] !== '') {
              sampleValue = existingResult.samples[i];
            }

            if (i === 0 && existingResult) {
              console.log(`ì‹œë£Œê°’[${index}][${i}]: ${sampleValue}, samples:`, existingResult.samples);
            }

            html += `
              <td style="padding: 5px; border: 1px solid #e0e0e0; text-align: center;">
                <input type="number" step="any" class="sample-input" data-item-index="${index}" data-sample-index="${i}"
                  value="${sampleValue}"
                  style="width: 80px; padding: 6px; border: 2px solid #e0e0e0; border-radius: 4px; font-size: 13px; text-align: center;">
              </td>
            `;
          } else {
            html += `<td style="padding: 5px; border: 1px solid #e0e0e0; background-color: #f5f5f5;"></td>`;
          }
        }

        // íŒì • ë²„íŠ¼
        html += `
          <td style="padding: 5px; border: 1px solid #e0e0e0; text-align: center;">
            <button onclick="calculatePassFailForItem(${index})" style="padding: 6px 12px; background: #ff9800; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600; font-size: 12px; white-space: nowrap;">íŒì •</button>
          </td>
        `;

        // í•©ë¶€íŒì • (ê¸°ì¡´ ë°ì´í„°ê°€ ìˆìœ¼ë©´ í‘œì‹œ)
        let passFail = '-';
        let passFaillBgColor = '#f0f0f0';
        let passFaillColor = '#666';
        if (existingResult && existingResult.passFailResult) {
          passFail = existingResult.passFailResult;
          if (passFail === 'í•©ê²©') {
            passFaillBgColor = '#d4edda';
            passFaillColor = '#155724';
          } else if (passFail === 'ë¶ˆí•©ê²©') {
            passFaillBgColor = '#f8d7da';
            passFaillColor = '#721c24';
          }
        }

        html += `
          <td style="padding: 10px; border: 1px solid #e0e0e0; text-align: center;">
            <span class="pass-fail-badge" id="passFail_${index}" style="display: inline-block; padding: 6px 12px; border-radius: 6px; font-weight: 600; font-size: 12px; background: ${passFaillBgColor}; color: ${passFaillColor};">${passFail}</span>
          </td>
        `;

        html += `</tr>`;
      });

      html += `
            </tbody>
          </table>
        </div>
      `;

      container.innerHTML = html;

      // í’ˆëª… ì •ë³´ ì±„ìš°ê¸° (inspectionDataInfoì—ì„œ ì¶”ì¶œ)
      const productNameMatch = infoHtml.match(/<strong>í’ˆëª…:<\/strong>\s*([^<]+)/);
      if (productNameMatch && productNameMatch[1]) {
        const productName = productNameMatch[1].trim();
        specs.forEach(function(spec, index) {
          const td = document.getElementById('productName_' + index);
          if (td) {
            td.textContent = productName;
          }
        });
      }
    }

    // íŠ¹ì • ê²€ì‚¬í•­ëª©ì˜ í•©ë¶€íŒì • ê³„ì‚°
    function calculatePassFailForItem(itemIndex) {
      const spec = currentInspectionSpecs[itemIndex];
      const sampleInputs = document.querySelectorAll(`.sample-input[data-item-index="${itemIndex}"]`);
      const passFailSpan = document.getElementById(`passFail_${itemIndex}`);

      const lowerLimit = spec.lowerLimit ? parseFloat(spec.lowerLimit) : null;
      const upperLimit = spec.upperLimit ? parseFloat(spec.upperLimit) : null;

      let allPass = true;
      let hasValue = false;

      sampleInputs.forEach(function(input) {
        const value = input.value.trim();

        if (value !== '') {
          hasValue = true;
          const numValue = parseFloat(value);

          if (!isNaN(numValue)) {
            // í•˜í•œ ì²´í¬
            if (lowerLimit !== null && numValue < lowerLimit) {
              allPass = false;
            }

            // ìƒí•œ ì²´í¬
            if (upperLimit !== null && numValue > upperLimit) {
              allPass = false;
            }
          }
        }
      });

      // í•©ë¶€íŒì • í‘œì‹œ
      if (!hasValue) {
        passFailSpan.textContent = '-';
        passFailSpan.style.background = '#f0f0f0';
        passFailSpan.style.color = '#666';
      } else if (allPass) {
        passFailSpan.textContent = 'í•©ê²©';
        passFailSpan.style.background = '#d4edda';
        passFailSpan.style.color = '#155724';
      } else {
        passFailSpan.textContent = 'ë¶ˆí•©ê²©';
        passFailSpan.style.background = '#f8d7da';
        passFailSpan.style.color = '#721c24';
      }
    }

    // ê²€ì‚¬ê²°ê³¼ ì €ì¥
    function saveInspectionResultData() {
      if (!currentInspectionDataId || !currentInspectionSpecs) {
        alert('ê²€ì‚¬ ë°ì´í„°ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
      }

      // ëª¨ë“  ê²€ì‚¬í•­ëª©ì˜ ì‹œë£Œ ë°ì´í„° ìˆ˜ì§‘
      const results = [];

      currentInspectionSpecs.forEach(function(spec, index) {
        const sampleInputs = document.querySelectorAll(`.sample-input[data-item-index="${index}"]`);
        const samples = [];

        sampleInputs.forEach(function(input) {
          const value = input.value.trim();
          samples.push(value !== '' ? parseFloat(value) : '');
        });

        // ìµœì†Œ 1ê°œ ì´ìƒì˜ ì‹œë£Œ ê°’ì´ ì…ë ¥ë˜ì—ˆëŠ”ì§€ í™•ì¸
        const hasValue = samples.some(function(s) {
          return s !== '';
        });

        if (!hasValue) {
          alert(`ê²€ì‚¬í•­ëª© "${spec.inspectionItem}"ì˜ ì‹œë£Œ ê°’ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.`);
          throw new Error('ì‹œë£Œ ê°’ ëˆ„ë½');
        }

        // í•©ë¶€íŒì • ê³„ì‚°
        const lowerLimit = spec.lowerLimit ? parseFloat(spec.lowerLimit) : null;
        const upperLimit = spec.upperLimit ? parseFloat(spec.upperLimit) : null;
        let allPass = true;

        samples.forEach(function(value) {
          if (value !== '') {
            if (lowerLimit !== null && value < lowerLimit) {
              allPass = false;
            }
            if (upperLimit !== null && value > upperLimit) {
              allPass = false;
            }
          }
        });

        results.push({
          inspectionItem: spec.inspectionItem,
          measurementMethod: spec.measurementMethod,
          lowerLimit: spec.lowerLimit,
          upperLimit: spec.upperLimit,
          samples: samples,
          passFailResult: allPass ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'
        });
      });

      if (results.length === 0) {
        alert('ì €ì¥í•  ê²€ì‚¬ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      // í™•ì¸ ë©”ì‹œì§€
      if (!confirm('ê²€ì‚¬ê²°ê³¼ë¥¼ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      // ì €ì¥ í˜¸ì¶œ
      console.log('ê²€ì‚¬ê²°ê³¼ ì €ì¥:', currentInspectionDataId, results);

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ê²€ì‚¬ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');

            // ëª¨ë‹¬ ë‹«ê¸°
            closeInspectionInputModal();

            // ì €ì¥ëœ ê²€ì‚¬ê²°ê³¼ í‚¤ ê°±ì‹ 
            loadSavedInspectionResultKeys();

            // ê²€ìƒ‰ ê²°ê³¼ ê°±ì‹  (í˜„ì¬ ê²€ìƒ‰ ì¡°ê±´ìœ¼ë¡œ ì¬ê²€ìƒ‰)
            searchInspectionData();
          } else {
            alert(response.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì €ì¥ ì‹¤íŒ¨:', error);
          alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .saveInspectionResults(sessionToken, currentInspectionDataId, results);
    }

    // ===== ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ =====

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì—´ê¸°
    function showChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'block';
      document.getElementById('changePasswordForm').reset();
      hidePasswordAlert();
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ë‹«ê¸°
    function closeChangePasswordModal() {
      document.getElementById('changePasswordModal').style.display = 'none';
      document.getElementById('changePasswordForm').reset();
      hidePasswordAlert();
    }

    // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì²˜ë¦¬
    function handleChangePassword(event) {
      event.preventDefault();

      const currentPassword = document.getElementById('currentPassword').value;
      const newPassword = document.getElementById('newPassword').value;
      const confirmPassword = document.getElementById('confirmPassword').value;

      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      if (newPassword !== confirmPassword) {
        showPasswordAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }

      // í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ê°™ì€ì§€ í™•ì¸
      if (currentPassword === newPassword) {
        showPasswordAlert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ì™€ ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ë™ì¼í•©ë‹ˆë‹¤. ë‹¤ë¥¸ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      // ë²„íŠ¼ ë¹„í™œì„±í™”
      const btnSubmit = document.getElementById('btnSubmitPassword');
      btnSubmit.disabled = true;
      btnSubmit.textContent = 'ë³€ê²½ ì¤‘...';

      // ì„œë²„ í˜¸ì¶œ
      google.script.run
        .withSuccessHandler(function(response) {
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'ë³€ê²½í•˜ê¸°';

          if (response.success) {
            showPasswordAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            setTimeout(function() {
              closeChangePasswordModal();
            }, 2000);
          } else {
            showPasswordAlert(response.message || 'ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
          }
        })
        .withFailureHandler(function(error) {
          btnSubmit.disabled = false;
          btnSubmit.textContent = 'ë³€ê²½í•˜ê¸°';
          console.error('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì‹¤íŒ¨:', error);
          showPasswordAlert('ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .changePassword(sessionToken, currentPassword, newPassword);
    }

    // ë¹„ë°€ë²ˆí˜¸ ì•Œë¦¼ í‘œì‹œ
    function showPasswordAlert(message, type) {
      const alertBox = document.getElementById('passwordAlertBox');
      alertBox.textContent = message;
      alertBox.className = 'alert alert-' + type;
      alertBox.style.display = 'block';
    }

    // ë¹„ë°€ë²ˆí˜¸ ì•Œë¦¼ ìˆ¨ê¹€
    function hidePasswordAlert() {
      const alertBox = document.getElementById('passwordAlertBox');
      if (alertBox) {
        alertBox.style.display = 'none';
      }
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const token = sessionStorage.getItem('sessionToken');
        const webAppUrl = '<?= getWebAppUrl() ?>';
        google.script.run
          .withSuccessHandler(function() {
            sessionStorage.removeItem('sessionToken');
            safeNavigate(webAppUrl, null);
          })
          .withFailureHandler(function(error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            sessionStorage.removeItem('sessionToken');
            safeNavigate(webAppUrl, null);
          })
          .logoutWithToken(token);
      }
    }

    // ========== Item ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

    // Item ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸°
    function showItemManagementModal() {
      document.getElementById('itemModal').style.display = 'block';

      // ê²€ìƒ‰ìš© ì—…ì²´ ëª©ë¡ê³¼ ê·œê²© ì¹´ìš´íŠ¸ë§Œ ë¡œë“œ (ì•„ì´í…œ ëª©ë¡ì€ ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì‹œ ë¡œë“œ)
      loadItemCompanyList(function() {
        // ì—…ì²´ ëª©ë¡ ë¡œë“œ í›„ ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ
        setTimeout(function() {
          loadItemSpecCounts(function() {
            // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
            showItemInitialMessage();
          });
        }, 300);
      });
    }

    // Item ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    function showItemInitialMessage() {
      // ì´ë¯¸ ê²€ìƒ‰ì´ ì‹œì‘ëœ ê²½ìš° ì´ˆê¸° ë©”ì‹œì§€ë¥¼ í‘œì‹œí•˜ì§€ ì•ŠìŒ
      if (isItemSearchStarted) {
        console.log('ê²€ìƒ‰ì´ ì´ë¯¸ ì‹œì‘ë¨, ì´ˆê¸° ë©”ì‹œì§€ í‘œì‹œ ê±´ë„ˆëœ€');
        return;
      }

      const container = document.getElementById('itemListContainer');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #999;">
          <div style="font-size: 64px; margin-bottom: 20px;">ğŸ”</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì„¤ì •í•˜ê³  ê²€ìƒ‰ ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
          <p style="font-size: 14px;">ì—…ì²´ëª…, TM-NOë¡œ ê²€ìƒ‰í•˜ê±°ë‚˜, ì¡°ê±´ ì—†ì´ ê²€ìƒ‰í•˜ë©´ ì „ì²´ Itemì„ ì¡°íšŒí•©ë‹ˆë‹¤.</p>
        </div>
      `;
    }

    // Item ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeItemModal() {
      document.getElementById('itemModal').style.display = 'none';
      isItemSearchStarted = false; // í”Œë˜ê·¸ ë¦¬ì…‹
    }

    // Item ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ (ê²€ìƒ‰ìš©)
    function loadItemCompanyList(callback) {
      // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      if (isLoadingItemCompanyList) {
        console.log('loadItemCompanyList: ì´ë¯¸ ë¡œë”© ì¤‘');
        if (callback) setTimeout(callback, 100);
        return;
      }

      // ìºì‹œ í™•ì¸ (30ì´ˆ ì´ë‚´)
      if (itemCompanyListCache && cacheTimestamp && (Date.now() - cacheTimestamp < CACHE_DURATION)) {
        console.log('loadItemCompanyList: ìºì‹œ ì‚¬ìš©');
        updateItemCompanyList(itemCompanyListCache);
        if (callback) callback();
        return;
      }

      isLoadingItemCompanyList = true;

      google.script.run
        .withSuccessHandler(function(response) {
          isLoadingItemCompanyList = false;
          if (response.success && response.companies) {
            itemCompanyListCache = response.companies;
            cacheTimestamp = Date.now();
            updateItemCompanyList(response.companies);
          }
          if (callback) callback();
        })
        .withFailureHandler(function(error) {
          isLoadingItemCompanyList = false;
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          if (callback) callback();
        })
        .getCompanyList(sessionToken);
    }

    // ì—…ì²´ ëª©ë¡ UI ì—…ë°ì´íŠ¸
    function updateItemCompanyList(companies) {
      const select = document.getElementById('searchItemCompany');
      while (select.options.length > 1) {
        select.remove(1);
      }
      companies.forEach(function(company) {
        const option = document.createElement('option');
        option.value = company;
        option.textContent = company;
        select.appendChild(option);
      });
    }

    // Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ìš© ì—…ì²´ëª… ëª©ë¡ ë¡œë“œ (ì¼ë°˜ ê¶Œí•œ ì—…ì²´ë§Œ)
    function loadItemEditCompanyList(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success && response.companies) {
            const select = document.getElementById('itemCompanyName');
            // ì²« ë²ˆì§¸ ì˜µì…˜(placeholder) ì œì™¸í•˜ê³  ëª¨ë‘ ì œê±°
            while (select.options.length > 1) {
              select.remove(1);
            }
            // ì—…ì²´ëª… ëª©ë¡ ì¶”ê°€
            response.companies.forEach(function(company) {
              const option = document.createElement('option');
              option.value = company;
              option.textContent = company;
              select.appendChild(option);
            });
            // ì½œë°± í•¨ìˆ˜ê°€ ìˆìœ¼ë©´ ì‹¤í–‰
            if (callback) callback();
          }
        })
        .getNormalCompanyList(sessionToken);
    }

    // Item ëª©ë¡ ë¡œë“œ
    function loadItems(filters) {
      // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      if (isLoadingItems) {
        console.log('loadItems: ì´ë¯¸ ë¡œë”© ì¤‘');
        return;
      }

      isLoadingItems = true;
      const options = filters || {};

      google.script.run
        .withSuccessHandler(function(response) {
          isLoadingItems = false;
          displayItems(response);
        })
        .withFailureHandler(function(error) {
          isLoadingItems = false;
          console.error('Item ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getItems(sessionToken, options);
    }

    // HTML/JavaScript ë¬¸ìì—´ escape í•¨ìˆ˜
    function escapeHtml(str) {
      if (!str) return '';
      return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#039;')
        .replace(/\\/g, '&#92;')
        .replace(/\n/g, ' ')
        .replace(/\r/g, '');
    }

    // Item ëª©ë¡ í‘œì‹œ
    function displayItems(response) {
      const container = document.getElementById('itemListContainer');

      if (!response.success || response.data.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 20px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ Itemì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      // ì¼ë°˜ ì‚¬ìš©ìëŠ” ê²€ì‚¬í˜•íƒœ ì»¬ëŸ¼ ìˆ¨ê¹€
      const isAdmin = currentUser && (currentUser.role === 'ê´€ë¦¬ì' || currentUser.role === 'JEO');

      let html = '<table style="width: 100%; border-collapse: collapse; margin-top: 20px;"><thead style="background-color: #f8f9fa;"><tr>';
      html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 18%;">ì—…ì²´ëª…</th>';
      html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 12%;">TM-NO</th>';
      html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 18%;">ì œí’ˆëª…</th>';

      // ê´€ë¦¬ìë§Œ ê²€ì‚¬í˜•íƒœ ì»¬ëŸ¼ í‘œì‹œ
      if (isAdmin) {
        html += '<th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 8%;">ê²€ì‚¬í˜•íƒœ</th>';
      }

      html += '<th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 12%;">ê²€ì‚¬ê¸°ì¤€ì„œ</th>';
      html += '<th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 12%;">ê·œê²©</th>';
      html += '<th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 20%;">ì‘ì—…</th>';
      html += '</tr></thead><tbody>';

      response.data.forEach(function(item) {
        // ê°’ì„ escape ì²˜ë¦¬
        const escapedTmNo = escapeHtml(item.tmNo);
        const escapedProductName = escapeHtml(item.productName);
        const escapedCompanyName = escapeHtml(item.companyName);
        const escapedSheetName = escapeHtml(item.sheetName);
        const escapedInspectionType = escapeHtml(item.inspectionType);

        // ê·œê²©ë“±ë¡ ë²„íŠ¼ ê²°ì • (ê²€ì‚¬/ë¬´ê²€ì‚¬ ê´€ê³„ì—†ì´ ê·œê²© ì…ë ¥ ê°€ëŠ¥)
        let specButton;
        const specKey = item.tmNo + '|' + item.companyName;
        const specCount = specItemMap[specKey] || 0;

        if (specCount > 0) {
          // ê·œê²© ë“±ë¡ë¨
          specButton = `<button onclick='showSpecModal("${escapedTmNo}", "${escapedProductName}", "${escapedCompanyName}", true)' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #4caf50; color: white;">âœ… ê·œê²© (${specCount}ê°œ)</button>`;
        } else {
          // ê·œê²© ë¯¸ë“±ë¡
          specButton = `<button onclick='showSpecModal("${escapedTmNo}", "${escapedProductName}", "${escapedCompanyName}", false)' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #ff9800; color: white;">ğŸ“‹ ê·œê²©</button>`;
        }

        html += `
          <tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${escapeHtml(item.companyName)}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${escapeHtml(item.tmNo)}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${escapeHtml(item.productName)}</td>`;

        // ê´€ë¦¬ìë§Œ ê²€ì‚¬í˜•íƒœ ì»¬ëŸ¼ í‘œì‹œ
        if (isAdmin) {
          html += `<td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${escapeHtml(item.inspectionType)}</td>`;
        }

        // ê²€ì‚¬ê¸°ì¤€ì„œ ì»¬ëŸ¼ í‘œì‹œ
        let standardButton = '-';
        if (item.inspectionStandardUrl && item.inspectionStandardUrl.trim() !== '') {
          standardButton = `<a href="${item.inspectionStandardUrl}" target="_blank" style="padding: 6px 12px; background: #2196F3; color: white; text-decoration: none; border-radius: 6px; font-size: 12px; display: inline-block;">ğŸ“„ ë³´ê¸°</a>`;
        }

        html += `
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${standardButton}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${specButton}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <button onclick='editItem("${escapedSheetName}", ${item.rowIndex}, "${escapedTmNo}", "${escapedProductName}", "${escapedCompanyName}", "${escapedInspectionType}", "${escapeHtml(item.inspectionStandardUrl || '')}")' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; background: #ffc107; color: white;">âœï¸ ìˆ˜ì •</button>`;

        // ê´€ë¦¬ì/JEOë§Œ ì‚­ì œ ë²„íŠ¼ í‘œì‹œ
        if (isAdmin) {
          html += `<button onclick='deleteItemConfirm("${escapedSheetName}", ${item.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #f44336; color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>`;
        }

        html += `
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // Item ê²€ìƒ‰
    function searchItems() {
      isItemSearchStarted = true; // ê²€ìƒ‰ ì‹œì‘ í”Œë˜ê·¸ ì„¤ì •

      const companyName = document.getElementById('searchItemCompany').value.trim();
      const tmNo = document.getElementById('searchItemTmNo').value.trim();

      const filters = {};
      if (companyName) filters.companyName = companyName;
      if (tmNo) filters.tmNo = tmNo;

      // ë¡œë”© í‘œì‹œ
      const container = document.getElementById('itemListContainer');
      container.innerHTML = `
        <div style="text-align: center; padding: 60px 20px; color: #667eea;">
          <div style="border: 4px solid #f3f3f3; border-top: 4px solid #667eea; border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
          <p style="font-size: 16px; font-weight: 600;">ê²€ìƒ‰ ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>
      `;

      loadItems(filters);
    }

    // Item ê²€ìƒ‰ ì´ˆê¸°í™”
    function clearItemSearch() {
      isItemSearchStarted = false; // í”Œë˜ê·¸ ë¦¬ì…‹
      document.getElementById('searchItemCompany').value = '';
      document.getElementById('searchItemTmNo').value = '';
      showItemInitialMessage();
    }

    // Item ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function showItemAddModal() {
      document.getElementById('itemModalTitle').textContent = 'Item ì¶”ê°€';
      document.getElementById('itemRowIndex').value = '';
      document.getElementById('itemTmNo').value = '';
      document.getElementById('itemProductName').value = '';
      document.getElementById('itemCompanyName').value = '';
      document.getElementById('itemInspectionType').value = '';

      // ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”
      document.getElementById('itemFileInput').value = '';
      document.getElementById('itemFileName').textContent = '';

      const select = document.getElementById('itemCompanyName');
      const inspectionTypeField = document.getElementById('itemInspectionTypeField');
      const inspectionTypeSelect = document.getElementById('itemInspectionType');

      // ì¼ë°˜ ê¶Œí•œìì¸ ê²½ìš° ì—…ì²´ëª… ìë™ ì…ë ¥ ë° ì½ê¸° ì „ìš©
      if (currentUser && (currentUser.role !== 'ê´€ë¦¬ì' && currentUser.role !== 'JEO')) {
        // ì¼ë°˜ ì‚¬ìš©ìì˜ ê²½ìš° ìì‹ ì˜ ì—…ì²´ëª…ë§Œ ì˜µì…˜ìœ¼ë¡œ ì¶”ê°€
        select.innerHTML = '<option value="">ì—…ì²´ëª… ì„ íƒ</option>';
        const option = document.createElement('option');
        option.value = currentUser.companyName;
        option.textContent = currentUser.companyName;
        select.appendChild(option);
        select.value = currentUser.companyName;
        select.disabled = true;

        // ì¼ë°˜ ì‚¬ìš©ìëŠ” ê²€ì‚¬í˜•íƒœ í•„ë“œ ìˆ¨ê¸°ê³  ìë™ìœ¼ë¡œ "ê²€ì‚¬"ë¡œ ì„¤ì •
        inspectionTypeField.style.display = 'none';
        inspectionTypeSelect.value = 'ê²€ì‚¬';
      } else {
        // ê´€ë¦¬ìëŠ” ì„ íƒ ê°€ëŠ¥
        select.disabled = false;
        loadItemEditCompanyList();

        // ê´€ë¦¬ìëŠ” ê²€ì‚¬í˜•íƒœ í•„ë“œ í‘œì‹œ
        inspectionTypeField.style.display = 'block';
      }

      document.getElementById('itemEditModal').style.display = 'block';
    }

    // Item ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editItem(sheetName, rowIndex, tmNo, productName, companyName, inspectionType, inspectionStandardUrl) {
      document.getElementById('itemModalTitle').textContent = 'Item ìˆ˜ì •';
      document.getElementById('itemSheetName').value = sheetName;
      document.getElementById('itemRowIndex').value = rowIndex;
      document.getElementById('itemTmNo').value = tmNo;
      document.getElementById('itemProductName').value = productName;
      document.getElementById('itemInspectionType').value = inspectionType;

      // ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì •ë³´ í‘œì‹œ
      const fileNameSpan = document.getElementById('itemFileName');
      const fileInput = document.getElementById('itemFileInput');
      fileInput.value = ''; // íŒŒì¼ ì…ë ¥ ì´ˆê¸°í™”

      if (inspectionStandardUrl && inspectionStandardUrl.trim() !== '') {
        fileNameSpan.innerHTML = `<a href="${inspectionStandardUrl}" target="_blank" style="color: #2196F3; text-decoration: none;">ğŸ“„ ê¸°ì¡´ íŒŒì¼ ë³´ê¸°</a>`;
      } else {
        fileNameSpan.textContent = '';
      }

      const select = document.getElementById('itemCompanyName');
      const inspectionTypeField = document.getElementById('itemInspectionTypeField');

      // ì¼ë°˜ ê¶Œí•œìëŠ” ì—…ì²´ëª… ë³€ê²½ ë¶ˆê°€
      if (currentUser && (currentUser.role !== 'ê´€ë¦¬ì' && currentUser.role !== 'JEO')) {
        // ì¼ë°˜ ì‚¬ìš©ìì˜ ê²½ìš° í•´ë‹¹ ì—…ì²´ëª…ë§Œ í‘œì‹œ
        select.innerHTML = '<option value="">ì—…ì²´ëª… ì„ íƒ</option>';
        const option = document.createElement('option');
        option.value = companyName;
        option.textContent = companyName;
        select.appendChild(option);
        select.value = companyName;
        select.disabled = true;

        // ì¼ë°˜ ì‚¬ìš©ìëŠ” ê²€ì‚¬í˜•íƒœ í•„ë“œ ìˆ¨ê¸°ê³  ê¸°ì¡´ ê°’ì´ ì—†ìœ¼ë©´ "ê²€ì‚¬"ë¡œ ì„¤ì •
        inspectionTypeField.style.display = 'none';
        if (!inspectionType) {
          document.getElementById('itemInspectionType').value = 'ê²€ì‚¬';
        }
      } else {
        // ê´€ë¦¬ìëŠ” ì„ íƒ ê°€ëŠ¥
        select.disabled = false;
        loadItemEditCompanyList(function() {
          document.getElementById('itemCompanyName').value = companyName;
        });

        // ê´€ë¦¬ìëŠ” ê²€ì‚¬í˜•íƒœ í•„ë“œ í‘œì‹œ
        inspectionTypeField.style.display = 'block';
      }

      document.getElementById('itemEditModal').style.display = 'block';
    }

    // Item ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeItemEditModal() {
      document.getElementById('itemEditModal').style.display = 'none';
    }

    // Item ì €ì¥
    function saveItem() {
      const sheetName = document.getElementById('itemSheetName').value;
      const rowIndex = document.getElementById('itemRowIndex').value;
      let inspectionType = document.getElementById('itemInspectionType').value.trim();

      // ì¼ë°˜ ì‚¬ìš©ìì´ê±°ë‚˜ ê²€ì‚¬í˜•íƒœê°€ ë¹„ì–´ìˆìœ¼ë©´ ìë™ìœ¼ë¡œ "ê²€ì‚¬"ë¡œ ì„¤ì •
      if (!inspectionType) {
        inspectionType = 'ê²€ì‚¬';
      }

      const itemData = {
        tmNo: document.getElementById('itemTmNo').value.trim(),
        productName: document.getElementById('itemProductName').value.trim(),
        companyName: document.getElementById('itemCompanyName').value.trim(),
        inspectionType: inspectionType
      };

      if (!itemData.tmNo || !itemData.productName || !itemData.companyName) {
        alert('TM-NO, ì œí’ˆëª…, ì—…ì²´ëª…ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      // íŒŒì¼ ì—…ë¡œë“œ ì²´í¬
      const fileInput = document.getElementById('itemFileInput');
      const file = fileInput.files[0];

      if (file) {
        // íŒŒì¼ì´ ì„ íƒëœ ê²½ìš° ë¨¼ì € ì—…ë¡œë“œ
        uploadItemStandardFile(file, itemData.companyName, itemData.tmNo, function(fileUrl) {
          // íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ í›„ itemDataì— URL ì¶”ê°€
          itemData.inspectionStandardUrl = fileUrl;
          performSaveItem(sheetName, rowIndex, itemData);
        });
      } else {
        // íŒŒì¼ì´ ì—†ìœ¼ë©´ ë°”ë¡œ ì €ì¥
        performSaveItem(sheetName, rowIndex, itemData);
      }
    }

    // ì‹¤ì œ Item ì €ì¥ ìˆ˜í–‰
    function performSaveItem(sheetName, rowIndex, itemData) {
      if (rowIndex) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeItemEditModal();
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .updateItem(sessionToken, sheetName, parseInt(rowIndex), itemData);
      } else {
        // ì¶”ê°€
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeItemEditModal();
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .addItem(sessionToken, itemData);
      }
    }

    // ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì—…ë¡œë“œ
    function uploadItemStandardFile(file, companyName, tmNo, callback) {
      // PDF íŒŒì¼ íƒ€ì… ì²´í¬
      if (file.type !== 'application/pdf') {
        alert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.');
        return;
      }

      // íŒŒì¼ í¬ê¸° ì²´í¬ (20MB)
      const maxSize = 20 * 1024 * 1024;
      if (file.size > maxSize) {
        alert('íŒŒì¼ í¬ê¸°ëŠ” 20MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
      }

      console.log('ê²€ì‚¬ê¸°ì¤€ì„œ íŒŒì¼ ì—…ë¡œë“œ ì‹œì‘:', file.name);

      const reader = new FileReader();
      reader.onload = function(e) {
        const bytes = e.target.result.split(',')[1]; // Base64 ì¸ì½”ë”©ëœ ë°ì´í„°

        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              console.log('íŒŒì¼ ì—…ë¡œë“œ ì„±ê³µ:', response.fileUrl);
              alert('ê²€ì‚¬ê¸°ì¤€ì„œê°€ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤: ' + response.fileName);
              callback(response.fileUrl);
            } else {
              alert('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨: ' + response.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('íŒŒì¼ ì—…ë¡œë“œ ì˜¤ë¥˜:', error);
            alert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .uploadInspectionStandardFile(sessionToken, {
            fileName: file.name,
            mimeType: file.type,
            bytes: bytes,
            companyName: companyName,
            tmNo: tmNo
          });
      };

      reader.onerror = function() {
        alert('íŒŒì¼ ì½ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      };

      reader.readAsDataURL(file);
    }

    // Item ì‚­ì œ í™•ì¸
    function deleteItemConfirm(sheetName, rowIndex) {
      if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('Itemì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
              loadItems();
            } else {
              alert(response.message);
            }
          })
          .deleteItem(sessionToken, sheetName, rowIndex);
      }
    }

    // ========== ê²€ì‚¬ê·œê²© ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========
    let editingSpecTmNo = null;
    let specItemMap = {}; // TM-NO|ì—…ì²´ëª… â†’ ê·œê²© ê°œìˆ˜

    // ê²€ì‚¬ê·œê²© ë“±ë¡ ìƒíƒœ ë¡œë“œ
    function loadItemSpecCounts(callback) {
      // ì¤‘ë³µ í˜¸ì¶œ ë°©ì§€
      if (isLoadingItemSpecCounts) {
        console.log('loadItemSpecCounts: ì´ë¯¸ ë¡œë”© ì¤‘');
        if (callback) setTimeout(callback, 100);
        return;
      }

      isLoadingItemSpecCounts = true;

      google.script.run
        .withSuccessHandler(function(response) {
          isLoadingItemSpecCounts = false;
          if (response.success && response.data) {
            // TM-NO + ì—…ì²´ëª…ë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            response.data.forEach(function(spec) {
              const key = spec.tmNo + '|' + spec.companyName;
              if (!grouped[key]) {
                grouped[key] = [];
              }
              grouped[key].push(spec);
            });

            // ê°œìˆ˜ë¥¼ specItemMapì— ì €ì¥
            specItemMap = {};
            Object.keys(grouped).forEach(function(key) {
              specItemMap[key] = grouped[key].length;
            });

            console.log('ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ ì™„ë£Œ:', Object.keys(specItemMap).length + 'ê°œ í•­ëª©');
          }
          if (callback) callback();
        })
        .withFailureHandler(function(error) {
          isLoadingItemSpecCounts = false;
          console.error('ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          if (callback) callback(); // ì‹¤íŒ¨í•´ë„ ë‹¤ìŒ ë‹¨ê³„ ì§„í–‰
        })
        .getInspectionSpecs(sessionToken, {});
    }

    // ê²€ì‚¬ê·œê²© ëª¨ë‹¬ ì—´ê¸°
    function showSpecModal(tmNo, productName, companyName, isEdit) {
      // ìˆ˜ì • ëª¨ë“œ ëª…í™•íˆ ì„¤ì •
      if (isEdit === true || isEdit === 'true') {
        editingSpecTmNo = tmNo;
      } else {
        editingSpecTmNo = null;
      }

      document.getElementById('specModalTitle').textContent = editingSpecTmNo ? 'ê²€ì‚¬ ê·œê²© ìˆ˜ì •' : 'ê²€ì‚¬ ê·œê²© ì¶”ê°€';
      document.getElementById('specTmNo').value = tmNo;
      document.getElementById('specProductName').value = productName;
      document.getElementById('specCompanyName').value = companyName;

      const tbody = document.getElementById('specItemsBody');
      tbody.innerHTML = '';

      if (editingSpecTmNo) {
        // ê¸°ì¡´ ê·œê²© ë¡œë“œ - TM-NOì™€ ì—…ì²´ëª…ìœ¼ë¡œ í•„í„°ë§
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success && response.data) {
              response.data.forEach(function(spec) {
                addSpecRow(spec);
              });
            }
          })
          .getInspectionSpecs(sessionToken, {tmNo: tmNo, companyName: companyName});
      } else {
        // ë¹ˆ í–‰ í•˜ë‚˜ ì¶”ê°€
        addSpecRow();
      }

      document.getElementById('specModal').style.display = 'block';
    }

    // ê²€ì‚¬ê·œê²© ëª¨ë‹¬ ë‹«ê¸°
    function closeSpecModal() {
      document.getElementById('specModal').style.display = 'none';
      editingSpecTmNo = null;
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì¶”ê°€
    function addSpecRow(spec) {
      const tbody = document.getElementById('specItemsBody');
      const row = document.createElement('tr');

      // spec ê°’ë“¤ì„ ì•ˆì „í•˜ê²Œ ì²˜ë¦¬ (undefined ë°©ì§€)
      const inspectionItem = (spec && spec.inspectionItem) ? String(spec.inspectionItem) : '';
      const measurementMethod = (spec && spec.measurementMethod) ? String(spec.measurementMethod) : '';
      const lowerLimit = (spec && spec.lowerLimit) ? String(spec.lowerLimit) : '';
      const upperLimit = (spec && spec.upperLimit) ? String(spec.upperLimit) : '';
      const sampleSize = (spec && spec.sampleSize) ? String(spec.sampleSize) : '';

      row.innerHTML = `
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${inspectionItem}" placeholder="ê²€ì‚¬í•­ëª©" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${measurementMethod}" placeholder="ì¸¡ì •ë°©ë²•" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${lowerLimit}" placeholder="ê·œê²©í•˜í•œ" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="text" value="${upperLimit}" placeholder="ê·œê²©ìƒí•œ" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd;">
          <input type="number" value="${sampleSize}" placeholder="ì‹œë£Œìˆ˜" min="1" max="10" style="width: 100%; padding: 6px; border: 1px solid #ddd; border-radius: 4px;">
        </td>
        <td style="padding: 8px; border: 1px solid #ddd; text-align: center;">
          <button onclick="removeSpecRow(this)" style="padding: 4px 8px; background: #dc3545; color: white; border: none; border-radius: 4px; cursor: pointer;">âŒ</button>
        </td>
      `;

      tbody.appendChild(row);
    }

    // ê²€ì‚¬í•­ëª© í–‰ ì‚­ì œ
    function removeSpecRow(button) {
      const row = button.closest('tr');
      row.remove();
    }

    // ê²€ì‚¬ê·œê²© ì €ì¥
    function saveItemSpecs() {
      let tmNo, productName, companyName, specs;

      try {
        tmNo = document.getElementById('specTmNo').value.trim();
        productName = document.getElementById('specProductName').value.trim();
        companyName = document.getElementById('specCompanyName').value.trim();

        if (!tmNo || !productName || !companyName) {
          alert('TM-NO, ì œí’ˆëª…, ì—…ì²´ëª…ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }

        const rows = document.querySelectorAll('#specItemsBody tr');
        specs = [];

        rows.forEach(function(row) {
          const inputs = row.querySelectorAll('input');
          const inspectionItem = inputs[0].value.trim();
          const measurementMethod = inputs[1].value.trim();
          const lowerLimit = inputs[2].value.trim();
          const upperLimit = inputs[3].value.trim();
          const sampleSize = inputs[4].value.trim();

          if (inspectionItem) {
            // 1. ê²€ì‚¬í•­ëª©ì´ ì…ë ¥ë˜ë©´ ì¸¡ì •ë°©ë²• í•„ìˆ˜
            if (!measurementMethod) {
              alert('ê²€ì‚¬í•­ëª© "' + inspectionItem + '"ì˜ ì¸¡ì •ë°©ë²•ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              throw new Error('ì¸¡ì •ë°©ë²• ëˆ„ë½');
            }

            // 2. ì‹œë£Œìˆ˜ í•„ìˆ˜ ê²€ì‚¬
            if (!sampleSize || sampleSize === '' || isNaN(sampleSize) || parseInt(sampleSize) <= 0) {
              alert('ê²€ì‚¬í•­ëª© "' + inspectionItem + '"ì˜ ì‹œë£Œìˆ˜ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”. (1 ì´ìƒì˜ ìˆ«ì)');
              throw new Error('ì‹œë£Œìˆ˜ ëˆ„ë½');
            }

            // 3. ê·œê²© í•˜í•œ ë˜ëŠ” ìƒí•œ ì¤‘ ìµœì†Œ 1ê°œ í•„ìˆ˜
            if (!lowerLimit && !upperLimit) {
              alert('ê²€ì‚¬í•­ëª© "' + inspectionItem + '"ì˜ ê·œê²© í•˜í•œ ë˜ëŠ” ìƒí•œ ì¤‘ ìµœì†Œ 1ê°œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
              throw new Error('ê·œê²© ëˆ„ë½');
            }

            specs.push({
              tmNo: tmNo,
              productName: productName,
              companyName: companyName,
              inspectionItem: inspectionItem,
              measurementMethod: measurementMethod,
              lowerLimit: lowerLimit,
              upperLimit: upperLimit,
              sampleSize: sampleSize
            });
          }
        });

        if (specs.length === 0) {
          alert('ìµœì†Œ 1ê°œì˜ ê²€ì‚¬í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
          return;
        }
      } catch (error) {
        console.error('ê²€ì‚¬ê·œê²© ì €ì¥ ê²€ì¦ ì‹¤íŒ¨:', error);
        return; // ìœ íš¨ì„± ê²€ì‚¬ ì‹¤íŒ¨ ì‹œ ì €ì¥ ì¤‘ë‹¨
      }

      // ìˆ˜ì • ëª¨ë“œì¸ ê²½ìš° ê¸°ì¡´ ë°ì´í„° ë¨¼ì € ì‚­ì œ í›„ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
      if (editingSpecTmNo !== null && editingSpecTmNo !== undefined) {
        console.log('ìˆ˜ì • ëª¨ë“œ: ê¸°ì¡´ ë°ì´í„° ì‚­ì œ í›„ ì¶”ê°€', editingSpecTmNo, companyName);
        google.script.run
          .withSuccessHandler(function(deleteResponse) {
            if (deleteResponse.success) {
              console.log('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì™„ë£Œ, ìƒˆ ë°ì´í„° ì¶”ê°€ ì‹œì‘');
              // ì‚­ì œ ì„±ê³µ í›„ ìƒˆ ë°ì´í„° ì¶”ê°€
              google.script.run
                .withSuccessHandler(function(response) {
                  if (response.success) {
                    alert('ê²€ì‚¬ ê·œê²©ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    closeSpecModal();
                    // ìˆœì°¨ì ìœ¼ë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ê·œê²© ì¹´ìš´íŠ¸ -> ì•„ì´í…œ ëª©ë¡)
                    refreshSpecDataSequentially();
                  } else {
                    alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                  }
                })
                .withFailureHandler(function(error) {
                  console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                  alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                })
                .addInspectionSpecsBatch(sessionToken, specs);
            } else {
              alert(deleteResponse.message || 'ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì‚­ì œ ì‹¤íŒ¨:', error);
            alert('ê¸°ì¡´ ë°ì´í„° ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .deleteInspectionSpecsByTmNoAndCompany(sessionToken, tmNo, companyName);
      } else {
        // ì¶”ê°€ ëª¨ë“œì¸ ê²½ìš° ë°”ë¡œ ì¶”ê°€
        console.log('ì¶”ê°€ ëª¨ë“œ: ìƒˆ ë°ì´í„° ì¶”ê°€', tmNo, companyName);
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ê²€ì‚¬ ê·œê²©ì´ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeSpecModal();
              // ìˆœì°¨ì ìœ¼ë¡œ ë°ì´í„° ìƒˆë¡œê³ ì¹¨ (ê·œê²© ì¹´ìš´íŠ¸ -> ì•„ì´í…œ ëª©ë¡)
              refreshSpecDataSequentially();
            } else {
              alert(response.message || 'ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .addInspectionSpecsBatch(sessionToken, specs);
      }
    }

    // ê·œê²© ë°ì´í„°ë¥¼ ìˆœì°¨ì ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨
    function refreshSpecDataSequentially() {
      console.log('ê·œê²© ë°ì´í„° ìƒˆë¡œê³ ì¹¨ ì‹œì‘');

      // ë¨¼ì € ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ
      google.script.run
        .withSuccessHandler(function(response) {
          isLoadingItemSpecCounts = false;
          if (response.success && response.data) {
            // TM-NO + ì—…ì²´ëª…ë³„ë¡œ ê·¸ë£¹í™”
            const grouped = {};
            response.data.forEach(function(spec) {
              const key = spec.tmNo + '|' + spec.companyName;
              if (!grouped[key]) {
                grouped[key] = [];
              }
              grouped[key].push(spec);
            });

            // ê°œìˆ˜ë¥¼ specItemMapì— ì €ì¥
            specItemMap = {};
            Object.keys(grouped).forEach(function(key) {
              specItemMap[key] = grouped[key].length;
            });

            console.log('ê·œê²© ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸ ì™„ë£Œ, ì•„ì´í…œ ëª©ë¡ ë¡œë“œ ì‹œì‘');

            // ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ ì™„ë£Œ í›„ ì•„ì´í…œ ëª©ë¡ ë¡œë“œ
            setTimeout(function() {
              loadItems();
            }, 300);
          }
        })
        .withFailureHandler(function(error) {
          isLoadingItemSpecCounts = false;
          console.error('ê·œê²© ì¹´ìš´íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
          // ì‹¤íŒ¨í•´ë„ ì•„ì´í…œ ëª©ë¡ì€ ë¡œë“œ
          loadItems();
        })
        .getInspectionSpecs(sessionToken, {});
    }

    // ========== ì—…ë¬´ì—°ë½ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

    // í™œì„± ì—…ë¬´ì—°ë½ ë¡œë“œ (ì‚¬ìš©ììš©)
    function loadActiveWorkNotices() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayWorkNotices(response.data);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ë¬´ì—°ë½ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getActiveWorkNotices(sessionToken);
    }

    // ì—…ë¬´ì—°ë½ ë³´ë“œì— í‘œì‹œ
    function displayWorkNotices(notices) {
      const board = document.getElementById('workNoticeBoard');
      const count = document.getElementById('workNoticeCount');

      count.textContent = notices.length;

      if (!notices || notices.length === 0) {
        board.innerHTML = `
          <div class="board-empty">
            <div class="board-empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ì—…ë¬´ì—°ë½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      let html = '';
      notices.forEach(function(notice) {
        const isImportant = notice.isImportant === 'Y';
        const borderColor = isImportant ? '#f44336' : '#673ab7';
        const icon = isImportant ? 'ğŸ”´' : 'ğŸ’¼';

        html += `
          <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid ${borderColor}; background: #f9f9f9; border-radius: 4px; cursor: pointer;" onclick="showWorkNoticeDetail('${notice.id}', '${notice.title.replace(/'/g, "\\'")}', '${notice.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${notice.author}', '${notice.createdAt}')">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
              <div style="font-weight: 600; font-size: 14px; color: #333; flex: 1;">${icon} ${notice.title}</div>
              <div style="font-size: 11px; color: #999;">${notice.createdAt.split(' ')[0]}</div>
            </div>
            <div style="font-size: 12px; color: #666; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${notice.content}</div>
          </div>
        `;
      });

      board.innerHTML = html;
    }

    // ì—…ë¬´ì—°ë½ ìƒì„¸ ë³´ê¸°
    function showWorkNoticeDetail(id, title, content, author, createdAt) {
      const contentFormatted = content.replace(/\\n/g, '\n').replace(/\\'/g, "'");
      alert(`ğŸ“ ${title}\n\n${contentFormatted}\n\nì‘ì„±ì: ${author}\nì‘ì„±ì¼: ${createdAt}`);
    }

    // ì—…ë¬´ì—°ë½ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸° (ê´€ë¦¬ììš©)
    function showWorkNoticeManageModal() {
      document.getElementById('workNoticeManageModal').style.display = 'block';
      loadAllWorkNotices();
    }

    // ì—…ë¬´ì—°ë½ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeWorkNoticeManageModal() {
      document.getElementById('workNoticeManageModal').style.display = 'none';
    }

    // ì „ì²´ ì—…ë¬´ì—°ë½ ë¡œë“œ (ê´€ë¦¬ììš©)
    function loadAllWorkNotices() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayWorkNoticeList(response.data);
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ë¬´ì—°ë½ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ì—…ë¬´ì—°ë½ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .getAllWorkNotices(sessionToken);
    }

    // ì—…ë¬´ì—°ë½ ëª©ë¡ í‘œì‹œ (ê´€ë¦¬ììš©)
    function displayWorkNoticeList(notices) {
      const container = document.getElementById('workNoticeListContainer');

      if (!notices || notices.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ ì—…ë¬´ì—°ë½ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      let html = `
        <table style="width: 100%; border-collapse: collapse; background: white;">
          <thead style="background-color: #f8f9fa;">
            <tr>
              <th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 15%;">ëŒ€ìƒì—…ì²´</th>
              <th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">ì œëª©</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 10%;">ì¤‘ìš”</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 12%;">ê²Œì‹œê¸°ê°„</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 8%;">ìƒíƒœ</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 15%;">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
      `;

      notices.forEach(function(notice) {
        const isActive = notice.isActive === 'Y';
        const isImportant = notice.isImportant === 'Y';
        const period = (notice.startDate || '-') + ' ~ ' + (notice.endDate || '-');

        html += `
          <tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${notice.targetCompany}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${notice.title}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${isImportant ? 'ğŸ”´' : '-'}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 12px; text-align: center;">${period}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <span style="padding: 4px 8px; background: ${isActive ? '#4caf50' : '#9e9e9e'}; color: white; border-radius: 4px; font-size: 11px;">${isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}</span>
            </td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <button onclick='editWorkNotice(${notice.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; background: #ffc107; color: white;">âœï¸ ìˆ˜ì •</button>
              <button onclick='deleteWorkNotice(${notice.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #f44336; color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ì—…ë¬´ì—°ë½ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function showWorkNoticeEditModal() {
      document.getElementById('workNoticeEditTitle').textContent = 'ì—…ë¬´ì—°ë½ ì¶”ê°€';
      document.getElementById('workNoticeRowIndex').value = '';
      document.getElementById('workNoticeTitle').value = '';
      document.getElementById('workNoticeContent').value = '';
      document.getElementById('workNoticeStartDate').value = '';
      document.getElementById('workNoticeEndDate').value = '';
      document.getElementById('workNoticeImportant').checked = false;
      document.getElementById('workNoticeActive').checked = true;

      // ëŒ€ìƒì—…ì²´ ëª©ë¡ ë¡œë“œ í›„ ì´ˆê¸°í™”
      loadWorkNoticeTargetCompanies(function() {
        setSelectedCompanies(''); // ëª¨ë“  ì²´í¬ë°•ìŠ¤ í•´ì œ
      });

      document.getElementById('workNoticeEditModal').style.display = 'block';
    }

    // ì—…ë¬´ì—°ë½ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeWorkNoticeEditModal() {
      document.getElementById('workNoticeEditModal').style.display = 'none';
    }

    // ì—…ë¬´ì—°ë½ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editWorkNotice(rowIndex) {
      // í•´ë‹¹ í–‰ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const notice = response.data.find(n => n.rowIndex === rowIndex);
            if (notice) {
              document.getElementById('workNoticeEditTitle').textContent = 'ì—…ë¬´ì—°ë½ ìˆ˜ì •';
              document.getElementById('workNoticeRowIndex').value = notice.rowIndex;
              document.getElementById('workNoticeTitle').value = notice.title;
              document.getElementById('workNoticeContent').value = notice.content;
              document.getElementById('workNoticeStartDate').value = notice.startDate;
              document.getElementById('workNoticeEndDate').value = notice.endDate;
              document.getElementById('workNoticeImportant').checked = notice.isImportant === 'Y';
              document.getElementById('workNoticeActive').checked = notice.isActive === 'Y';

              // ëŒ€ìƒì—…ì²´ ëª©ë¡ ë¡œë“œ í›„ ê¸°ì¡´ ì„ íƒ ë³µì›
              loadWorkNoticeTargetCompanies(function() {
                setSelectedCompanies(notice.targetCompany);
              });

              document.getElementById('workNoticeEditModal').style.display = 'block';
            }
          }
        })
        .getAllWorkNotices(sessionToken);
    }

    // ì—…ë¬´ì—°ë½ ì €ì¥
    function saveWorkNotice() {
      const rowIndex = document.getElementById('workNoticeRowIndex').value;
      const title = document.getElementById('workNoticeTitle').value.trim();
      const content = document.getElementById('workNoticeContent').value.trim();
      const targetCompany = getSelectedCompanies(); // ì„ íƒëœ ì—…ì²´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
      const startDate = document.getElementById('workNoticeStartDate').value;
      const endDate = document.getElementById('workNoticeEndDate').value;
      const isImportant = document.getElementById('workNoticeImportant').checked ? 'Y' : 'N';
      const isActive = document.getElementById('workNoticeActive').checked ? 'Y' : 'N';

      if (!title || !content || !targetCompany) {
        alert('ì œëª©, ë‚´ìš©, ëŒ€ìƒì—…ì²´ëŠ” í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      const noticeData = {
        title: title,
        content: content,
        targetCompany: targetCompany,
        startDate: startDate,
        endDate: endDate,
        isImportant: isImportant,
        isActive: isActive
      };

      if (rowIndex) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ì—…ë¬´ì—°ë½ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeWorkNoticeEditModal();
              loadAllWorkNotices();
              loadActiveWorkNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
            } else {
              alert(response.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì—…ë¬´ì—°ë½ ìˆ˜ì • ì‹¤íŒ¨:', error);
            alert('ì—…ë¬´ì—°ë½ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .updateWorkNotice(sessionToken, parseInt(rowIndex), noticeData);
      } else {
        // ì¶”ê°€
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ì—…ë¬´ì—°ë½ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeWorkNoticeEditModal();
              loadAllWorkNotices();
              loadActiveWorkNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
            } else {
              alert(response.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('ì—…ë¬´ì—°ë½ ë“±ë¡ ì‹¤íŒ¨:', error);
            alert('ì—…ë¬´ì—°ë½ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .addWorkNotice(sessionToken, noticeData);
      }
    }

    // ì—…ë¬´ì—°ë½ ì‚­ì œ
    function deleteWorkNotice(rowIndex) {
      if (!confirm('ì´ ì—…ë¬´ì—°ë½ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ì—…ë¬´ì—°ë½ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAllWorkNotices();
            loadActiveWorkNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ë¬´ì—°ë½ ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ì—…ë¬´ì—°ë½ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .deleteWorkNotice(sessionToken, rowIndex);
    }

    // ëŒ€ìƒì—…ì²´ ëª©ë¡ ë¡œë“œ
    function loadWorkNoticeTargetCompanies(callback) {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const companyListDiv = document.getElementById('workNoticeCompanyList');
            companyListDiv.innerHTML = ''; // ì´ˆê¸°í™”

            // ì—…ì²´ ëª©ë¡ ì¶”ê°€ (ì²´í¬ë°•ìŠ¤ë¡œ)
            if (response.companies && response.companies.length > 0) {
              response.companies.forEach(function(companyName) {
                const label = document.createElement('label');
                label.style.cssText = 'display: flex; align-items: center; cursor: pointer; padding: 5px; margin-bottom: 5px;';

                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'company-checkbox';
                checkbox.value = companyName;
                checkbox.style.cssText = 'margin-right: 8px; width: 16px; height: 16px;';
                checkbox.onchange = function() { updateAllCheckbox(); };

                const span = document.createElement('span');
                span.textContent = companyName;
                span.style.cssText = 'font-size: 14px; color: #333;';

                label.appendChild(checkbox);
                label.appendChild(span);
                companyListDiv.appendChild(label);
              });
            } else {
              companyListDiv.innerHTML = '<p style="color: #999; font-size: 13px;">ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            }

            if (callback) callback();
          }
        })
        .withFailureHandler(function(error) {
          console.error('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ì—…ì²´ ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getCompanyList(sessionToken);
    }

    // ì „ì²´ ì—…ì²´ ì„ íƒ/í•´ì œ
    function toggleAllCompanies(allCheckbox) {
      const companyCheckboxes = document.querySelectorAll('.company-checkbox');
      companyCheckboxes.forEach(function(checkbox) {
        checkbox.checked = allCheckbox.checked;
        checkbox.disabled = allCheckbox.checked;
      });
    }

    // ê°œë³„ ì²´í¬ë°•ìŠ¤ ìƒíƒœì— ë”°ë¼ ì „ì²´ ì²´í¬ë°•ìŠ¤ ì—…ë°ì´íŠ¸
    function updateAllCheckbox() {
      const allCheckbox = document.getElementById('workNoticeTargetAll');
      const companyCheckboxes = document.querySelectorAll('.company-checkbox');
      const checkedCount = Array.from(companyCheckboxes).filter(cb => cb.checked).length;

      if (checkedCount === companyCheckboxes.length && companyCheckboxes.length > 0) {
        allCheckbox.checked = true;
      } else {
        allCheckbox.checked = false;
      }
    }

    // ì„ íƒëœ ì—…ì²´ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
    function getSelectedCompanies() {
      const allCheckbox = document.getElementById('workNoticeTargetAll');

      if (allCheckbox.checked) {
        return 'ì „ì²´';
      }

      const companyCheckboxes = document.querySelectorAll('.company-checkbox:checked');
      const selectedCompanies = Array.from(companyCheckboxes).map(cb => cb.value);

      return selectedCompanies.join(', ');
    }

    // ì—…ì²´ ì²´í¬ë°•ìŠ¤ ì„¤ì • (ìˆ˜ì • ì‹œ)
    function setSelectedCompanies(targetCompany) {
      // ì´ˆê¸°í™”
      const allCheckbox = document.getElementById('workNoticeTargetAll');
      allCheckbox.checked = false;
      const companyCheckboxes = document.querySelectorAll('.company-checkbox');
      companyCheckboxes.forEach(cb => {
        cb.checked = false;
        cb.disabled = false;
      });

      if (!targetCompany) return;

      if (targetCompany === 'ì „ì²´' || targetCompany.includes('ì „ì²´')) {
        allCheckbox.checked = true;
        companyCheckboxes.forEach(cb => {
          cb.checked = true;
          cb.disabled = true;
        });
      } else {
        // ì‰¼í‘œë¡œ êµ¬ë¶„ëœ ì—…ì²´ëª… ëª©ë¡
        const companies = targetCompany.split(',').map(c => c.trim());
        companyCheckboxes.forEach(cb => {
          if (companies.includes(cb.value)) {
            cb.checked = true;
          }
        });
      }
    }

    // ========== ê³µì§€ì‚¬í•­ ê´€ë¦¬ í•¨ìˆ˜ë“¤ ==========

    // í™œì„± ê³µì§€ì‚¬í•­ ë¡œë“œ (ì‚¬ìš©ììš© - ì „ì²´ ì—…ì²´)
    function loadActiveNotices() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayNotices(response.data);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
        })
        .getActiveNotices(sessionToken);
    }

    // ê³µì§€ì‚¬í•­ ë³´ë“œì— í‘œì‹œ
    function displayNotices(notices) {
      const board = document.getElementById('noticeBoard');
      const count = document.getElementById('noticeCount');

      count.textContent = notices.length;

      if (!notices || notices.length === 0) {
        board.innerHTML = `
          <div class="board-empty">
            <div class="board-empty-icon">ğŸ“­</div>
            <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      let html = '';
      notices.forEach(function(notice) {
        const isImportant = notice.isImportant === 'Y';
        const borderColor = isImportant ? '#f44336' : '#ff5722';
        const icon = isImportant ? 'ğŸ”´' : 'ğŸ“¢';

        html += `
          <div style="padding: 12px; margin-bottom: 10px; border-left: 4px solid ${borderColor}; background: #f9f9f9; border-radius: 4px; cursor: pointer;" onclick="showNoticeDetail('${notice.id}', '${notice.title.replace(/'/g, "\\'")}', '${notice.content.replace(/'/g, "\\'").replace(/\n/g, "\\n")}', '${notice.author}', '${notice.createdAt}')">
            <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 5px;">
              <div style="font-weight: 600; font-size: 14px; color: #333; flex: 1;">${icon} ${notice.title}</div>
              <div style="font-size: 11px; color: #999;">${notice.createdAt.split(' ')[0]}</div>
            </div>
            <div style="font-size: 12px; color: #666; line-height: 1.5; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${notice.content}</div>
          </div>
        `;
      });

      board.innerHTML = html;
    }

    // ê³µì§€ì‚¬í•­ ìƒì„¸ ë³´ê¸°
    function showNoticeDetail(id, title, content, author, createdAt) {
      const contentFormatted = content.replace(/\\n/g, '\n').replace(/\\'/g, "'");
      alert(`ğŸ“¢ ${title}\n\n${contentFormatted}\n\nì‘ì„±ì: ${author}\nì‘ì„±ì¼: ${createdAt}`);
    }

    // ê³µì§€ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬ ì—´ê¸° (ê´€ë¦¬ììš©)
    function showNoticeManageModal() {
      document.getElementById('noticeManageModal').style.display = 'block';
      loadAllNotices();
    }

    // ê³µì§€ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬ ë‹«ê¸°
    function closeNoticeManageModal() {
      document.getElementById('noticeManageModal').style.display = 'none';
    }

    // ì „ì²´ ê³µì§€ì‚¬í•­ ë¡œë“œ (ê´€ë¦¬ììš©)
    function loadAllNotices() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            displayNoticeList(response.data);
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê³µì§€ì‚¬í•­ ë¡œë“œ ì‹¤íŒ¨:', error);
          alert('ê³µì§€ì‚¬í•­ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .getAllNotices(sessionToken);
    }

    // ê³µì§€ì‚¬í•­ ëª©ë¡ í‘œì‹œ (ê´€ë¦¬ììš©)
    function displayNoticeList(notices) {
      const container = document.getElementById('noticeListContainer');

      if (!notices || notices.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; color: #999;">
            <div style="font-size: 64px; margin-bottom: 15px;">ğŸ“­</div>
            <p>ë“±ë¡ëœ ê³µì§€ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      let html = `
        <table style="width: 100%; border-collapse: collapse; background: white;">
          <thead style="background-color: #f8f9fa;">
            <tr>
              <th style="padding: 12px; text-align: left; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px;">ì œëª©</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 10%;">ì¤‘ìš”</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 15%;">ê²Œì‹œê¸°ê°„</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 8%;">ìƒíƒœ</th>
              <th style="padding: 12px; text-align: center; font-weight: 600; color: #555; border-bottom: 2px solid #e0e0e0; font-size: 14px; width: 15%;">ì‘ì—…</th>
            </tr>
          </thead>
          <tbody>
      `;

      notices.forEach(function(notice) {
        const isActive = notice.isActive === 'Y';
        const isImportant = notice.isImportant === 'Y';
        const period = (notice.startDate || '-') + ' ~ ' + (notice.endDate || '-');

        html += `
          <tr style="transition: background 0.2s;" onmouseover="this.style.backgroundColor='#f9f9f9'" onmouseout="this.style.backgroundColor=''">
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px;">${notice.title}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">${isImportant ? 'ğŸ”´' : '-'}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 12px; text-align: center;">${period}</td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <span style="padding: 4px 8px; background: ${isActive ? '#4caf50' : '#9e9e9e'}; color: white; border-radius: 4px; font-size: 11px;">${isActive ? 'í™œì„±' : 'ë¹„í™œì„±'}</span>
            </td>
            <td style="padding: 12px; border-bottom: 1px solid #f0f0f0; font-size: 14px; text-align: center;">
              <button onclick='editNotice(${notice.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; margin-right: 5px; background: #ffc107; color: white;">âœï¸ ìˆ˜ì •</button>
              <button onclick='deleteNotice(${notice.rowIndex})' style="padding: 6px 12px; font-size: 12px; border-radius: 6px; border: none; cursor: pointer; background: #f44336; color: white;">ğŸ—‘ï¸ ì‚­ì œ</button>
            </td>
          </tr>
        `;
      });

      html += '</tbody></table>';
      container.innerHTML = html;
    }

    // ê³µì§€ì‚¬í•­ ì¶”ê°€ ëª¨ë‹¬ ì—´ê¸°
    function showNoticeEditModal() {
      document.getElementById('noticeEditTitle').textContent = 'ê³µì§€ì‚¬í•­ ì¶”ê°€';
      document.getElementById('noticeRowIndex').value = '';
      document.getElementById('noticeTitle').value = '';
      document.getElementById('noticeContent').value = '';
      document.getElementById('noticeStartDate').value = '';
      document.getElementById('noticeEndDate').value = '';
      document.getElementById('noticeImportant').checked = false;
      document.getElementById('noticeActive').checked = true;

      document.getElementById('noticeEditModal').style.display = 'block';
    }

    // ê³µì§€ì‚¬í•­ ì¶”ê°€/ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
    function closeNoticeEditModal() {
      document.getElementById('noticeEditModal').style.display = 'none';
    }

    // ê³µì§€ì‚¬í•­ ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸°
    function editNotice(rowIndex) {
      // í•´ë‹¹ í–‰ì˜ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¤ê¸°
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const notice = response.data.find(n => n.rowIndex === rowIndex);
            if (notice) {
              document.getElementById('noticeEditTitle').textContent = 'ê³µì§€ì‚¬í•­ ìˆ˜ì •';
              document.getElementById('noticeRowIndex').value = notice.rowIndex;
              document.getElementById('noticeTitle').value = notice.title;
              document.getElementById('noticeContent').value = notice.content;
              document.getElementById('noticeStartDate').value = notice.startDate;
              document.getElementById('noticeEndDate').value = notice.endDate;
              document.getElementById('noticeImportant').checked = notice.isImportant === 'Y';
              document.getElementById('noticeActive').checked = notice.isActive === 'Y';

              document.getElementById('noticeEditModal').style.display = 'block';
            }
          }
        })
        .getAllNotices(sessionToken);
    }

    // ê³µì§€ì‚¬í•­ ì €ì¥
    function saveNotice() {
      const rowIndex = document.getElementById('noticeRowIndex').value;
      const title = document.getElementById('noticeTitle').value.trim();
      const content = document.getElementById('noticeContent').value.trim();
      const startDate = document.getElementById('noticeStartDate').value;
      const endDate = document.getElementById('noticeEndDate').value;
      const isImportant = document.getElementById('noticeImportant').checked ? 'Y' : 'N';
      const isActive = document.getElementById('noticeActive').checked ? 'Y' : 'N';

      if (!title || !content) {
        alert('ì œëª©ê³¼ ë‚´ìš©ì€ í•„ìˆ˜ ì…ë ¥ í•­ëª©ì…ë‹ˆë‹¤.');
        return;
      }

      const noticeData = {
        title: title,
        content: content,
        startDate: startDate,
        endDate: endDate,
        isImportant: isImportant,
        isActive: isActive
      };

      if (rowIndex) {
        // ìˆ˜ì •
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ê³µì§€ì‚¬í•­ì´ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeNoticeEditModal();
              loadAllNotices();
              loadActiveNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
            } else {
              alert(response.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì‹¤íŒ¨:', error);
            alert('ê³µì§€ì‚¬í•­ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .updateNotice(sessionToken, parseInt(rowIndex), noticeData);
      } else {
        // ì¶”ê°€
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              alert('ê³µì§€ì‚¬í•­ì´ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.');
              closeNoticeEditModal();
              loadAllNotices();
              loadActiveNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
            } else {
              alert(response.message);
            }
          })
          .withFailureHandler(function(error) {
            console.error('ê³µì§€ì‚¬í•­ ë“±ë¡ ì‹¤íŒ¨:', error);
            alert('ê³µì§€ì‚¬í•­ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
          })
          .addNotice(sessionToken, noticeData);
      }
    }

    // ê³µì§€ì‚¬í•­ ì‚­ì œ
    function deleteNotice(rowIndex) {
      if (!confirm('ì´ ê³µì§€ì‚¬í•­ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        return;
      }

      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            alert('ê³µì§€ì‚¬í•­ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
            loadAllNotices();
            loadActiveNotices(); // ì‚¬ìš©ì ë³´ë“œë„ ì—…ë°ì´íŠ¸
          } else {
            alert(response.message);
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê³µì§€ì‚¬í•­ ì‚­ì œ ì‹¤íŒ¨:', error);
          alert('ê³µì§€ì‚¬í•­ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .deleteNotice(sessionToken, rowIndex);
    }

    // ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­ ì‹œ ë‹«ê¸°
    window.onclick = function(event) {
      // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const inspectionResultModal = document.getElementById('inspectionResultModal');
      if (event.target === inspectionResultModal) {
        closeInspectionResultModal();
      }

      // ë¹„ë°€ë²ˆí˜¸ ë³€ê²½ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const passwordModal = document.getElementById('changePasswordModal');
      if (event.target === passwordModal) {
        closeChangePasswordModal();
      }

      // Item ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const itemModal = document.getElementById('itemModal');
      if (event.target === itemModal) {
        closeItemModal();
      }

      // ì—…ë¬´ì—°ë½ ê´€ë¦¬ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const workNoticeManageModal = document.getElementById('workNoticeManageModal');
      if (event.target === workNoticeManageModal) {
        closeWorkNoticeManageModal();
      }

      // ì—…ë¬´ì—°ë½ ìˆ˜ì • ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const workNoticeEditModal = document.getElementById('workNoticeEditModal');
      if (event.target === workNoticeEditModal) {
        closeWorkNoticeEditModal();
      }

      // ê³µì§€ì‚¬í•­ ê´€ë¦¬ ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const noticeManageModal = document.getElementById('noticeManageModal');
      if (event.target === noticeManageModal) {
        closeNoticeManageModal();
      }

      // ê³µì§€ì‚¬í•­ ìˆ˜ì • ëª¨ë‹¬ ì™¸ë¶€ í´ë¦­
      const noticeEditModal = document.getElementById('noticeEditModal');
      if (event.target === noticeEditModal) {
        closeNoticeEditModal();
      }
    };
  </script>
</body>
</html>
