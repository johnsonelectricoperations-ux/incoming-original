<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì„±ì ì„œ ì…ë ¥ - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f7fa;
      color: #333;
    }
    
    .header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px 30px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    
    .header-content {
      max-width: 1400px;
      margin: 0 auto;
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .header-title h1 {
      font-size: 24px;
      margin-bottom: 5px;
    }
    
    .header-title p {
      font-size: 14px;
      opacity: 0.9;
    }
    
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      text-decoration: none;
      display: inline-block;
    }
    
    .btn-outline {
      background: transparent;
      color: white;
      border: 2px solid white;
    }
    
    .btn-outline:hover {
      background: white;
      color: #667eea;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
      padding: 30px 20px;
    }
    
    .nav-menu {
      background: white;
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
    }
    
    .nav-btn {
      padding: 12px 24px;
      background: #f0f4ff;
      color: #667eea;
      border: 2px solid transparent;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .nav-btn:hover {
      background: #667eea;
      color: white;
      transform: translateY(-2px);
    }
    
    .nav-btn.active {
      background: #667eea;
      color: white;
    }
    
    .form-container {
      background: white;
      border-radius: 12px;
      padding: 30px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    
    .form-title {
      font-size: 20px;
      font-weight: bold;
      color: #333;
      margin-bottom: 25px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-label {
      display: block;
      font-weight: 600;
      color: #333;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .required {
      color: #e74c3c;
    }
    
    .form-control {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .form-control:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    select.form-control {
      cursor: pointer;
    }

    /* TM-NO ìë™ì™„ì„± ìŠ¤íƒ€ì¼ */
    .autocomplete-results {
      position: absolute;
      z-index: 1000;
      width: 100%;
      max-height: 200px;
      overflow-y: auto;
      background: white;
      border: 2px solid #667eea;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      margin-top: 4px;
      display: none;
    }

    .autocomplete-item {
      padding: 12px 15px;
      cursor: pointer;
      border-bottom: 1px solid #f0f0f0;
      transition: background 0.2s;
    }

    .autocomplete-item:hover {
      background-color: #f0f4ff;
    }

    .autocomplete-item:last-child {
      border-bottom: none;
    }

    .autocomplete-tmno {
      font-weight: 600;
      color: #667eea;
      margin-bottom: 4px;
    }

    .autocomplete-product {
      font-size: 13px;
      color: #666;
    }

    .file-upload-wrapper {
      position: relative;
      overflow: hidden;
      display: inline-block;
      width: 100%;
    }
    
    .file-upload-btn {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      padding: 40px;
      border: 2px dashed #ccc;
      border-radius: 8px;
      background: #f8f9fa;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    
    .file-upload-btn:hover {
      border-color: #667eea;
      background: #f0f4ff;
    }
    
    .file-upload-btn.dragover {
      border-color: #667eea;
      background: #e8f0fe;
    }
    
    .file-input {
      position: absolute;
      left: 0;
      top: 0;
      opacity: 0;
      width: 100%;
      height: 100%;
      cursor: pointer;
    }
    
    .file-info {
      margin-top: 10px;
      padding: 10px;
      background: #e8f5e9;
      border-radius: 8px;
      color: #2e7d32;
      font-size: 13px;
      display: none;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .alert-error {
      background-color: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }
    
    .alert-success {
      background-color: #efe;
      border: 1px solid #cfc;
      color: #3c3;
    }
    
    .btn-submit {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
      margin-top: 20px;
    }
    
    .btn-submit:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-submit:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 9999;
      justify-content: center;
      align-items: center;
    }
    
    .loading-content {
      background: white;
      padding: 40px;
      border-radius: 12px;
      text-align: center;
    }
    
    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #667eea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .form-help {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }
    
    @media (max-width: 768px) {
      .container {
        padding: 20px 15px;
      }
      
      .form-container {
        padding: 20px;
      }
      
      .nav-menu {
        flex-direction: column;
      }
      
      .nav-btn {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <div class="header-title">
        <h1>í˜‘ë ¥ì‚¬ ìˆ˜ì…ê²€ì‚¬ ê´€ë¦¬</h1>
        <p id="userInfo">ë¡œë”© ì¤‘...</p>
      </div>
      <div class="header-actions">
        <button class="btn btn-outline" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
      </div>
    </div>
  </div>
  
  <div class="container">
    <?!= include('Navigation') ?>
    
    <div class="form-container">
      <h2 class="form-title">ê²€ì‚¬ì„±ì ì„œ ë“±ë¡</h2>
      
      <div id="alertBox" class="alert"></div>
      
      <form id="dataForm" onsubmit="handleSubmit(event)">
        <div class="form-group">
          <label class="form-label">ì…ê³ ë‚ ì§œ <span class="required">*</span></label>
          <input type="date" class="form-control" id="inputDate" required>
        </div>
        
        <div class="form-group">
          <label class="form-label">ì…ê³ ì‹œê°„ <span class="required">*</span></label>
          <select class="form-control" id="inputTime" required>
            <option value="">ì‹œê°„ ì„ íƒ</option>
          </select>
        </div>
        
        <div class="form-group">
          <label class="form-label">TM-NO <span class="required">*</span></label>
          <input type="text" class="form-control" id="inputTmNo" placeholder="TM-NOë¥¼ ì…ë ¥í•˜ì„¸ìš”" required autocomplete="off">
          <div id="tmNoAutocomplete" class="autocomplete-results"></div>
        </div>

        <div class="form-group">
          <label class="form-label">ì œí’ˆëª… <span class="required">*</span></label>
          <input type="text" class="form-control" id="inputProductName" placeholder="ì œí’ˆëª…ì´ ìë™ìœ¼ë¡œ ì…ë ¥ë©ë‹ˆë‹¤" readonly style="background-color: #f5f5f5;">
        </div>

        <!-- ê²€ì‚¬ê·œê²© ìƒíƒœ í‘œì‹œ -->
        <div class="form-group" id="specStatusGroup" style="display: none;">
          <label class="form-label">ê²€ì‚¬ê·œê²© ìƒíƒœ</label>
          <div id="specStatusIndicator" style="padding: 12px 15px; border-radius: 8px; font-size: 14px; font-weight: 600; text-align: center;">
            <span id="specStatusText">-</span>
          </div>
        </div>

        <div class="form-group">
          <label class="form-label">ìˆ˜ëŸ‰ <span class="required">*</span></label>
          <input type="text" class="form-control" id="inputQuantity" placeholder="ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”" required inputmode="numeric" pattern="[0-9,]*">
        </div>

        <div class="form-group">
          <label class="form-label">ê²€ì‚¬ì„±ì ì„œ PDF <span class="required">*</span></label>
          <div class="file-upload-wrapper">
            <div class="file-upload-btn" id="fileUploadBtn">
              <span>ğŸ“ í´ë¦­ ë˜ëŠ” ë“œë˜ê·¸í•˜ì—¬ PDF íŒŒì¼ ì—…ë¡œë“œ</span>
            </div>
            <input type="file" class="file-input" id="fileInput" accept=".pdf" required>
          </div>
          <div class="file-info" id="fileInfo"></div>
          <div class="form-help">ìµœëŒ€ 10MBê¹Œì§€ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤. (í•„ìˆ˜)</div>
        </div>
        
        <button type="submit" class="btn-submit" id="btnSubmit">ë“±ë¡í•˜ê¸°</button>
      </form>
    </div>
  </div>
  
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-content">
      <div class="spinner"></div>
      <p>ë°ì´í„°ë¥¼ ì €ì¥í•˜ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
    </div>
  </div>
  
  <script>
    // ===== í† í° ê´€ë¦¬ =====
    let sessionToken = null;
    let hasInspectionSpecs = false; // ê²€ì‚¬ê·œê²© ì¡´ì¬ ì—¬ë¶€

    // í† í° ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° ë˜ëŠ” sessionStorageì—ì„œ)
    function initToken() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° (í…œí”Œë¦¿ ë³€ìˆ˜)
      const serverToken = '<?!= token ?>';

      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        sessionToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (ì„œë²„ì—ì„œ ì „ë‹¬)');
      } else {
        // sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        sessionToken = sessionStorage.getItem('sessionToken');
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (sessionStorage)');
      }

      if (!sessionToken) {
        console.error('í† í° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        redirectToLogin();
      }

      return sessionToken;
    }

    // ì•ˆì „í•œ í˜ì´ì§€ ì´ë™ (iframe ìƒŒë“œë°•ìŠ¤ í˜¸í™˜)
    // ì—¬ëŸ¬ ë°©ë²•ì„ í´ë°±ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ìƒŒë“œë°•ìŠ¤ ì œì•½ ìš°íšŒ
    function safeNavigate(url, params) {
      // Query string ìƒì„±
      let fullUrl = url;
      if (params) {
        const queryString = Object.keys(params)
          .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
          .join('&');
        fullUrl = url + '?' + queryString;
      }

      // ë°©ë²• 1: window.top.location.href ì‹œë„ (ê°€ì¥ ì„ í˜¸)
      try {
        window.top.location.href = fullUrl;
        return;
      } catch (e) {
        console.warn('window.top.location.href ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 2: window.location.replace ì‹œë„
      try {
        window.location.replace(fullUrl);
        return;
      } catch (e) {
        console.warn('window.location.replace ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 3: meta refresh íƒœê·¸ ì‚¬ìš© (ìµœí›„ì˜ ìˆ˜ë‹¨)
      try {
        const meta = document.createElement('meta');
        meta.httpEquiv = 'refresh';
        meta.content = '0; url=' + fullUrl;
        document.head.appendChild(meta);
        console.log('meta refresh íƒœê·¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
      } catch (e) {
        console.error('ëª¨ë“  ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ë²• ì‹¤íŒ¨:', e.message);
        alert('í˜ì´ì§€ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ìƒˆë¡œê³ ì¹¨í•´ì£¼ì„¸ìš”.');
      }
    }

    // ë¡œê·¸ì¸ í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸
    function redirectToLogin() {
      sessionStorage.removeItem('sessionToken');
      safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
    }

    let selectedFile = null;

    window.onload = function() {
      initToken();
      loadUserInfo();
      initializeForm();
      setupFileUpload();
      setupTmNoAutocomplete();
      setupQuantityFormat();
    };

    // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™” í•¨ìˆ˜
    function initNavigation(currentPage, userRole) {
      const navButtons = {
        'dashboard': 'navDashboard',
        'entry': 'navEntry',
        'history': 'navHistory',
        'certificate': 'navCertificate'
      };

      if (navButtons[currentPage]) {
        const btn = document.getElementById(navButtons[currentPage]);
        if (btn) {
          btn.classList.add('active');
        }
      }

      // Item ë“±ë¡ ë²„íŠ¼ì€ ëŒ€ì‹œë³´ë“œì—ì„œë§Œ í‘œì‹œ
      const itemBtn = document.getElementById('navItem');
      if (itemBtn) {
        itemBtn.style.display = 'none';
      }

      // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionResultBtn = document.getElementById('navInspectionResult');
      if (inspectionResultBtn) {
        inspectionResultBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // ê²€ì‚¬ê²°ê³¼ì´ë ¥ ë²„íŠ¼ì€ ê´€ë¦¬ì ë˜ëŠ” JEOë§Œ í‘œì‹œ
      const inspectionHistoryBtn = document.getElementById('navInspectionHistory');
      if (inspectionHistoryBtn) {
        inspectionHistoryBtn.style.display = (userRole === 'ê´€ë¦¬ì' || userRole === 'JEO') ? 'inline-block' : 'none';
      }

      // JEOëŠ” ì„±ì ì„œì…ë ¥, ì´ë ¥ê´€ë¦¬, í™•ì¸ì¦ì¶œë ¥ ë²„íŠ¼ ìˆ¨ê¹€
      const entryBtn = document.getElementById('navEntry');
      if (entryBtn) {
        entryBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const historyBtn = document.getElementById('navHistory');
      if (historyBtn) {
        historyBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      const certificateBtn = document.getElementById('navCertificate');
      if (certificateBtn) {
        certificateBtn.style.display = (userRole === 'JEO') ? 'none' : 'inline-block';
      }

      // ì‚¬ìš©ì ê´€ë¦¬ ë²„íŠ¼ì€ ê´€ë¦¬ìë§Œ í‘œì‹œ
      const usersBtn = document.getElementById('navUsers');
      if (usersBtn) {
        usersBtn.style.display = (userRole === 'ê´€ë¦¬ì') ? 'inline-block' : 'none';
      }

      // ë„¤ë¹„ê²Œì´ì…˜ ë©”ë‰´ í‘œì‹œ (ë¶€ë“œëŸ¬ìš´ fade-in íš¨ê³¼)
      const navMenu = document.getElementById('navMenu');
      if (navMenu) {
        navMenu.style.opacity = '1';
      }
    }

    // Item í´ë¦­ í•¸ë“¤ëŸ¬
    function handleItemClick() {
      goToPage('dashboard');
    }

    function loadUserInfo() {
      google.script.run
        .withSuccessHandler(function(response) {
          if (response.success) {
            const user = response.user;
            document.getElementById('userInfo').textContent =
              `${user.companyName} | ${user.name} (${user.role})`;

            // ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initNavigation('entry', user.role);
          } else {
            redirectToLogin();
          }
        })
        .getCurrentUserByToken(sessionToken);
    }
    
    function initializeForm() {
      // ì˜¤ëŠ˜ ë‚ ì§œ ì„¤ì •
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inputDate').value = today;
      
      // ì‹œê°„ ì˜µì…˜ ìƒì„± (ì˜¤ì „/ì˜¤í›„)
      const timeSelect = document.getElementById('inputTime');
      
      const option1 = document.createElement('option');
      option1.value = 'ì˜¤ì „';
      option1.textContent = 'ì˜¤ì „';
      timeSelect.appendChild(option1);
      
      const option2 = document.createElement('option');
      option2.value = 'ì˜¤í›„';
      option2.textContent = 'ì˜¤í›„';
      timeSelect.appendChild(option2);
    }
    
    function setupFileUpload() {
      const fileInput = document.getElementById('fileInput');
      const fileUploadBtn = document.getElementById('fileUploadBtn');
      
      // íŒŒì¼ ì„ íƒ ì´ë²¤íŠ¸
      fileInput.addEventListener('change', handleFileSelect);
      
      // ë“œë˜ê·¸ ì•¤ ë“œë¡­
      fileUploadBtn.addEventListener('dragover', function(e) {
        e.preventDefault();
        fileUploadBtn.classList.add('dragover');
      });
      
      fileUploadBtn.addEventListener('dragleave', function(e) {
        e.preventDefault();
        fileUploadBtn.classList.remove('dragover');
      });
      
      fileUploadBtn.addEventListener('drop', function(e) {
        e.preventDefault();
        fileUploadBtn.classList.remove('dragover');
        
        if (e.dataTransfer.files.length > 0) {
          fileInput.files = e.dataTransfer.files;
          handleFileSelect({ target: fileInput });
        }
      });
    }
    
    function handleFileSelect(e) {
      const file = e.target.files[0];
      
      if (!file) {
        selectedFile = null;
        document.getElementById('fileInfo').style.display = 'none';
        return;
      }
      
      // PDF íŒŒì¼ ì²´í¬
      if (file.type !== 'application/pdf') {
        showAlert('PDF íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤.', 'error');
        e.target.value = '';
        return;
      }
      
      // íŒŒì¼ í¬ê¸° ì²´í¬ (10MB)
      if (file.size > 10 * 1024 * 1024) {
        showAlert('íŒŒì¼ í¬ê¸°ëŠ” 10MBë¥¼ ì´ˆê³¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
        e.target.value = '';
        return;
      }
      
      selectedFile = file;
      
      // íŒŒì¼ ì •ë³´ í‘œì‹œ
      const fileInfo = document.getElementById('fileInfo');
      fileInfo.innerHTML = `ğŸ“„ ${file.name} (${formatFileSize(file.size)})`;
      fileInfo.style.display = 'block';
      
      hideAlert();
    }
    
    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }
    
    function handleSubmit(e) {
      e.preventDefault();

      // ìˆ˜ëŸ‰ì—ì„œ ì½¤ë§ˆ ì œê±° í›„ ì €ì¥
      const quantityValue = document.getElementById('inputQuantity').value.replace(/,/g, '');

      const formData = {
        date: document.getElementById('inputDate').value,
        time: document.getElementById('inputTime').value,
        tmNo: document.getElementById('inputTmNo').value.trim(),
        productName: document.getElementById('inputProductName').value.trim(),
        quantity: quantityValue  // ì½¤ë§ˆê°€ ì œê±°ëœ ìˆ«ìë§Œ ì „ì†¡
      };

      // ìœ íš¨ì„± ê²€ì‚¬
      if (!formData.date || !formData.time || !formData.tmNo ||
          !formData.productName || !formData.quantity) {
        showAlert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      // ê²€ì‚¬ê·œê²© ì¡´ì¬ ì—¬ë¶€ í™•ì¸
      if (!hasInspectionSpecs) {
        showAlert('ì„ íƒí•œ ì œí’ˆì˜ ê²€ì‚¬ê·œê²©ì´ ë“±ë¡ë˜ì–´ ìˆì§€ ì•ŠìŠµë‹ˆë‹¤. ê²€ì‚¬ê·œê²©ì„ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      // PDF íŒŒì¼ í•„ìˆ˜ ì²´í¬
      if (!selectedFile) {
        showAlert('ê²€ì‚¬ì„±ì ì„œ PDF íŒŒì¼ì„ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      // ë¡œë”© í‘œì‹œ
      showLoading();

      // íŒŒì¼ ì—…ë¡œë“œ í›„ ë°ì´í„° ì €ì¥
      uploadFileAndSaveData(formData);
    }
    
    function uploadFileAndSaveData(formData) {
      const reader = new FileReader();

      reader.onload = function(e) {
        const bytes = e.target.result.split(',')[1]; // Base64 ë°ì´í„°

        const fileData = {
          fileName: selectedFile.name,
          mimeType: selectedFile.type,
          bytes: bytes,
          tmNo: formData.tmNo,
          date: formData.date
        };
        
        google.script.run
          .withSuccessHandler(function(response) {
            if (response.success) {
              formData.pdfUrl = response.fileUrl;
              saveData(formData);
            } else {
              hideLoading();
              showAlert(response.message, 'error');
            }
          })
          .withFailureHandler(function(error) {
            hideLoading();
            console.error('íŒŒì¼ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            showAlert('íŒŒì¼ ì—…ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
          })
          .uploadPdfFile(sessionToken, fileData);
      };
      
      reader.readAsDataURL(selectedFile);
    }
    
    function saveData(formData) {
      google.script.run
        .withSuccessHandler(function(response) {
          hideLoading();

          if (response.success) {
            showAlert('ì„±ì ì„œê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
            resetForm();
          } else {
            showAlert(response.message, 'error');
          }
        })
        .withFailureHandler(function(error) {
          hideLoading();
          console.error('ë°ì´í„° ì €ì¥ ì‹¤íŒ¨:', error);
          showAlert('ë°ì´í„° ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .createData(sessionToken, formData);
    }
    
    function resetForm() {
      document.getElementById('dataForm').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('inputDate').value = today;
      selectedFile = null;
      document.getElementById('fileInfo').style.display = 'none';
      document.getElementById('fileInput').value = '';
      hideSpecStatus(); // ê²€ì‚¬ê·œê²© ìƒíƒœ ì´ˆê¸°í™”
    }
    
    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = 'alert alert-' + type;
      alertBox.style.display = 'block';
      
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function hideAlert() {
      document.getElementById('alertBox').style.display = 'none';
    }
    
    function showLoading() {
      document.getElementById('loadingOverlay').style.display = 'flex';
      document.getElementById('btnSubmit').disabled = true;
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').style.display = 'none';
      document.getElementById('btnSubmit').disabled = false;
    }
    
    function goToPage(page) {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': page,
        'token': token,
        't': Date.now()
      });
    }

    // ê²€ì‚¬ê²°ê³¼ë“±ë¡ ëª¨ë‹¬ (Dashboardë¡œ ì´ë™í•˜ë©´ì„œ ìë™ ì—´ê¸°)
    function showInspectionResultModal() {
      const token = sessionStorage.getItem('sessionToken');
      const webAppUrl = '<?= getWebAppUrl() ?>';
      safeNavigate(webAppUrl, {
        'page': 'dashboard',
        'token': token,
        'openInspectionModal': 'true',
        't': Date.now()
      });
    }

    // TM-NO ìë™ì™„ì„± ì„¤ì •
    function setupTmNoAutocomplete() {
      const tmNoInput = document.getElementById('inputTmNo');
      const autocompleteDiv = document.getElementById('tmNoAutocomplete');
      const productNameInput = document.getElementById('inputProductName');
      let searchTimeout;

      // TM-NO ì…ë ¥ ì‹œ ìë™ì™„ì„±
      tmNoInput.addEventListener('input', function(e) {
        const searchText = e.target.value.trim();

        // ê²€ìƒ‰ì–´ê°€ ì—†ìœ¼ë©´ ìë™ì™„ì„± ìˆ¨ê¹€
        if (searchText.length === 0) {
          autocompleteDiv.style.display = 'none';
          productNameInput.value = '';
          hideSpecStatus(); // ê²€ì‚¬ê·œê²© ìƒíƒœë„ ìˆ¨ê¹€
          return;
        }

        // ë””ë°”ìš´ì‹± (300ms ëŒ€ê¸°)
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(function() {
          // ì„œë²„ì—ì„œ TM-NO ê²€ìƒ‰
          google.script.run
            .withSuccessHandler(function(response) {
              if (response.success && response.items && response.items.length > 0) {
                displayAutocompleteResults(response.items);
              } else {
                autocompleteDiv.style.display = 'none';
              }
            })
            .withFailureHandler(function(error) {
              console.error('TM-NO ê²€ìƒ‰ ì‹¤íŒ¨:', error);
              autocompleteDiv.style.display = 'none';
            })
            .searchTmNo(sessionToken, searchText);
        }, 300);
      });

      // ì™¸ë¶€ í´ë¦­ ì‹œ ìë™ì™„ì„± ìˆ¨ê¹€
      document.addEventListener('click', function(e) {
        if (e.target !== tmNoInput && !autocompleteDiv.contains(e.target)) {
          autocompleteDiv.style.display = 'none';
        }
      });
    }

    function setupQuantityFormat() {
      const quantityInput = document.getElementById('inputQuantity');
      
      // ì…ë ¥ ì‹œ ì½¤ë§ˆ ì¶”ê°€
      quantityInput.addEventListener('input', function(e) {
        let value = e.target.value;
        
        // ìˆ«ìë§Œ ì¶”ì¶œ
        value = value.replace(/[^\d]/g, '');
        
        // ì½¤ë§ˆ ì¶”ê°€
        if (value) {
          value = Number(value).toLocaleString('ko-KR');
        }
        
        e.target.value = value;
      });
      
      // í¬ì»¤ìŠ¤ ì•„ì›ƒ ì‹œì—ë„ í¬ë§·íŒ…
      quantityInput.addEventListener('blur', function(e) {
        let value = e.target.value;
        value = value.replace(/[^\d]/g, '');
        if (value) {
          e.target.value = Number(value).toLocaleString('ko-KR');
        }
      });
    }

    // ìë™ì™„ì„± ê²°ê³¼ í‘œì‹œ
    function displayAutocompleteResults(items) {
      const autocompleteDiv = document.getElementById('tmNoAutocomplete');
      autocompleteDiv.innerHTML = '';

      items.forEach(function(item) {
        const itemDiv = document.createElement('div');
        itemDiv.className = 'autocomplete-item';
        itemDiv.innerHTML = `
          <div class="autocomplete-tmno">${item.tmNo}</div>
          <div class="autocomplete-product">${item.productName} <span style="color: #666; font-size: 0.9em;">(${item.companyName})</span></div>
        `;

        itemDiv.addEventListener('click', function() {
          // TM-NOì™€ ì œí’ˆëª… ìë™ ì…ë ¥
          document.getElementById('inputTmNo').value = item.tmNo;
          document.getElementById('inputProductName').value = item.productName;
          autocompleteDiv.style.display = 'none';

          // ê²€ì‚¬ê·œê²© ì¡´ì¬ ì—¬ë¶€ í™•ì¸
          checkInspectionSpecs(item.tmNo, item.companyName);
        });

        autocompleteDiv.appendChild(itemDiv);
      });

      autocompleteDiv.style.display = 'block';
    }

    // ê²€ì‚¬ê·œê²© ì¡´ì¬ ì—¬ë¶€ í™•ì¸
    function checkInspectionSpecs(tmNo, companyName) {
      if (!tmNo || !companyName) {
        hideSpecStatus();
        return;
      }

      // ì„œë²„ì—ì„œ ê²€ì‚¬ê·œê²© ì¡°íšŒ
      google.script.run
        .withSuccessHandler(function(response) {
          const statusGroup = document.getElementById('specStatusGroup');
          const statusIndicator = document.getElementById('specStatusIndicator');
          const statusText = document.getElementById('specStatusText');
          const submitBtn = document.getElementById('btnSubmit');

          statusGroup.style.display = 'block';

          if (response.success && response.data && response.data.length > 0) {
            // ê·œê²©ì´ ë“±ë¡ë˜ì–´ ìˆìŒ
            hasInspectionSpecs = true;
            statusIndicator.style.backgroundColor = '#d4edda';
            statusIndicator.style.borderColor = '#c3e6cb';
            statusIndicator.style.color = '#155724';
            statusText.textContent = 'âœ“ ê·œê²©ë“±ë¡ë˜ì–´ìˆìŒ';
            submitBtn.disabled = false;
            submitBtn.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
          } else {
            // ê·œê²©ì´ ë“±ë¡ë˜ì§€ ì•ŠìŒ
            hasInspectionSpecs = false;
            statusIndicator.style.backgroundColor = '#f8d7da';
            statusIndicator.style.borderColor = '#f5c6cb';
            statusIndicator.style.color = '#721c24';
            statusText.textContent = 'âš  ê²€ì‚¬ê·œê²©ë“±ë¡í›„ ì§„í–‰í•˜ì„¸ìš”';
            submitBtn.disabled = true;
            submitBtn.style.background = '#ccc';
          }
        })
        .withFailureHandler(function(error) {
          console.error('ê²€ì‚¬ê·œê²© ì¡°íšŒ ì‹¤íŒ¨:', error);
          hideSpecStatus();
        })
        .getInspectionSpecs(sessionToken, {tmNo: tmNo, companyName: companyName});
    }

    // ê²€ì‚¬ê·œê²© ìƒíƒœ ìˆ¨ê¹€
    function hideSpecStatus() {
      document.getElementById('specStatusGroup').style.display = 'none';
      hasInspectionSpecs = false;
      document.getElementById('btnSubmit').disabled = false;
      document.getElementById('btnSubmit').style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
    }

    // ë¡œê·¸ì•„ì›ƒ
    function logout() {
      if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
        const token = sessionStorage.getItem('sessionToken');
        google.script.run
          .withSuccessHandler(function() {
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
          })
          .withFailureHandler(function(error) {
            console.error('ë¡œê·¸ì•„ì›ƒ ì‹¤íŒ¨:', error);
            sessionStorage.removeItem('sessionToken');
            safeNavigate('https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec', null);
          })
          .logoutWithToken(token);
      }
    }

    function printCertificate() {
      window.print();
    }

  </script>
</body>
</html>
