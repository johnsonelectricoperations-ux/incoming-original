<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¡œê·¸ì¸ - ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 20px;
    }
    
    .login-container {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
      padding: 40px;
      width: 100%;
      max-width: 400px;
      animation: fadeIn 0.5s ease-in;
    }
    
    @keyframes fadeIn {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .login-header {
      text-align: center;
      margin-bottom: 30px;
    }

    .company-name {
      color: #ff6b35;
      font-family: Arial, sans-serif;
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 15px;
      letter-spacing: 0.5px;
    }

    .login-header h1 {
      color: #333;
      font-size: 28px;
      margin-bottom: 10px;
    }

    .login-header p {
      color: #666;
      font-size: 14px;
    }
    
    .form-group {
      margin-bottom: 20px;
    }
    
    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }
    
    .form-group input {
      width: 100%;
      padding: 12px 15px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.3s;
    }
    
    .form-group input:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .btn-login {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: transform 0.2s, box-shadow 0.2s;
    }
    
    .btn-login:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
    }
    
    .btn-login:active {
      transform: translateY(0);
    }
    
    .btn-login:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .alert {
      padding: 12px 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      font-size: 14px;
      display: none;
    }
    
    .alert-error {
      background-color: #fee;
      border: 1px solid #fcc;
      color: #c33;
    }
    
    .alert-success {
      background-color: #efe;
      border: 1px solid #cfc;
      color: #3c3;
    }
    
    .loading-spinner {
      display: none;
      text-align: center;
      margin-top: 10px;
    }
    
    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 30px;
      height: 30px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 480px) {
      .login-container {
        padding: 30px 20px;
      }
      
      .login-header h1 {
        font-size: 24px;
      }
    }

    .btn-register {
      width: 100%;
      padding: 14px;
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .btn-register:hover {
      background: #667eea;
      color: white;
    }

    .btn-register:active {
      transform: translateY(0);
    }

    .btn-back {
      width: 100%;
      padding: 14px;
      background: #f0f0f0;
      color: #666;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      margin-top: 10px;
    }

    .btn-back:hover {
      background: #e0e0e0;
    }

    .register-form {
      display: none;
    }

    .form-title {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
      margin-bottom: 20px;
      text-align: center;
    }

  </style>
</head>
<body>
  <div class="login-container">
    <div class="login-header">
      <div class="company-name">Johnson Electric Operations</div>
      <h1>ğŸ” ë¡œê·¸ì¸</h1>
      <p>ê²€ì‚¬ì„±ì ì„œ ê´€ë¦¬ ì‹œìŠ¤í…œ</p>
    </div>
    
    <div id="alertBox" class="alert"></div>
    
    <form id="loginForm" onsubmit="handleLogin(event)">
      <div class="form-group">
        <label for="userId">ì•„ì´ë””</label>
        <input type="text" id="userId" name="userId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>
      
      <div class="form-group">
        <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
        <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”" required>
      </div>
      
      <button type="submit" class="btn-login" id="btnLogin">ë¡œê·¸ì¸</button>
    </form>
    
    <div class="loading-spinner" id="loadingSpinner">
      <div class="spinner"></div>
      <p style="margin-top: 10px; color: #666;">ë¡œê·¸ì¸ ì¤‘...</p>
    </div>
  </div>

  <script>
    // ë¡œê·¸ì¸ ì²˜ë¦¬
    function handleLogin(event) {
      event.preventDefault();
      
      const userId = document.getElementById('userId').value.trim();
      const password = document.getElementById('password').value;
      
      if (!userId || !password) {
        showAlert('ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('btnLogin').disabled = true;
      document.getElementById('loadingSpinner').style.display = 'block';
      document.getElementById('loginForm').style.display = 'none';
      hideAlert();
      
      // ì„œë²„ í˜¸ì¶œ (í† í° ê¸°ë°˜ ë¡œê·¸ì¸)
      google.script.run
        .withSuccessHandler(onLoginSuccess)
        .withFailureHandler(onLoginFailure)
        .loginUserWithToken(userId, password);
    }

    // ë¡œê·¸ì¸ ì„±ê³µ
    function onLoginSuccess(response) {
      if (response.success) {
        // í† í°ì„ sessionStorageì— ì €ì¥
        if (response.token) {
          sessionStorage.setItem('sessionToken', response.token);
          console.log('ì„¸ì…˜ í† í° ì €ì¥ ì™„ë£Œ');
        }

        showAlert('ë¡œê·¸ì¸ ì„±ê³µ! í˜ì´ì§€ë¥¼ ì´ë™í•©ë‹ˆë‹¤...', 'success');

        // ì‚¬ìš©ì ì œìŠ¤ì²˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€í•˜ê¸° ìœ„í•´ ì¦‰ì‹œ í˜ì´ì§€ ì´ë™
        // google.script.run ë¹„ë™ê¸° ì½œë°±ì„ ì‚¬ìš©í•˜ë©´ ìƒŒë“œë°•ìŠ¤ ì—ëŸ¬ ë°œìƒ
        const token = sessionStorage.getItem('sessionToken');
        const webAppUrl = 'https://script.google.com/macros/s/AKfycbxpjukKc_G4SaPL52w47ANnQc8MvCmkP6IzUX8DaXBqqdz_L8Th3kLqv4_HdslfGnxIBw/exec';
        redirectToPage(webAppUrl, token);
      } else {
        showAlert(response.message, 'error');
        resetForm();
      }
    }

    // iframe ìƒŒë“œë°•ìŠ¤ì—ì„œ ì•ˆì „í•œ í˜ì´ì§€ ë¦¬ë””ë ‰ì…˜
    // ì—¬ëŸ¬ ë°©ë²•ì„ í´ë°±ìœ¼ë¡œ ì‹œë„í•˜ì—¬ ìƒŒë“œë°•ìŠ¤ ì œì•½ ìš°íšŒ
    function redirectToPage(baseUrl, token) {
      // URL íŒŒë¼ë¯¸í„° ìƒì„±
      const params = {
        'page': 'dashboard',
        'token': token,
        't': Date.now()
      };

      // Query string ìƒì„±
      const queryString = Object.keys(params)
        .map(key => encodeURIComponent(key) + '=' + encodeURIComponent(params[key]))
        .join('&');

      const fullUrl = baseUrl + '?' + queryString;

      // ë°©ë²• 1: window.top.location.href ì‹œë„ (ê°€ì¥ ì„ í˜¸)
      try {
        window.top.location.href = fullUrl;
        return;
      } catch (e) {
        console.warn('window.top.location.href ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 2: window.location.replace ì‹œë„
      try {
        window.location.replace(fullUrl);
        return;
      } catch (e) {
        console.warn('window.location.replace ì‹¤íŒ¨, ë‹¤ìŒ ë°©ë²• ì‹œë„:', e.message);
      }

      // ë°©ë²• 3: meta refresh íƒœê·¸ ì‚¬ìš© (ìµœí›„ì˜ ìˆ˜ë‹¨)
      try {
        const meta = document.createElement('meta');
        meta.httpEquiv = 'refresh';
        meta.content = '0; url=' + fullUrl;
        document.head.appendChild(meta);
        console.log('meta refresh íƒœê·¸ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸');
      } catch (e) {
        console.error('ëª¨ë“  ë¦¬ë‹¤ì´ë ‰íŠ¸ ë°©ë²• ì‹¤íŒ¨:', e.message);
        // ìµœí›„ì˜ ìˆ˜ë‹¨: ì‚¬ìš©ìì—ê²Œ ìˆ˜ë™ ë§í¬ ì œê³µ
        showManualRedirectLink(fullUrl);
      }
    }

    // ëª¨ë“  ìë™ ë¦¬ë‹¤ì´ë ‰íŠ¸ ì‹¤íŒ¨ ì‹œ ìˆ˜ë™ ë§í¬ ì œê³µ
    function showManualRedirectLink(url) {
      const alertBox = document.getElementById('alertBox');
      alertBox.innerHTML = 'ìë™ ì´ë™ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. <a href="' + url + '" target="_top" style="color: #667eea; font-weight: bold; text-decoration: underline;">ì—¬ê¸°ë¥¼ í´ë¦­</a>í•˜ì—¬ ê³„ì†í•˜ì„¸ìš”.';
      alertBox.className = 'alert alert-error';
      alertBox.style.display = 'block';
    }

    // íšŒì›ê°€ì… í¼ í‘œì‹œ
    function showRegisterForm() {
      document.getElementById('loginForm').style.display = 'none';
      document.querySelector('.login-header h1').textContent = 'ğŸ” íšŒì›ê°€ì…';
      
      const registerFormHtml = `
        <div class="register-form" id="registerForm">
          <div class="form-title">ì‹ ê·œ ì‚¬ìš©ì ë“±ë¡</div>
          
          <form id="registerFormElement" onsubmit="handleRegister(event)">
            <div class="form-group">
              <label for="regCompanyName">ì—…ì²´ëª…</label>
              <input type="text" id="regCompanyName" name="companyName" placeholder="ì—…ì²´ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            
            <div class="form-group">
              <label for="regName">ì„±ëª…</label>
              <input type="text" id="regName" name="name" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”" required>
            </div>
            
            <div class="form-group">
              <label for="regUserId">ì•„ì´ë””</label>
              <input type="text" id="regUserId" name="userId" placeholder="ì•„ì´ë””ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 4ì)" required minlength="4">
            </div>
            
            <div class="form-group">
              <label for="regPassword">ë¹„ë°€ë²ˆí˜¸</label>
              <input type="password" id="regPassword" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ìµœì†Œ 6ì)" required minlength="6">
            </div>
            
            <div class="form-group">
              <label for="regPasswordConfirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</label>
              <input type="password" id="regPasswordConfirm" name="passwordConfirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥í•˜ì„¸ìš”" required minlength="6">
            </div>
            
            <button type="submit" class="btn-login" id="btnRegister">ê°€ì…í•˜ê¸°</button>
            <button type="button" class="btn-back" onclick="showLoginForm()">ë¡œê·¸ì¸ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
          </form>
        </div>
      `;
      
      const alertBox = document.getElementById('alertBox');
      alertBox.insertAdjacentHTML('afterend', registerFormHtml);
      document.getElementById('registerForm').style.display = 'block';
      
      hideAlert();
    }

    // ë¡œê·¸ì¸ í¼ìœ¼ë¡œ ëŒì•„ê°€ê¸°
    function showLoginForm() {
      const registerForm = document.getElementById('registerForm');
      if (registerForm) {
        registerForm.remove();
      }

      document.getElementById('loginForm').style.display = 'block';
      document.querySelector('.login-header h1').textContent = 'ğŸ” ë¡œê·¸ì¸';

      hideAlert();
    }

    // íšŒì›ê°€ì… ì²˜ë¦¬
    function handleRegister(event) {
      event.preventDefault();
      
      const companyName = document.getElementById('regCompanyName').value.trim();
      const name = document.getElementById('regName').value.trim();
      const userId = document.getElementById('regUserId').value.trim();
      const password = document.getElementById('regPassword').value;
      const passwordConfirm = document.getElementById('regPasswordConfirm').value;
      
      // ë¹„ë°€ë²ˆí˜¸ í™•ì¸
      if (password !== passwordConfirm) {
        showAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.', 'error');
        return;
      }
      
      // UI ì—…ë°ì´íŠ¸
      document.getElementById('btnRegister').disabled = true;
      document.getElementById('btnRegister').textContent = 'ê°€ì… ì²˜ë¦¬ ì¤‘...';
      
      // ì„œë²„ í˜¸ì¶œ
      const userData = {
        companyName: companyName,
        name: name,
        userId: userId,
        password: password
      };
      
      google.script.run
        .withSuccessHandler(onRegisterSuccess)
        .withFailureHandler(onRegisterFailure)
        .registerUser(userData);
    }

    // íšŒì›ê°€ì… ì„±ê³µ
    function onRegisterSuccess(response) {
      if (response.success) {
        showAlert(response.message, 'success');
        
        // 2ì´ˆ í›„ ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
        setTimeout(function() {
          showLoginForm();
        }, 2000);
      } else {
        showAlert(response.message, 'error');
        document.getElementById('btnRegister').disabled = false;
        document.getElementById('btnRegister').textContent = 'ê°€ì…í•˜ê¸°';
      }
    }

    // íšŒì›ê°€ì… ì‹¤íŒ¨
    function onRegisterFailure(error) {
      console.error('Register error:', error);
      showAlert('íšŒì›ê°€ì… ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      document.getElementById('btnRegister').disabled = false;
      document.getElementById('btnRegister').textContent = 'ê°€ì…í•˜ê¸°';
    }  
        
   
    // ë¡œê·¸ì¸ ì‹¤íŒ¨
    function onLoginFailure(error) {
      console.error('Login error:', error);
      showAlert('ë¡œê·¸ì¸ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
      resetForm();
    }
    
    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(message, type) {
      const alertBox = document.getElementById('alertBox');
      alertBox.textContent = message;
      alertBox.className = 'alert alert-' + type;
      alertBox.style.display = 'block';
    }
    
    // ì•Œë¦¼ ìˆ¨ê¹€
    function hideAlert() {
      document.getElementById('alertBox').style.display = 'none';
    }
    
    // í¼ ë¦¬ì…‹
    function resetForm() {
      document.getElementById('btnLogin').disabled = false;
      document.getElementById('loadingSpinner').style.display = 'none';
      document.getElementById('loginForm').style.display = 'block';
    }
    
    // ì—”í„°í‚¤ ì²˜ë¦¬
    document.addEventListener('DOMContentLoaded', function() {
      document.getElementById('userId').focus();
    });
  </script>
</body>
</html>
