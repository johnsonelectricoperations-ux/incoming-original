<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ì‚¬ìš©ì ê´€ë¦¬</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f5f5f5;
      padding: 20px;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
    }

    .header {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      margin-bottom: 20px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 15px;
      flex: 1;
    }

    .btn-home {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      width: 45px;
      height: 45px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 20px;
      transition: all 0.3s;
      flex-shrink: 0;
    }

    .btn-home:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .header-title {
      flex: 1;
    }

    .header-title h1 {
      color: #333;
      font-size: 24px;
      margin-bottom: 10px;
    }

    .header-actions {
      display: flex;
      gap: 10px;
      margin-top: 15px;
      flex-wrap: wrap;
    }

    .search-box {
      flex: 1;
      min-width: 200px;
    }

    .search-box input {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-primary {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
    }

    .btn-search {
      background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
      color: white;
      font-size: 18px;
      padding: 10px 16px;
      min-width: 50px;
    }

    .btn-search:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #667eea;
      border: 2px solid #667eea;
    }

    .btn-secondary:hover {
      background: #667eea;
      color: white;
    }

    .btn-danger {
      background: #f44336;
      color: white;
    }

    .btn-danger:hover {
      background: #d32f2f;
    }

    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }

    .companies-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .company-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      padding: 20px;
      transition: all 0.2s;
      position: relative;
    }

    .company-card:hover {
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      transform: translateY(-2px);
    }

    .company-card-header {
      cursor: pointer;
    }

    .company-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #f0f0f0;
    }

    .btn-edit-company {
      flex: 1;
      padding: 8px 16px;
      background: #667eea;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .btn-edit-company:hover {
      background: #5568d3;
    }

    .company-card h3 {
      color: #333;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .company-code {
      color: #666;
      font-size: 12px;
      margin-bottom: 15px;
    }

    .company-stats {
      display: flex;
      gap: 15px;
      margin-top: 15px;
    }

    .stat-item {
      flex: 1;
      text-align: center;
      padding: 10px;
      background: #f5f5f5;
      border-radius: 6px;
    }

    .stat-number {
      font-size: 20px;
      font-weight: bold;
      color: #667eea;
    }

    .stat-label {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    .modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      z-index: 1000;
      overflow-y: auto;
    }

    .modal.active {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }

    .modal-content {
      background: white;
      border-radius: 12px;
      padding: 30px;
      max-width: 600px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .modal-content.large {
      max-width: 1000px;
    }

    .modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 2px solid #f0f0f0;
    }

    .modal-header h2 {
      color: #333;
      font-size: 20px;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 24px;
      cursor: pointer;
      color: #666;
      padding: 0;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .close-btn:hover {
      color: #333;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      color: #333;
      font-weight: 600;
      margin-bottom: 8px;
      font-size: 14px;
    }

    .form-group input,
    .form-group select {
      width: 100%;
      padding: 10px;
      border: 2px solid #e0e0e0;
      border-radius: 6px;
      font-size: 14px;
    }

    .form-group input:focus,
    .form-group select:focus {
      outline: none;
      border-color: #667eea;
    }

    .form-actions {
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      margin-top: 20px;
    }

    .users-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    .users-table th,
    .users-table td {
      padding: 12px;
      text-align: left;
      border-bottom: 1px solid #e0e0e0;
    }

    .users-table th {
      background: #f5f5f5;
      font-weight: 600;
      color: #333;
    }

    .users-table tr:hover {
      background: #f9f9f9;
    }

    .action-buttons {
      display: flex;
      gap: 5px;
    }

    .btn-small {
      padding: 5px 10px;
      font-size: 12px;
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 12px;
      font-weight: 600;
    }

    .badge-active {
      background: #e8f5e9;
      color: #2e7d32;
    }

    .badge-inactive {
      background: #ffebee;
      color: #c62828;
    }

    .badge-admin {
      background: #e3f2fd;
      color: #1565c0;
    }

    .badge-jeo {
      background: #fff3e0;
      color: #e65100;
    }

    .badge-user {
      background: #f3e5f5;
      color: #6a1b9a;
    }

    .alert {
      padding: 12px 15px;
      border-radius: 6px;
      margin-bottom: 20px;
      font-size: 14px;
    }

    .alert-error {
      background-color: #ffebee;
      border: 1px solid #ffcdd2;
      color: #c62828;
    }

    .alert-success {
      background-color: #e8f5e9;
      border: 1px solid #c8e6c9;
      color: #2e7d32;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: #666;
    }

    .spinner {
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 15px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #666;
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 15px;
      opacity: 0.5;
    }

    .company-detail-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .detail-stat-card {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 20px;
      border-radius: 8px;
      text-align: center;
    }

    .detail-stat-number {
      font-size: 28px;
      font-weight: bold;
      margin-bottom: 5px;
    }

    .detail-stat-label {
      font-size: 12px;
      opacity: 0.9;
    }

    .password-hint {
      font-size: 12px;
      color: #666;
      margin-top: 5px;
    }

    @media (max-width: 768px) {
      .companies-grid {
        grid-template-columns: 1fr;
      }

      .header {
        flex-direction: column;
        gap: 15px;
      }

      .header-left {
        width: 100%;
      }

      .header-actions {
        flex-direction: column;
      }

      .search-box {
        width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-left">
        <button class="btn-home" onclick="goToDashboard()" title="ëŒ€ì‹œë³´ë“œë¡œ ì´ë™">ğŸ </button>
        <div class="header-title">
          <h1>ì—…ì²´ ë° ì‚¬ìš©ì ê´€ë¦¬</h1>
        </div>
      </div>
      <div style="flex: 1;">
        <div class="header-actions">
          <div class="search-box">
            <input type="text" id="searchInput" placeholder="ì—…ì²´ëª… ë˜ëŠ” ì—…ì²´ì½”ë“œë¡œ ê²€ìƒ‰..." onkeyup="handleSearch()">
          </div>
          <button class="btn btn-search" onclick="handleSearch()" title="ê²€ìƒ‰">ğŸ”</button>
          <button class="btn btn-primary" onclick="showAddCompanyModal()">ì‹ ê·œ ì—…ì²´ ë“±ë¡</button>
        </div>
      </div>
    </div>

    <div id="loadingIndicator" class="loading" style="display: none;">
      <div class="spinner"></div>
      <p>ë¡œë”© ì¤‘...</p>
    </div>

    <div id="companiesContainer" class="companies-grid"></div>
  </div>

  <!-- ì—…ì²´ ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editCompanyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ì—…ì²´ ì •ë³´ ìˆ˜ì •</h2>
        <button class="close-btn" onclick="closeEditCompanyModal()">&times;</button>
      </div>

      <div id="editCompanyAlert"></div>

      <form id="editCompanyForm" onsubmit="handleEditCompany(event)">
        <input type="hidden" id="editCompanyCode">

        <div class="form-group">
          <label for="editCompanyName">ì—…ì²´ëª… *</label>
          <input type="text" id="editCompanyName" required>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditCompanyModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" id="btnEditCompany">ìˆ˜ì •</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì‹ ê·œ ì—…ì²´ ë“±ë¡ ëª¨ë‹¬ -->
  <div id="addCompanyModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ì‹ ê·œ ì—…ì²´ ë“±ë¡</h2>
        <button class="close-btn" onclick="closeAddCompanyModal()">&times;</button>
      </div>

      <div id="addCompanyAlert"></div>

      <form id="addCompanyForm" onsubmit="handleAddCompany(event)">
        <div class="form-group">
          <label for="newCompanyName">ì—…ì²´ëª… *</label>
          <input type="text" id="newCompanyName" required>
        </div>

        <div class="form-group">
          <label for="newUserName">ê´€ë¦¬ì ì„±ëª… *</label>
          <input type="text" id="newUserName" required>
        </div>

        <div class="form-group">
          <label for="newUserId">ê´€ë¦¬ì ID *</label>
          <input type="text" id="newUserId" required minlength="4" pattern="[a-zA-Z0-9]+">
          <div class="password-hint">ì˜ë¬¸ê³¼ ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥ (ìµœì†Œ 4ì)</div>
        </div>

        <div class="form-group">
          <label for="newUserPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="newUserPassword" required minlength="6">
          <div class="password-hint">ìµœì†Œ 6ì ì´ìƒ</div>
        </div>

        <div class="form-group">
          <label for="newUserRole">ê¶Œí•œ *</label>
          <select id="newUserRole" required>
            <option value="ì¼ë°˜">ì¼ë°˜</option>
            <option value="JEO">JEO</option>
            <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddCompanyModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" id="btnAddCompany">ë“±ë¡</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì—…ì²´ ìƒì„¸ ëª¨ë‹¬ -->
  <div id="companyDetailModal" class="modal">
    <div class="modal-content large">
      <div class="modal-header">
        <h2 id="detailCompanyName"></h2>
        <button class="close-btn" onclick="closeCompanyDetailModal()">&times;</button>
      </div>

      <div id="companyDetailAlert"></div>

      <div id="companyDetailStats" class="company-detail-stats"></div>

      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
        <h3>ì‚¬ìš©ì ëª©ë¡</h3>
        <button class="btn btn-primary btn-small" onclick="showAddUserModal()">ì‚¬ìš©ì ì¶”ê°€</button>
      </div>

      <table class="users-table">
        <thead>
          <tr>
            <th>ì„±ëª…</th>
            <th>ID</th>
            <th>ê¶Œí•œ</th>
            <th>ìƒíƒœ</th>
            <th>ìƒì„±ì¼</th>
            <th>ì‘ì—…</th>
          </tr>
        </thead>
        <tbody id="usersTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ì¶”ê°€ ëª¨ë‹¬ -->
  <div id="addUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ì‚¬ìš©ì ì¶”ê°€</h2>
        <button class="close-btn" onclick="closeAddUserModal()">&times;</button>
      </div>

      <div id="addUserAlert"></div>

      <form id="addUserForm" onsubmit="handleAddUser(event)">
        <div class="form-group">
          <label for="addUserName">ì„±ëª… *</label>
          <input type="text" id="addUserName" required>
        </div>

        <div class="form-group">
          <label for="addUserId">ID *</label>
          <input type="text" id="addUserId" required minlength="4" pattern="[a-zA-Z0-9]+">
          <div class="password-hint">ì˜ë¬¸ê³¼ ìˆ«ìë§Œ ì‚¬ìš© ê°€ëŠ¥ (ìµœì†Œ 4ì)</div>
        </div>

        <div class="form-group">
          <label for="addUserPassword">ë¹„ë°€ë²ˆí˜¸ *</label>
          <input type="password" id="addUserPassword" required minlength="6">
          <div class="password-hint">ìµœì†Œ 6ì ì´ìƒ</div>
        </div>

        <div class="form-group">
          <label for="addUserRole">ê¶Œí•œ *</label>
          <select id="addUserRole" required>
            <option value="ì¼ë°˜">ì¼ë°˜</option>
            <option value="JEO">JEO</option>
            <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeAddUserModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" id="btnAddUser">ì¶”ê°€</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ì‚¬ìš©ì ìˆ˜ì • ëª¨ë‹¬ -->
  <div id="editUserModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>ì‚¬ìš©ì ì •ë³´ ìˆ˜ì •</h2>
        <button class="close-btn" onclick="closeEditUserModal()">&times;</button>
      </div>

      <div id="editUserAlert"></div>

      <form id="editUserForm" onsubmit="handleEditUser(event)">
        <input type="hidden" id="editUserRowIndex">

        <div class="form-group">
          <label for="editUserName">ì„±ëª… *</label>
          <input type="text" id="editUserName" required>
        </div>

        <div class="form-group">
          <label for="editUserPassword">ë¹„ë°€ë²ˆí˜¸</label>
          <input type="password" id="editUserPassword" minlength="6">
          <div class="password-hint">ë³€ê²½í•˜ì§€ ì•Šìœ¼ë ¤ë©´ ë¹„ì›Œë‘ì„¸ìš” (ë³€ê²½ ì‹œ ìµœì†Œ 6ì)</div>
        </div>

        <div class="form-group">
          <label for="editUserRole">ê¶Œí•œ *</label>
          <select id="editUserRole" required>
            <option value="ì¼ë°˜">ì¼ë°˜</option>
            <option value="JEO">JEO</option>
            <option value="ê´€ë¦¬ì">ê´€ë¦¬ì</option>
          </select>
        </div>

        <div class="form-group">
          <label for="editUserStatus">ìƒíƒœ *</label>
          <select id="editUserStatus" required>
            <option value="í™œì„±">í™œì„±</option>
            <option value="ë¹„í™œì„±">ë¹„í™œì„±</option>
          </select>
        </div>

        <div class="form-actions">
          <button type="button" class="btn btn-secondary" onclick="closeEditUserModal()">ì·¨ì†Œ</button>
          <button type="submit" class="btn btn-primary" id="btnEditUser">ìˆ˜ì •</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentToken = null;
    let currentCompanyCode = '';
    let allCompanies = [];

    // HTML/JavaScript ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
    function escapeHtml(text) {
      if (!text) return '';
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    function escapeJs(text) {
      if (!text) return '';
      return String(text).replace(/'/g, "\\'").replace(/"/g, '\\"').replace(/\n/g, '\\n').replace(/\r/g, '\\r');
    }

    // í† í° ì´ˆê¸°í™” (ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° ë˜ëŠ” sessionStorageì—ì„œ)
    function initToken() {
      // ì„œë²„ì—ì„œ ì „ë‹¬ë°›ì€ í† í° (í…œí”Œë¦¿ ë³€ìˆ˜)
      const serverToken = '<?!= token ?>';

      if (serverToken && serverToken !== 'undefined' && serverToken.length > 10) {
        currentToken = serverToken;
        sessionStorage.setItem('sessionToken', serverToken);
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (ì„œë²„ì—ì„œ ì „ë‹¬)');
      } else {
        // sessionStorageì—ì„œ í† í° ê°€ì ¸ì˜¤ê¸°
        currentToken = sessionStorage.getItem('sessionToken');
        console.log('í† í° ì´ˆê¸°í™” ì™„ë£Œ (sessionStorage)');
      }

      if (!currentToken) {
        console.error('í† í° ì—†ìŒ - ë¡œê·¸ì¸ í•„ìš”');
        return false;
      }

      return true;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
    window.onload = function() {
      if (!initToken()) {
        alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
        window.location.href = '<?= getWebAppUrl() ?>?page=login';
        return;
      }

      showInitialMessage();
    };

    // ì—…ì²´ ëª©ë¡ ë¡œë“œ
    function loadCompanies() {
      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);

          if (!response) {
            showError('ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
          }

          if (response.success) {
            allCompanies = response.data;
            renderCompanies(allCompanies);
          } else {
            showError(response.message);
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showError('ì—…ì²´ ëª©ë¡ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        })
        .getCompanies(currentToken);
    }

    // ì´ˆê¸° ì•ˆë‚´ ë©”ì‹œì§€ í‘œì‹œ
    function showInitialMessage() {
      const container = document.getElementById('companiesContainer');
      container.innerHTML = `
        <div class="empty-state">
          <div class="empty-state-icon">ğŸ”</div>
          <p style="font-size: 16px; font-weight: 600; margin-bottom: 10px;">ê²€ìƒ‰ ì¡°ê±´ì„ ì…ë ¥í•˜ê±°ë‚˜ ì‹ ê·œ ì—…ì²´ë¥¼ ë“±ë¡í•˜ì„¸ìš”.</p>
          <p style="font-size: 14px;">ì—…ì²´ëª… ë˜ëŠ” ì—…ì²´ì½”ë“œë¡œ ê²€ìƒ‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
        </div>
      `;
    }

    // ì—…ì²´ ëª©ë¡ ë Œë”ë§
    function renderCompanies(companies) {
      const container = document.getElementById('companiesContainer');

      if (!companies || companies.length === 0) {
        container.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ“¦</div>
            <p>ë“±ë¡ëœ ì—…ì²´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
          </div>
        `;
        return;
      }

      container.innerHTML = companies.map(company => {
        const safeCompanyCode = escapeJs(company.companyCode);
        const safeCompanyName = escapeJs(company.companyName);
        const displayCompanyName = escapeHtml(company.companyName);
        const displayCompanyCode = escapeHtml(company.companyCode);

        return `
          <div class="company-card">
            <div class="company-card-header" onclick="showCompanyDetail('${safeCompanyCode}')">
              <h3>${displayCompanyName}</h3>
              <div class="company-code">ì—…ì²´ì½”ë“œ: ${displayCompanyCode}</div>
              <div class="company-stats">
                <div class="stat-item">
                  <div class="stat-number">${company.totalUsers}</div>
                  <div class="stat-label">ì „ì²´ ì‚¬ìš©ì</div>
                </div>
                <div class="stat-item">
                  <div class="stat-number">${company.activeUsers}</div>
                  <div class="stat-label">í™œì„± ì‚¬ìš©ì</div>
                </div>
              </div>
            </div>
            <div class="company-card-actions">
              <button class="btn-edit-company" onclick="event.stopPropagation(); showEditCompanyModal('${safeCompanyCode}', '${safeCompanyName}')">âœï¸ ì—…ì²´ëª… ìˆ˜ì •</button>
            </div>
          </div>
        `;
      }).join('');
    }

    // ê²€ìƒ‰ ì²˜ë¦¬
    function handleSearch() {
      // ë°ì´í„°ê°€ ì•„ì§ ë¡œë“œë˜ì§€ ì•Šì•˜ìœ¼ë©´ ë¡œë“œ
      if (!allCompanies || allCompanies.length === 0) {
        loadCompanies();
        return;
      }

      const searchText = document.getElementById('searchInput').value.trim();

      if (!searchText) {
        renderCompanies(allCompanies);
        return;
      }

      const filtered = allCompanies.filter(company => {
        return company.companyName.toLowerCase().includes(searchText.toLowerCase()) ||
               company.companyCode.toLowerCase().includes(searchText.toLowerCase());
      });

      renderCompanies(filtered);
    }

    // ì—…ì²´ ìƒì„¸ ë³´ê¸°
    function showCompanyDetail(companyCode) {
      console.log('showCompanyDetail í˜¸ì¶œ - companyCode:', companyCode);
      console.log('currentToken:', currentToken ? 'ìˆìŒ' : 'ì—†ìŒ');

      currentCompanyCode = companyCode;
      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);
          console.log('getCompanyDetails ì‘ë‹µ:', response);

          if (!response) {
            console.error('ì‘ë‹µì´ nullì…ë‹ˆë‹¤');
            showError('ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.');
            return;
          }

          if (response.success) {
            console.log('ì—…ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì„±ê³µ');
            renderCompanyDetail(response.data);
            document.getElementById('companyDetailModal').classList.add('active');
          } else {
            console.error('ì—…ì²´ ìƒì„¸ ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', response.message);
            showError(response.message || 'ì—…ì²´ ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          console.error('getCompanyDetails ì‹¤íŒ¨:', error);
          showError('ì—…ì²´ ì •ë³´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
        })
        .getCompanyDetails(currentToken, companyCode);
    }

    // ì—…ì²´ ìƒì„¸ ì •ë³´ ë Œë”ë§
    function renderCompanyDetail(data) {
      document.getElementById('detailCompanyName').textContent =
        data.companyName + ' (' + data.companyCode + ')';

      // í†µê³„ í‘œì‹œ
      const statsHtml = `
        <div class="detail-stat-card">
          <div class="detail-stat-number">${data.stats.dataCount}</div>
          <div class="detail-stat-label">ì„±ì ì„œ</div>
        </div>
        <div class="detail-stat-card">
          <div class="detail-stat-number">${data.stats.itemCount}</div>
          <div class="detail-stat-label">ë“±ë¡ í’ˆëª©</div>
        </div>
        <div class="detail-stat-card">
          <div class="detail-stat-number">${data.stats.specCount}</div>
          <div class="detail-stat-label">ê²€ì‚¬ ê·œê²©</div>
        </div>
        <div class="detail-stat-card">
          <div class="detail-stat-number">${data.stats.resultCount}</div>
          <div class="detail-stat-label">ê²€ì‚¬ ê²°ê³¼</div>
        </div>
      `;
      document.getElementById('companyDetailStats').innerHTML = statsHtml;

      // ì‚¬ìš©ì ëª©ë¡ í‘œì‹œ
      const tbody = document.getElementById('usersTableBody');
      tbody.innerHTML = data.users.map(user => {
        const roleClass = user.role === 'ê´€ë¦¬ì' ? 'badge-admin' :
                         user.role === 'JEO' ? 'badge-jeo' : 'badge-user';
        const statusClass = user.status === 'í™œì„±' ? 'badge-active' : 'badge-inactive';

        // createdAt ì²˜ë¦¬ - ì´ë¯¸ ë¬¸ìì—´ë¡œ í¬ë§·ëœ ìƒíƒœ
        let createdDate = '-';
        if (user.createdAt) {
          try {
            // ì„œë²„ì—ì„œ ì´ë¯¸ í¬ë§·ëœ ë¬¸ìì—´ë¡œ ë°›ìŒ
            createdDate = user.createdAt;
          } catch (e) {
            console.error('ë‚ ì§œ íŒŒì‹± ì˜¤ë¥˜:', e);
            createdDate = '-';
          }
        }

        // JavaScript ì´ìŠ¤ì¼€ì´í”„ (onclick ì†ì„±ìš©)
        const safeName = escapeJs(user.name);
        const safeUserId = escapeJs(user.userId);
        const safeRole = escapeJs(user.role);
        const safeStatus = escapeJs(user.status);

        // HTML ì´ìŠ¤ì¼€ì´í”„ (í‘œì‹œìš©)
        const displayName = escapeHtml(user.name);
        const displayUserId = escapeHtml(user.userId);
        const displayRole = escapeHtml(user.role);
        const displayStatus = escapeHtml(user.status);

        return `
          <tr>
            <td>${displayName}</td>
            <td>${displayUserId}</td>
            <td><span class="badge ${roleClass}">${displayRole}</span></td>
            <td><span class="badge ${statusClass}">${displayStatus}</span></td>
            <td>${createdDate}</td>
            <td>
              <div class="action-buttons">
                <button class="btn btn-secondary btn-small" onclick="showEditUserModal(${user.rowIndex}, '${safeName}', '${safeRole}', '${safeStatus}')">ìˆ˜ì •</button>
                <button class="btn btn-danger btn-small" onclick="confirmDeleteUser(${user.rowIndex}, '${safeUserId}')">ì‚­ì œ</button>
              </div>
            </td>
          </tr>
        `;
      }).join('');
    }

    // ì—…ì²´ ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
    function showEditCompanyModal(companyCode, companyName) {
      document.getElementById('editCompanyCode').value = companyCode;
      document.getElementById('editCompanyName').value = companyName;
      document.getElementById('editCompanyAlert').innerHTML = '';
      document.getElementById('editCompanyModal').classList.add('active');
    }

    function closeEditCompanyModal() {
      document.getElementById('editCompanyModal').classList.remove('active');
    }

    // ì—…ì²´ ì •ë³´ ìˆ˜ì • ì²˜ë¦¬
    function handleEditCompany(event) {
      event.preventDefault();

      const companyCode = document.getElementById('editCompanyCode').value.trim();
      const newCompanyName = document.getElementById('editCompanyName').value.trim();

      if (!newCompanyName) {
        showAlert('editCompanyAlert', 'ì—…ì²´ëª…ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
        return;
      }

      document.getElementById('btnEditCompany').disabled = true;
      document.getElementById('btnEditCompany').textContent = 'ì²˜ë¦¬ ì¤‘...';

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('btnEditCompany').disabled = false;
          document.getElementById('btnEditCompany').textContent = 'ìˆ˜ì •';

          if (!response) {
            showAlert('editCompanyAlert', 'ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          if (response.success) {
            showAlert('editCompanyAlert', response.message, 'success');
            setTimeout(function() {
              closeEditCompanyModal();
              loadCompanies();
            }, 1500);
          } else {
            showAlert('editCompanyAlert', response.message || 'ì—…ì²´ ìˆ˜ì • ì‹¤íŒ¨', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('btnEditCompany').disabled = false;
          document.getElementById('btnEditCompany').textContent = 'ìˆ˜ì •';
          showAlert('editCompanyAlert', 'ì—…ì²´ ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .updateCompanyName(currentToken, companyCode, newCompanyName);
    }

    // ì‹ ê·œ ì—…ì²´ ë“±ë¡ ëª¨ë‹¬ í‘œì‹œ
    function showAddCompanyModal() {
      document.getElementById('addCompanyForm').reset();
      document.getElementById('addCompanyAlert').innerHTML = '';
      document.getElementById('addCompanyModal').classList.add('active');
    }

    function closeAddCompanyModal() {
      document.getElementById('addCompanyModal').classList.remove('active');
    }

    // ì‹ ê·œ ì—…ì²´ ë“±ë¡ ì²˜ë¦¬
    function handleAddCompany(event) {
      event.preventDefault();

      const companyData = {
        companyName: document.getElementById('newCompanyName').value.trim(),
        userName: document.getElementById('newUserName').value.trim(),
        userId: document.getElementById('newUserId').value.trim(),
        password: document.getElementById('newUserPassword').value.trim(),
        role: document.getElementById('newUserRole').value
      };

      document.getElementById('btnAddCompany').disabled = true;
      document.getElementById('btnAddCompany').textContent = 'ì²˜ë¦¬ ì¤‘...';

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('btnAddCompany').disabled = false;
          document.getElementById('btnAddCompany').textContent = 'ë“±ë¡';

          if (!response) {
            showAlert('addCompanyAlert', 'ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          if (response.success) {
            showAlert('addCompanyAlert', response.message, 'success');
            setTimeout(function() {
              closeAddCompanyModal();
              loadCompanies();
            }, 1500);
          } else {
            showAlert('addCompanyAlert', response.message || 'ì—…ì²´ ë“±ë¡ ì‹¤íŒ¨', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('btnAddCompany').disabled = false;
          document.getElementById('btnAddCompany').textContent = 'ë“±ë¡';
          showAlert('addCompanyAlert', 'ì—…ì²´ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .addCompany(currentToken, companyData);
    }

    // ì‚¬ìš©ì ì¶”ê°€ ëª¨ë‹¬ í‘œì‹œ
    function showAddUserModal() {
      document.getElementById('addUserForm').reset();
      document.getElementById('addUserAlert').innerHTML = '';
      document.getElementById('addUserModal').classList.add('active');
    }

    function closeAddUserModal() {
      document.getElementById('addUserModal').classList.remove('active');
    }

    // ì‚¬ìš©ì ì¶”ê°€ ì²˜ë¦¬
    function handleAddUser(event) {
      event.preventDefault();

      const userData = {
        companyCode: currentCompanyCode,
        userName: document.getElementById('addUserName').value.trim(),
        userId: document.getElementById('addUserId').value.trim(),
        password: document.getElementById('addUserPassword').value.trim(),
        role: document.getElementById('addUserRole').value
      };

      document.getElementById('btnAddUser').disabled = true;
      document.getElementById('btnAddUser').textContent = 'ì²˜ë¦¬ ì¤‘...';

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('btnAddUser').disabled = false;
          document.getElementById('btnAddUser').textContent = 'ì¶”ê°€';

          if (!response) {
            showAlert('addUserAlert', 'ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          if (response.success) {
            showAlert('addUserAlert', response.message, 'success');
            setTimeout(function() {
              closeAddUserModal();
              showCompanyDetail(currentCompanyCode);
            }, 1500);
          } else {
            showAlert('addUserAlert', response.message || 'ì‚¬ìš©ì ì¶”ê°€ ì‹¤íŒ¨', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('btnAddUser').disabled = false;
          document.getElementById('btnAddUser').textContent = 'ì¶”ê°€';
          showAlert('addUserAlert', 'ì‚¬ìš©ì ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .addUserToCompany(currentToken, userData);
    }

    // ì‚¬ìš©ì ìˆ˜ì • ëª¨ë‹¬ í‘œì‹œ
    function showEditUserModal(rowIndex, name, role, status) {
      document.getElementById('editUserRowIndex').value = rowIndex;
      document.getElementById('editUserName').value = name;
      document.getElementById('editUserPassword').value = '';
      document.getElementById('editUserRole').value = role;
      document.getElementById('editUserStatus').value = status;
      document.getElementById('editUserAlert').innerHTML = '';
      document.getElementById('editUserModal').classList.add('active');
    }

    function closeEditUserModal() {
      document.getElementById('editUserModal').classList.remove('active');
    }

    // ì‚¬ìš©ì ìˆ˜ì • ì²˜ë¦¬
    function handleEditUser(event) {
      event.preventDefault();

      const rowIndex = parseInt(document.getElementById('editUserRowIndex').value);
      const password = document.getElementById('editUserPassword').value.trim();

      const userData = {
        name: document.getElementById('editUserName').value.trim(),
        password: password || null,
        role: document.getElementById('editUserRole').value,
        status: document.getElementById('editUserStatus').value
      };

      document.getElementById('btnEditUser').disabled = true;
      document.getElementById('btnEditUser').textContent = 'ì²˜ë¦¬ ì¤‘...';

      google.script.run
        .withSuccessHandler(function(response) {
          document.getElementById('btnEditUser').disabled = false;
          document.getElementById('btnEditUser').textContent = 'ìˆ˜ì •';

          if (!response) {
            showAlert('editUserAlert', 'ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          if (response.success) {
            showAlert('editUserAlert', response.message, 'success');
            setTimeout(function() {
              closeEditUserModal();
              showCompanyDetail(currentCompanyCode);
            }, 1500);
          } else {
            showAlert('editUserAlert', response.message || 'ì‚¬ìš©ì ìˆ˜ì • ì‹¤íŒ¨', 'error');
          }
        })
        .withFailureHandler(function(error) {
          document.getElementById('btnEditUser').disabled = false;
          document.getElementById('btnEditUser').textContent = 'ìˆ˜ì •';
          showAlert('editUserAlert', 'ì‚¬ìš©ì ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .updateUserInfo(currentToken, rowIndex, userData);
    }

    // ì‚¬ìš©ì ì‚­ì œ í™•ì¸
    function confirmDeleteUser(rowIndex, userId) {
      if (confirm(`ì‚¬ìš©ì '${userId}'ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        deleteUser(rowIndex);
      }
    }

    // ì‚¬ìš©ì ì‚­ì œ ì²˜ë¦¬
    function deleteUser(rowIndex) {
      showLoading(true);

      google.script.run
        .withSuccessHandler(function(response) {
          showLoading(false);

          if (!response) {
            showAlert('companyDetailAlert', 'ì„œë²„ë¡œë¶€í„° ì‘ë‹µì„ ë°›ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.', 'error');
            return;
          }

          if (response.success) {
            showAlert('companyDetailAlert', response.message, 'success');
            setTimeout(function() {
              showCompanyDetail(currentCompanyCode);
            }, 1500);
          } else {
            showAlert('companyDetailAlert', response.message || 'ì‚¬ìš©ì ì‚­ì œ ì‹¤íŒ¨', 'error');
          }
        })
        .withFailureHandler(function(error) {
          showLoading(false);
          showAlert('companyDetailAlert', 'ì‚¬ìš©ì ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
        })
        .deleteUser(currentToken, rowIndex);
    }

    function closeCompanyDetailModal() {
      document.getElementById('companyDetailModal').classList.remove('active');
      currentCompanyCode = '';
      loadCompanies(); // ëª©ë¡ ìƒˆë¡œê³ ì¹¨
    }

    // ë¡œë”© í‘œì‹œ
    function showLoading(show) {
      document.getElementById('loadingIndicator').style.display = show ? 'block' : 'none';
    }

    // ì•Œë¦¼ í‘œì‹œ
    function showAlert(elementId, message, type) {
      const alertBox = document.getElementById(elementId);
      alertBox.className = 'alert alert-' + type;
      alertBox.textContent = message;
      alertBox.style.display = 'block';

      setTimeout(function() {
        alertBox.style.display = 'none';
      }, 5000);
    }

    // ì—ëŸ¬ í‘œì‹œ
    function showError(message) {
      alert(message);
    }

    // ëŒ€ì‹œë³´ë“œë¡œ ì´ë™
    function goToDashboard() {
      const webAppUrl = '<?= getWebAppUrl() ?>';
      const token = sessionStorage.getItem('sessionToken') || currentToken;
      window.location.href = webAppUrl + '?page=dashboard&token=' + encodeURIComponent(token) + '&t=' + Date.now();
    }
  </script>
</body>
</html>
